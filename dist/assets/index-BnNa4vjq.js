(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const l of s)if(l.type==="childList")for(const a of l.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const l={};return s.integrity&&(l.integrity=s.integrity),s.referrerPolicy&&(l.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?l.credentials="include":s.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(s){if(s.ep)return;s.ep=!0;const l=t(s);fetch(s.href,l)}})();const r=800,f=500,c={MENU:"menu",PLAYING:"playing",SHOP:"shop",LEVEL_COMPLETE:"level_complete",GAME_OVER:"game_over",VICTORY:"victory"},m={BASIC:{name:"Basic",color:"#95a5a6",multiplier:1},IRON:{name:"Iron",color:"#7f8c8d",multiplier:1.25},STEEL:{name:"Steel",color:"#bdc3c7",multiplier:1.5},GOLD:{name:"Gold",color:"#f1c40f",multiplier:1.75},DIAMOND:{name:"Diamond",color:"#3498db",multiplier:2},LEGENDARY:{name:"Legendary",color:"#9b59b6",multiplier:2.5}},n={SLIME:"slime",GOBLIN:"goblin",SKELETON:"skeleton",ORC:"orc",DRAGON:"dragon",BOSS_DRAGON:"boss_dragon"};class V{constructor(){this.keys={},this.keysJustPressed={},this.previousKeys={},document.addEventListener("keydown",e=>{this.keys[e.code]=!0,this.keys[e.key.toLowerCase()]=!0,["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Enter"].includes(e.code)&&e.preventDefault()}),document.addEventListener("keyup",e=>{this.keys[e.code]=!1,this.keys[e.key.toLowerCase()]=!1})}update(){this.keysJustPressed={};for(const e in this.keys)this.keys[e]&&!this.previousKeys[e]&&(this.keysJustPressed[e]=!0);this.previousKeys={...this.keys}}isDown(e){return this.keys[e]||!1}isJustPressed(e){return this.keysJustPressed[e]||!1}getPlayer1Input(){return{left:this.isDown("a")||this.isDown("KeyA"),right:this.isDown("d")||this.isDown("KeyD"),up:this.isDown("w")||this.isDown("KeyW"),down:this.isDown("s")||this.isDown("KeyS"),attack:this.isJustPressed("Space"),special:this.isJustPressed("e")||this.isJustPressed("KeyE")}}getPlayer2Input(){return{left:this.isDown("ArrowLeft"),right:this.isDown("ArrowRight"),up:this.isDown("ArrowUp"),down:this.isDown("ArrowDown"),attack:this.isJustPressed("Enter"),special:this.isJustPressed("Shift")||this.isJustPressed("ShiftRight")}}isConfirm(){return this.isJustPressed("Space")||this.isJustPressed("Enter")}isCancel(){return this.isJustPressed("Escape")}isMenuUp(){return this.isJustPressed("w")||this.isJustPressed("KeyW")||this.isJustPressed("ArrowUp")}isMenuDown(){return this.isJustPressed("s")||this.isJustPressed("KeyS")||this.isJustPressed("ArrowDown")}isMenuLeft(){return this.isJustPressed("a")||this.isJustPressed("KeyA")||this.isJustPressed("ArrowLeft")}isMenuRight(){return this.isJustPressed("d")||this.isJustPressed("KeyD")||this.isJustPressed("ArrowRight")}}const T=new V;class G{constructor(e,t,i){this.playerNum=e,this.x=t,this.y=i,this.width=40,this.height=60,this.baseSpeed=4,this.speed=this.baseSpeed,this.maxHealth=100,this.health=this.maxHealth,this.baseDamage=15,this.damage=this.baseDamage,this.defense=0,this.critChance=.1,this.critMultiplier=1.5,this.facing=1,this.attacking=!1,this.attackTimer=0,this.attackCooldown=0,this.invincible=!1,this.invincibleTimer=0,this.knockbackX=0,this.knockbackY=0,this.velocityX=0,this.velocityY=0,this.isGrounded=!0,this.jumpForce=-12,this.gravity=.5,this.groundY=i+this.height,this.animFrame=0,this.animTimer=0,this.walkCycle=0,this.equipment={sword:m.BASIC,armor:m.BASIC,helmet:m.BASIC,boots:m.BASIC},this.exp=0,this.level=1,this.expToNextLevel=100,this.gold=0,e===1?(this.type="knight",this.colors={primary:"#c0c0c0",secondary:"#888888",accent:"#e74c3c"}):(this.type="robot",this.colors={primary:"#3498db",secondary:"#2980b9",accent:"#2ecc71"})}calculateStats(){const e=this.equipment.sword.multiplier,t=this.equipment.armor.multiplier,i=this.equipment.helmet.multiplier,s=this.equipment.boots.multiplier;this.damage=Math.floor(this.baseDamage*e*(1+(this.level-1)*.1)),this.maxHealth=Math.floor(100*t*(1+(this.level-1)*.05)),this.defense=Math.floor(5*i),this.speed=this.baseSpeed*(.9+s*.2);const l=this.health/this.maxHealth;this.health=Math.floor(this.maxHealth*l)}update(e,t,i){this.groundY=t,this.knockbackX!==0&&(this.x+=this.knockbackX,this.knockbackX*=.8,Math.abs(this.knockbackX)<.5&&(this.knockbackX=0));const s=i?.slipperyFloor?i.friction||.92:.8;let l=0,a=!1;e.left&&(l=-this.speed,this.facing=-1,a=!0),e.right&&(l=this.speed,this.facing=1,a=!0),i?.slipperyFloor?this.velocityX=this.velocityX*s+l*(1-s)*.5:this.velocityX=l,this.x+=this.velocityX,e.up&&this.isGrounded&&(this.velocityY=this.jumpForce,this.isGrounded=!1),this.velocityY+=this.gravity,this.y+=this.velocityY;const o=t-this.height;this.y>=o&&(this.y=o,this.velocityY=0,this.isGrounded=!0),a&&this.isGrounded?this.walkCycle+=.2:this.isGrounded&&(this.walkCycle=0),this.x=Math.max(0,Math.min(r-this.width,this.x)),e.attack&&this.attackCooldown<=0&&(this.attacking=!0,this.attackTimer=20,this.attackCooldown=30),this.attacking&&(this.attackTimer--,this.attackTimer<=0&&(this.attacking=!1)),this.attackCooldown>0&&this.attackCooldown--,this.invincible&&(this.invincibleTimer--,this.invincibleTimer<=0&&(this.invincible=!1)),this.animTimer++,this.animTimer>=10&&(this.animTimer=0,this.animFrame=(this.animFrame+1)%4)}getAttackHitbox(){if(!this.attacking||this.attackTimer<15)return null;const e=50,t=this.height;return{x:this.facing===1?this.x+this.width:this.x-e,y:this.y,width:e,height:t}}takeDamage(e,t=0){if(this.invincible)return 0;const i=Math.max(1,e-this.defense);return this.health-=i,this.invincible=!0,this.invincibleTimer=60,this.knockbackX=t*8,this.health<=0&&(this.health=0),i}heal(e){this.health=Math.min(this.maxHealth,this.health+e)}addExp(e){for(this.exp+=e;this.exp>=this.expToNextLevel;)this.exp-=this.expToNextLevel,this.level++,this.expToNextLevel=Math.floor(this.expToNextLevel*1.5),this.calculateStats(),this.health=this.maxHealth}addGold(e){this.gold+=e}draw(e){if(this.invincible&&Math.floor(this.invincibleTimer/4)%2===0)return;const t=Math.floor(this.x),i=Math.floor(this.y),s=Math.sin(this.walkCycle)*2;this.type==="knight"?this.drawKnight(e,t,i+s):this.drawRobot(e,t,i+s)}drawKnight(e,t,i){const s=this.equipment.sword.color,l=this.equipment.armor.color,a=this.equipment.helmet.color;e.fillStyle=a,e.fillRect(t+8,i,24,20),e.fillStyle="#444",e.fillRect(t+10,i+8,20,8),e.fillStyle=this.colors.accent,e.fillRect(t+14,i-10,12,12),e.fillRect(t+12,i-6,16,4),e.fillStyle=l,e.fillRect(t+5,i+20,30,25),e.fillStyle="#555",e.fillRect(t+17,i+22,6,20);const o=Math.sin(this.walkCycle)*3;if(e.fillStyle="#666",e.fillRect(t+8,i+45-o,10,15),e.fillRect(t+22,i+45+o,10,15),e.fillStyle=s,this.attacking){const h=1-this.attackTimer/20;this.facing===1?(e.save(),e.translate(t+35,i+25),e.rotate(-Math.PI/2+h*Math.PI),e.fillRect(0,-3,45,6),e.fillStyle="#8b4513",e.fillRect(-5,-6,10,12),e.restore()):(e.save(),e.translate(t+5,i+25),e.rotate(Math.PI/2-h*Math.PI),e.fillRect(-45,-3,45,6),e.fillStyle="#8b4513",e.fillRect(-5,-6,10,12),e.restore())}else this.facing===1?(e.fillRect(t+35,i+18,8,30),e.fillStyle="#8b4513",e.fillRect(t+33,i+15,12,6)):(e.fillRect(t-3,i+18,8,30),e.fillStyle="#8b4513",e.fillRect(t-5,i+15,12,6))}drawRobot(e,t,i){const s=this.equipment.armor.color,l=this.colors.accent;e.fillStyle="#e74c3c",e.fillRect(t+15,i-10,4,10),e.fillStyle=this.attacking?"#ff0":"#f00",e.fillRect(t+13,i-14,8,6),e.fillStyle=s,e.fillRect(t+5,i,25,20),e.fillStyle=l,e.fillRect(t+9,i+6,6,6),e.fillRect(t+20,i+6,6,6),e.fillStyle="#fff",e.fillRect(t+10,i+7,2,2),e.fillRect(t+21,i+7,2,2),e.fillStyle=this.colors.secondary,e.fillRect(t+3,i+20,29,24),e.fillStyle="#333",e.fillRect(t+8,i+24,19,16),e.fillStyle=this.attacking?"#f00":l,e.fillRect(t+11,i+27,5,5),e.fillRect(t+19,i+27,5,5),e.fillRect(t+15,i+34,5,5);const a=Math.sin(this.walkCycle)*3;e.fillStyle="#1a5276",e.fillRect(t+6,i+44-a,10,16),e.fillRect(t+19,i+44+a,10,16),e.fillStyle="#555",this.attacking?this.facing===1?(e.fillRect(t+32,i+22,25,10),e.fillStyle="#ff0",e.fillRect(t+57,i+24,20,6),e.fillStyle="#fff",e.fillRect(t+57,i+26,20,2)):(e.fillRect(t-22,i+22,25,10),e.fillStyle="#ff0",e.fillRect(t-42,i+24,20,6),e.fillStyle="#fff",e.fillRect(t-42,i+26,20,2)):this.facing===1?e.fillRect(t+32,i+24,8,16):e.fillRect(t-5,i+24,8,16)}reset(){this.health=this.maxHealth,this.attacking=!1,this.attackTimer=0,this.attackCooldown=0,this.invincible=!1,this.invincibleTimer=0,this.knockbackX=0,this.knockbackY=0,this.velocityX=0,this.velocityY=0,this.isGrounded=!0}}function I(u,e){return u.x<e.x+e.width&&u.x+u.width>e.x&&u.y<e.y+e.height&&u.y+u.height>e.y}function E(u,e){return Math.random()*(e-u)+u}function R(u,e){return Math.floor(E(u,e+1))}function W(u,e,t,i){return Math.sqrt((t-u)**2+(i-e)**2)}class N{constructor(e,t,i,s,l,a=30){this.x=e,this.y=t,this.vx=i,this.vy=s,this.color=l,this.life=a,this.maxLife=a,this.size=E(2,6)}update(){return this.x+=this.vx,this.y+=this.vy,this.vy+=.2,this.life--,this.life>0}draw(e){const t=this.life/this.maxLife;e.globalAlpha=t,e.fillStyle=this.color,e.fillRect(this.x,this.y,this.size,this.size),e.globalAlpha=1}}class A{constructor(e,t,i,s="#fff"){this.x=e,this.y=t,this.damage=i,this.color=s,this.life=60,this.vy=-2}update(){return this.y+=this.vy,this.vy*=.95,this.life--,this.life>0}draw(e){const t=this.life/60;e.globalAlpha=t,e.fillStyle=this.color,e.font='16px "Press Start 2P", monospace',e.textAlign="center";const i=typeof this.damage=="number"?Math.floor(this.damage).toString():this.damage;e.fillText(i,this.x,this.y),e.globalAlpha=1}}class F{constructor(e,t,i,s=""){this.width=0,this.height=0,this.maxHealth=0,this.health=0,this.damage=0,this.speed=0,this.exp=0,this.gold=0,this.color="",this.baseColor="",this.canFly=!1,this.isBoss=!1,this.levelBackground="",this.x=e,this.y=t,this.type=i,this.levelBackground=s,this.facing=-1,this.attackTimer=0,this.attackCooldown=0,this.animFrame=0,this.animTimer=0,this.knockbackX=0,this.dead=!1,this.deathTimer=0,this.setupStats()}getColorForLevel(e){return this.levelBackground==="iceCave"&&{"#2ecc71":"#87CEEB","#27ae60":"#5DADE2","#1e8449":"#F0F8FF"}[e]||e}setupStats(){switch(this.type){case n.SLIME:this.width=30,this.height=25,this.maxHealth=30,this.damage=5,this.speed=1,this.exp=15,this.gold=R(5,15),this.baseColor="#2ecc71",this.color=this.getColorForLevel(this.baseColor);break;case n.GOBLIN:this.width=35,this.height=45,this.maxHealth=50,this.damage=10,this.speed=2,this.exp=25,this.gold=R(10,25),this.baseColor="#27ae60",this.color=this.getColorForLevel(this.baseColor);break;case n.SKELETON:this.width=35,this.height=55,this.maxHealth=70,this.damage=15,this.speed=1.5,this.exp=40,this.gold=R(20,40),this.baseColor="#ecf0f1",this.color=this.getColorForLevel(this.baseColor);break;case n.ORC:this.width=50,this.height=65,this.maxHealth=120,this.damage=20,this.speed=1.2,this.exp=60,this.gold=R(30,60),this.baseColor="#1e8449",this.color=this.getColorForLevel(this.baseColor);break;case n.DRAGON:this.width=80,this.height=70,this.maxHealth=200,this.damage=25,this.speed=1.5,this.exp=100,this.gold=R(50,100),this.baseColor="#c0392b",this.color=this.getColorForLevel(this.baseColor),this.canFly=!0;break;case n.BOSS_DRAGON:this.width=140,this.height=110,this.maxHealth=500,this.damage=35,this.speed=1,this.exp=300,this.gold=R(200,400),this.baseColor="#8e44ad",this.color=this.getColorForLevel(this.baseColor),this.canFly=!0,this.isBoss=!0;break}this.health=this.maxHealth}update(e,t,i){if(this.dead)return this.deathTimer++,this.deathTimer<30;this.knockbackX!==0&&(this.x+=this.knockbackX,this.knockbackX*=.85,Math.abs(this.knockbackX)<.5&&(this.knockbackX=0));let s=null,l=1/0;for(const a of e){if(a.health<=0)continue;const o=W(this.x,this.y,a.x,a.y);o<l&&(l=o,s=a)}return s&&(this.facing=s.x<this.x?-1:1,l>60&&(this.x+=this.facing*this.speed),l<80&&this.attackCooldown<=0&&(this.attackTimer=30,this.attackCooldown=60+R(0,30),(this.type===n.DRAGON||this.type===n.BOSS_DRAGON)&&i.push(new X(this.x+(this.facing===1?this.width:0),this.y+this.height/2,this.facing*5,this.damage)))),this.x=Math.max(0,Math.min(r-this.width,this.x)),this.canFly?this.y=t-this.height-30+Math.sin(Date.now()/500)*10:this.y=t-this.height,this.attackTimer>0&&this.attackTimer--,this.attackCooldown>0&&this.attackCooldown--,this.animTimer++,this.animTimer>=15&&(this.animTimer=0,this.animFrame=(this.animFrame+1)%2),!0}takeDamage(e,t=0){return this.health-=e,this.knockbackX=t*6,this.health<=0&&(this.health=0,this.dead=!0),this.dead}getHitbox(){return{x:this.x,y:this.y,width:this.width,height:this.height}}draw(e){const t=Math.floor(this.x),i=Math.floor(this.y);switch(this.dead&&(e.globalAlpha=1-this.deathTimer/30),this.type){case n.SLIME:this.drawSlime(e,t,i);break;case n.GOBLIN:this.drawGoblin(e,t,i);break;case n.SKELETON:this.drawSkeleton(e,t,i);break;case n.ORC:this.drawOrc(e,t,i);break;case n.DRAGON:case n.BOSS_DRAGON:this.drawDragon(e,t,i);break}e.globalAlpha=1,this.dead||this.drawHealthBar(e,t,i)}drawHealthBar(e,t,i){const s=this.width,l=6,a=i-12;e.fillStyle="#333",e.fillRect(t,a,s,l);const o=this.health/this.maxHealth;e.fillStyle=o>.5?"#2ecc71":o>.25?"#f1c40f":"#e74c3c",e.fillRect(t+1,a+1,(s-2)*o,l-2)}drawSlime(e,t,i){const s=1+Math.sin(this.animTimer/5)*.1;e.fillStyle=this.color,e.beginPath(),e.ellipse(t+this.width/2,i+this.height-5,this.width/2*s,this.height/2/s,0,0,Math.PI*2),e.fill(),e.fillStyle="#fff",e.fillRect(t+8,i+5,6,6),e.fillRect(t+18,i+5,6,6),e.fillStyle="#000",e.fillRect(t+10,i+7,3,3),e.fillRect(t+20,i+7,3,3)}drawGoblin(e,t,i){e.fillStyle=this.color,e.fillRect(t+5,i+15,25,20),e.fillStyle="#27ae60",e.fillRect(t+3,i,29,18),e.fillRect(t-3,i+2,8,10),e.fillRect(t+30,i+2,8,10),e.fillStyle="#ff0",e.fillRect(t+8,i+6,6,5),e.fillRect(t+21,i+6,6,5);const s=this.animFrame*3;e.fillStyle="#1e8449",e.fillRect(t+8,i+35-s,8,10),e.fillRect(t+19,i+35+s,8,10),this.attackTimer>0&&(e.fillStyle="#8b4513",e.fillRect(this.facing===1?t+30:t-15,i+15,15,5))}drawSkeleton(e,t,i){e.fillStyle=this.color,e.fillRect(t+5,i,25,22),e.fillStyle="#000",e.fillRect(t+9,i+6,7,8),e.fillRect(t+19,i+6,7,8),e.fillStyle="#e74c3c",e.fillRect(t+11,i+8,3,4),e.fillRect(t+21,i+8,3,4),e.fillStyle=this.color,e.fillRect(t+10,i+16,15,6),e.fillRect(t+10,i+24,15,18),e.fillStyle="#000";for(let s=0;s<3;s++)e.fillRect(t+12,i+26+s*5,11,2);e.fillStyle=this.color,e.fillRect(t+2,i+24,6,20),e.fillRect(t+27,i+24,6,20),e.fillRect(t+10,i+42,6,13),e.fillRect(t+19,i+42,6,13),e.fillStyle="#7f8c8d",this.attackTimer>0?e.fillRect(this.facing===1?t+33:t-15,i+20,20,4):e.fillRect(t+33,i+25,4,20)}drawOrc(e,t,i){e.fillStyle=this.color,e.fillRect(t+5,i+25,40,28),e.fillRect(t+10,i,30,28),e.fillStyle="#fff",e.fillRect(t+12,i+20,4,8),e.fillRect(t+34,i+20,4,8),e.fillStyle="#c0392b",e.fillRect(t+16,i+8,8,6),e.fillRect(t+26,i+8,8,6),e.fillStyle=this.color,e.fillRect(t-3,i+25,10,25),e.fillRect(t+43,i+25,10,25);const s=this.animFrame*4;e.fillRect(t+10,i+53-s,12,12),e.fillRect(t+28,i+53+s,12,12),e.fillStyle="#8b4513",this.attackTimer>0?e.fillRect(this.facing===1?t+50:t-25,i+20,25,10):e.fillRect(t+50,i+30,8,25)}drawDragon(e,t,i){const s=this.width,l=this.height;e.fillStyle=this.color,e.fillRect(t+s*.2,i+l*.3,s*.6,l*.5),e.fillStyle="#f1c40f",e.fillRect(t+s*.25,i+l*.4,s*.35,l*.35),e.fillStyle=this.color;const a=this.facing===1?t+s*.6:t;if(e.fillRect(a,i+l*.15,s*.4,l*.4),e.fillStyle="#fff",e.fillRect(a+s*.1,i+l*.22,s*.12,l*.12),e.fillStyle="#f1c40f",e.fillRect(a+s*.12,i+l*.25,s*.06,l*.06),this.attackTimer>15){e.fillStyle="#f39c12";const d=this.facing===1?a+s*.35:a-s*.2;e.fillRect(d,i+l*.35,s*.25,l*.15),e.fillStyle="#e74c3c",e.fillRect(d+s*.05,i+l*.38,s*.15,l*.08)}e.fillStyle=this.isBoss?"#6c3483":"#922b21";const o=i+l*.1+Math.sin(Date.now()/200)*5;e.beginPath(),e.moveTo(t+s*.3,i+l*.3),e.lineTo(t+s*.1,o),e.lineTo(t+s*.5,i+l*.25),e.fill(),e.beginPath(),e.moveTo(t+s*.5,i+l*.3),e.lineTo(t+s*.9,o),e.lineTo(t+s*.7,i+l*.25),e.fill(),e.fillStyle=this.color;const h=this.facing===1?t:t+s*.8;e.fillRect(h,i+l*.5,s*.25,l*.15),e.fillRect(t+s*.2,i+l*.75,s*.15,l*.25),e.fillRect(t+s*.55,i+l*.75,s*.15,l*.25),this.isBoss&&(e.fillStyle="#ffd700",e.fillRect(a+s*.05,i,s*.3,l*.12),e.fillRect(a+s*.08,i-l*.08,s*.06,l*.1),e.fillRect(a+s*.17,i-l*.1,s*.06,l*.12),e.fillRect(a+s*.26,i-l*.08,s*.06,l*.1))}}class X{constructor(e,t,i,s){this.x=e,this.y=t,this.vx=i,this.vy=0,this.width=25,this.height=20,this.damage=s,this.life=120}update(){return this.x+=this.vx,this.y+=this.vy,this.life--,this.life>0&&this.x>-50&&this.x<r+50}draw(e){e.fillStyle="#e74c3c",e.beginPath(),e.ellipse(this.x+this.width/2,this.y+this.height/2,this.width/2,this.height/2,0,0,Math.PI*2),e.fill(),e.fillStyle="#f39c12",e.beginPath(),e.ellipse(this.x+this.width/2,this.y+this.height/2,this.width/3,this.height/3,0,0,Math.PI*2),e.fill(),e.fillStyle="#f1c40f",e.beginPath(),e.ellipse(this.x+this.width/2,this.y+this.height/2,this.width/5,this.height/5,0,0,Math.PI*2),e.fill()}getHitbox(){return{x:this.x,y:this.y,width:this.width,height:this.height}}}const K={id:1,name:"The Forest",background:"forest",waves:[{enemies:[n.SLIME,n.SLIME,n.SLIME]},{enemies:[n.SLIME,n.SLIME,n.GOBLIN]},{enemies:[n.GOBLIN,n.GOBLIN]}],colors:{sky:"#87ceeb",skyGradient:"#5dade2",grass:"#27ae60",grassLight:"#2ecc71",ground:"#8b4513"},mechanics:{hazards:[],modifiers:{}}},J={id:2,name:"The Graveyard",background:"graveyard",waves:[{enemies:[n.SKELETON,n.SKELETON]},{enemies:[n.SKELETON,n.GOBLIN,n.GOBLIN]},{enemies:[n.SKELETON,n.SKELETON,n.SKELETON]}],colors:{sky:"#2c3e50",skyGradient:"#1a252f",grass:"#1e3d2f",grassLight:"#2d5a45",ground:"#4a4a4a"},mechanics:{hazards:[],modifiers:{}}},U={id:3,name:"The Mountains",background:"mountains",waves:[{enemies:[n.ORC,n.GOBLIN]},{enemies:[n.ORC,n.ORC]},{enemies:[n.ORC,n.SKELETON,n.SKELETON]}],colors:{sky:"#85929e",skyGradient:"#5d6d7e",grass:"#5d6d7e",grassLight:"#7f8c8d",ground:"#626567"},mechanics:{hazards:[],modifiers:{}}},$={id:4,name:"Frozen Depths",background:"iceCave",waves:[{enemies:[n.SLIME,n.SLIME,n.SLIME]},{enemies:[n.GOBLIN,n.SLIME,n.GOBLIN]},{enemies:[n.GOBLIN,n.GOBLIN,n.SKELETON]},{enemies:[n.ORC,n.GOBLIN,n.GOBLIN]}],colors:{sky:"#1a3a5c",skyGradient:"#0d1f2d",grass:"#a8d8ea",grassLight:"#d4f1f9",ground:"#2d5a7b"},mechanics:{hazards:["slipperyFloor"],modifiers:{},slipperyFloor:!0,friction:.92}},z={id:5,name:"Dragon's Lair",background:"volcano",waves:[{enemies:[n.ORC,n.ORC,n.SKELETON]},{enemies:[n.DRAGON]},{enemies:[n.DRAGON,n.ORC]}],colors:{sky:"#922b21",skyGradient:"#641e16",grass:"#7b241c",grassLight:"#943126",ground:"#4a1c1c"},mechanics:{hazards:[],modifiers:{}}},_={id:6,name:"Sky Citadel",background:"skyCastle",waves:[{enemies:[n.GOBLIN,n.GOBLIN]},{enemies:[n.SKELETON,n.GOBLIN,n.SKELETON]},{enemies:[n.SKELETON,n.SKELETON,n.ORC]},{enemies:[n.DRAGON,n.SKELETON,n.SKELETON]},{enemies:[n.DRAGON,n.ORC,n.GOBLIN,n.GOBLIN]}],colors:{sky:"#87CEEB",skyGradient:"#E0F4FF",grass:"#DAA520",grassLight:"#FFD700",ground:"#8B7355"},mechanics:{hazards:["windGusts"],modifiers:{},windGusts:!0,windInterval:240,windForce:4}},j={id:7,name:"The Final Battle",background:"castle",waves:[{enemies:[n.DRAGON,n.ORC,n.ORC]},{enemies:[n.DRAGON,n.DRAGON]},{enemies:[n.BOSS_DRAGON]}],colors:{sky:"#4a235a",skyGradient:"#1a0a2e",grass:"#512e5f",grassLight:"#6c3483",ground:"#2e1a47"},mechanics:{hazards:[],modifiers:{}}},O=[K,J,U,$,z,_,j];class Q{constructor(){this.currentLevelIndex=0,this.currentWaveIndex=0,this.enemies=[],this.projectiles=[],this.waveComplete=!1,this.waveDelay=0,this.levelComplete=!1,this.windTimer=0,this.windActive=!1,this.windDirection=1,this.windDuration=0,this.windWarning=!1}get currentLevel(){return O[this.currentLevelIndex]}get currentWave(){return this.currentLevel.waves[this.currentWaveIndex]}get isLastLevel(){return this.currentLevelIndex>=O.length-1}get isLastWave(){return this.currentWaveIndex>=this.currentLevel.waves.length-1}startLevel(e){this.currentLevelIndex=Math.min(e,O.length-1),this.currentWaveIndex=0,this.enemies=[],this.projectiles=[],this.waveComplete=!1,this.levelComplete=!1,this.windTimer=0,this.windActive=!1,this.windDirection=1,this.windDuration=0,this.windWarning=!1,this.spawnWave()}spawnWave(){const e=this.currentWave,t=420,i=this.currentLevel.background;e.enemies.forEach((s,l)=>{const a=600+l*100+R(-20,20),o=new F(a,t-60,s,i);this.enemies.push(o)}),this.waveComplete=!1}nextWave(){this.currentWaveIndex++,this.currentWaveIndex>=this.currentLevel.waves.length?this.levelComplete=!0:this.spawnWave()}nextLevel(){return this.currentLevelIndex<O.length-1?(this.currentLevelIndex++,this.currentWaveIndex=0,this.levelComplete=!1,!0):!1}update(e){this.enemies=this.enemies.filter(t=>t.update(e,420,this.projectiles)),this.projectiles=this.projectiles.filter(t=>t.update()),this.currentLevel.mechanics?.windGusts&&this.updateWind(e),this.enemies.length===0&&!this.waveComplete&&(this.waveComplete=!0,this.waveDelay=90),this.waveComplete&&this.waveDelay>0&&(this.waveDelay--,this.waveDelay<=0&&this.nextWave())}updateWind(e){const t=this.currentLevel.mechanics?.windInterval||180,i=this.currentLevel.mechanics?.windForce||3,s=60;this.windTimer++,!this.windActive&&this.windTimer>=t-s&&(this.windWarning=!0),!this.windActive&&this.windTimer>=t&&(this.windActive=!0,this.windWarning=!1,this.windTimer=0,this.windDuration=60,this.windDirection=Math.random()>.5?1:-1),this.windActive&&(this.windDuration--,e.forEach(l=>{l&&l.health>0&&(l.x+=this.windDirection*i*.5,l.isGrounded||(l.x+=this.windDirection*i*.3),l.x=Math.max(0,Math.min(800-l.width,l.x)))}),this.windDuration<=0&&(this.windActive=!1))}drawBackground(e,t,i){const s=this.currentLevel.colors,l=420,a=e.createLinearGradient(0,0,0,l);a.addColorStop(0,s.sky),a.addColorStop(1,s.skyGradient),e.fillStyle=a,e.fillRect(0,0,t,l),this.drawBackgroundElements(e,t,l),e.fillStyle=s.grass,e.fillRect(0,l-20,t,40),e.fillStyle=s.grassLight;for(let h=0;h<t;h+=15)e.fillRect(h,l-20,10,5);e.fillStyle=s.ground,e.fillRect(0,l+20,t,i-l);const o=this.adjustColor(s.ground,20);e.fillStyle=o;for(let h=0;h<t;h+=25)e.fillRect(h+5,l+25,12,6)}drawBackgroundElements(e,t,i){switch(this.currentLevel.background){case"forest":this.drawTrees(e,t,i),this.drawClouds(e,t);break;case"graveyard":this.drawGravestones(e,t,i),this.drawMoon(e);break;case"mountains":this.drawMountains(e,t,i),this.drawClouds(e,t);break;case"iceCave":this.drawIceCave(e,t,i);break;case"volcano":this.drawVolcano(e,t,i),this.drawLava(e,t,i);break;case"castle":this.drawCastle(e,t,i),this.drawMoon(e);break;case"skyCastle":this.drawSkyCastle(e,t,i),this.windActive&&this.drawWindEffect(e,t,i),this.windWarning&&!this.windActive&&this.drawWindWarning(e,t);break}}drawClouds(e,t){e.fillStyle="rgba(255, 255, 255, 0.8)",[[50,50],[200,80],[450,40],[600,90],[750,60]].forEach(([s,l])=>{e.fillRect(s,l,60,25),e.fillRect(s-10,l+10,80,20)})}drawTrees(e,t,i){[50,150,650,750].forEach(l=>{e.fillStyle="#8b4513",e.fillRect(l+15,i-80,20,60),e.fillStyle="#228b22",e.beginPath(),e.moveTo(l+25,i-140),e.lineTo(l-10,i-60),e.lineTo(l+60,i-60),e.fill()})}drawGravestones(e,t,i){const s=[80,200,350,500,680];e.fillStyle="#7f8c8d",s.forEach((l,a)=>{const o=40+a%3*15;e.fillRect(l,i-o-20,30,o),e.beginPath(),e.arc(l+15,i-o-20,15,Math.PI,0),e.fill()})}drawMoon(e){e.fillStyle="#f5f5dc",e.beginPath(),e.arc(680,80,50,0,Math.PI*2),e.fill(),e.fillStyle="#e0e0c0",e.beginPath(),e.arc(670,70,10,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(695,95,8,0,Math.PI*2),e.fill()}drawMountains(e,t,i){e.fillStyle="#5d6d7e",e.beginPath(),e.moveTo(0,i-20),e.lineTo(150,i-180),e.lineTo(300,i-20),e.fill(),e.beginPath(),e.moveTo(250,i-20),e.lineTo(450,i-220),e.lineTo(650,i-20),e.fill(),e.fillStyle="#fff",e.beginPath(),e.moveTo(130,i-160),e.lineTo(150,i-180),e.lineTo(170,i-160),e.fill(),e.beginPath(),e.moveTo(420,i-195),e.lineTo(450,i-220),e.lineTo(480,i-195),e.fill()}drawIceCave(e,t,i){e.fillStyle="#1a2a3a",e.fillRect(0,0,t,80),[50,150,280,420,550,680,750].forEach((a,o)=>{const h=40+o%3*20;e.fillStyle="#a8d8ea",e.beginPath(),e.moveTo(a,80),e.lineTo(a+10,80),e.lineTo(a+5,80+h),e.closePath(),e.fill(),e.fillStyle="#d4f1f9",e.beginPath(),e.moveTo(a+2,80),e.lineTo(a+5,80),e.lineTo(a+4,80+h*.7),e.closePath(),e.fill()}),e.fillStyle="rgba(168, 216, 234, 0.3)",e.fillRect(100,i-15,120,10),e.fillRect(400,i-15,150,10),e.fillRect(650,i-15,100,10),e.fillStyle="#ffffff";const l=Date.now()/200;for(let a=0;a<15;a++){const o=(a*53+l*2)%t,h=100+a*37%(i-120),d=Math.sin(l+a)>.7?3:1;e.fillRect(o,h,d,d)}e.fillStyle="#0d1520",e.fillRect(0,100,30,i-100),e.fillRect(t-25,120,25,i-120)}drawVolcano(e,t,i){e.fillStyle="#4a1c1c",e.beginPath(),e.moveTo(250,i-20),e.lineTo(400,i-200),e.lineTo(550,i-20),e.fill(),e.fillStyle="#e74c3c",e.beginPath(),e.moveTo(370,i-190),e.lineTo(400,i-200),e.lineTo(430,i-190),e.lineTo(420,i-170),e.lineTo(380,i-170),e.fill(),e.fillStyle="#f39c12",e.beginPath(),e.arc(400,i-180,15+Math.sin(Date.now()/200)*3,0,Math.PI*2),e.fill()}drawLava(e,t,i){e.fillStyle="#e74c3c",e.fillRect(100,i+30,80,20),e.fillRect(600,i+35,100,15),e.fillStyle="#f39c12";const s=Date.now()/300;e.beginPath(),e.arc(130+Math.sin(s)*10,i+35,5,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(650+Math.cos(s)*15,i+40,4,0,Math.PI*2),e.fill()}drawCastle(e,t,i){e.fillStyle="#1a0a2e",e.fillRect(100,i-200,60,180),e.fillRect(640,i-200,60,180),e.beginPath(),e.moveTo(100,i-200),e.lineTo(130,i-250),e.lineTo(160,i-200),e.fill(),e.beginPath(),e.moveTo(640,i-200),e.lineTo(670,i-250),e.lineTo(700,i-200),e.fill(),e.fillRect(200,i-150,400,130),e.fillStyle="#f39c12",e.fillRect(120,i-150,20,30),e.fillRect(660,i-150,20,30),e.fillRect(350,i-120,30,40),e.fillRect(420,i-120,30,40);for(let s=0;s<10;s++)e.fillStyle="#1a0a2e",e.fillRect(200+s*40,i-170,25,25)}drawSkyCastle(e,t,i){const s=Date.now()/1e3;e.fillStyle="rgba(255, 255, 255, 0.6)",[[50,60],[200,90],[400,50],[600,80],[750,70]].forEach(([a,o])=>{const h=Date.now()/100%t,d=(a+h*.1)%t;e.fillRect(d,o,80,30),e.fillRect(d+10,o-10,60,25),e.fillRect(d+20,o+15,50,20)}),e.fillStyle="#8B7355",e.beginPath(),e.ellipse(150,i-100,60,20,0,0,Math.PI*2),e.fill(),e.fillStyle="#228B22",e.fillRect(130,i-115,40,15),e.fillStyle="#8B7355",e.beginPath(),e.ellipse(650,i-150,40,15,0,0,Math.PI*2),e.fill(),e.fillStyle="#4a4a6a",e.fillRect(680,i-250,40,150),e.fillRect(720,i-200,30,100),e.beginPath(),e.moveTo(680,i-250),e.lineTo(700,i-290),e.lineTo(720,i-250),e.fill(),e.fillStyle="#FFD700",e.fillRect(695,i-220,10,15),e.fillRect(695,i-180,10,15),e.strokeStyle="#333",e.lineWidth=2;for(let a=0;a<3;a++){const o=(300+a*100+s*20)%(t+50)-25,h=100+Math.sin(s+a)*20+a*30;e.beginPath(),e.moveTo(o-8,h),e.quadraticCurveTo(o,h-5,o+8,h),e.stroke()}e.fillStyle="#FFD700",e.beginPath(),e.arc(700,60,30,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(255, 215, 0, 0.3)",e.lineWidth=3;for(let a=0;a<8;a++){const o=a/8*Math.PI*2+s*.1;e.beginPath(),e.moveTo(700+Math.cos(o)*35,60+Math.sin(o)*35),e.lineTo(700+Math.cos(o)*55,60+Math.sin(o)*55),e.stroke()}}drawWindEffect(e,t,i){e.strokeStyle="rgba(255, 255, 255, 0.5)",e.lineWidth=2;const s=this.windDirection;for(let l=0;l<20;l++){const a=s>0?l*40%t:t-l*40%t,o=100+l*37%(i-150),h=20+Math.random()*30;e.beginPath(),e.moveTo(a,o),e.lineTo(a+s*h,o+Math.sin(Date.now()/100+l)*5),e.stroke()}e.fillStyle="rgba(139, 115, 85, 0.6)";for(let l=0;l<10;l++){const a=(Date.now()/10*s+l*80)%(t+100)-50,o=150+l*47%(i-200),h=Date.now()/200+l;e.save(),e.translate(a,o),e.rotate(h),e.fillRect(-4,-2,8,4),e.restore()}}drawWindWarning(e,t){const i=.5+Math.sin(Date.now()/100)*.3;e.fillStyle=`rgba(255, 255, 0, ${i})`,e.font="bold 24px Arial",e.textAlign="center",e.fillText("WIND INCOMING!",t/2,50),e.strokeStyle=`rgba(255, 255, 0, ${i})`,e.lineWidth=3,e.beginPath(),e.moveTo(t/2-80,70),e.lineTo(t/2-100,70),e.lineTo(t/2-90,60),e.moveTo(t/2-100,70),e.lineTo(t/2-90,80),e.stroke(),e.beginPath(),e.moveTo(t/2+80,70),e.lineTo(t/2+100,70),e.lineTo(t/2+90,60),e.moveTo(t/2+100,70),e.lineTo(t/2+90,80),e.stroke()}adjustColor(e,t){const i=parseInt(e.slice(1),16),s=Math.min(255,(i>>16&255)+t),l=Math.min(255,(i>>8&255)+t),a=Math.min(255,(i&255)+t);return`rgb(${s}, ${l}, ${a})`}draw(e){this.enemies.forEach(t=>t.draw(e)),this.projectiles.forEach(t=>t.draw(e))}}function Z(u){return"effect"in u}function q(u){return"tier"in u}const B={sword:[{tier:m.BASIC,price:0,name:"Wooden Sword",description:"A basic training sword"},{tier:m.IRON,price:100,name:"Iron Sword",description:"+25% damage"},{tier:m.STEEL,price:250,name:"Steel Sword",description:"+50% damage"},{tier:m.GOLD,price:500,name:"Golden Blade",description:"+75% damage"},{tier:m.DIAMOND,price:1e3,name:"Diamond Edge",description:"+100% damage"},{tier:m.LEGENDARY,price:2e3,name:"Excalibur",description:"+150% damage"}],armor:[{tier:m.BASIC,price:0,name:"Cloth Armor",description:"Basic protection"},{tier:m.IRON,price:120,name:"Iron Armor",description:"+25% max HP"},{tier:m.STEEL,price:300,name:"Steel Plate",description:"+50% max HP"},{tier:m.GOLD,price:600,name:"Golden Mail",description:"+75% max HP"},{tier:m.DIAMOND,price:1200,name:"Diamond Armor",description:"+100% max HP"},{tier:m.LEGENDARY,price:2500,name:"Dragon Scale",description:"+150% max HP"}],helmet:[{tier:m.BASIC,price:0,name:"Leather Cap",description:"Basic headwear"},{tier:m.IRON,price:80,name:"Iron Helm",description:"+25% defense"},{tier:m.STEEL,price:200,name:"Steel Helm",description:"+50% defense"},{tier:m.GOLD,price:400,name:"Golden Crown",description:"+75% defense"},{tier:m.DIAMOND,price:800,name:"Diamond Visor",description:"+100% defense"},{tier:m.LEGENDARY,price:1800,name:"Helm of Ages",description:"+150% defense"}],boots:[{tier:m.BASIC,price:0,name:"Sandals",description:"Basic footwear"},{tier:m.IRON,price:60,name:"Iron Boots",description:"+5% speed"},{tier:m.STEEL,price:150,name:"Steel Greaves",description:"+10% speed"},{tier:m.GOLD,price:350,name:"Golden Steps",description:"+15% speed"},{tier:m.DIAMOND,price:700,name:"Diamond Dash",description:"+20% speed"},{tier:m.LEGENDARY,price:1500,name:"Hermes Wings",description:"+30% speed"}]},Y=[{id:"health_potion",name:"Health Potion",price:30,description:"Restore 50 HP",effect:u=>u.heal(50)},{id:"full_heal",name:"Full Restore",price:100,description:"Restore all HP",effect:u=>u.heal(u.maxHealth)}];class x{constructor(){this.selectedCategory=0,this.selectedItem=0,this.categories=["sword","armor","helmet","boots","items"],this.message="",this.messageTimer=0}getAvailableUpgrades(e,t){if(t==="items")return Y;const i=B[t],s=e.equipment[t],l=i.findIndex(a=>a.tier.name===s.name);return i.slice(l+1,l+4)}getCurrentEquipment(e,t){if(t==="items")return null;const i=B[t],s=e.equipment[t];return i.find(l=>l.tier.name===s.name)}canAfford(e,t){return e.gold>=t.price}purchase(e,t,i){return this.canAfford(e,i)?(e.gold-=i.price,Z(i)?(i.effect(e),this.showMessage(`Used ${i.name}!`)):q(i)&&(e.equipment[t]=i.tier,e.calculateStats(),this.showMessage(`Equipped ${i.name}!`)),!0):(this.showMessage("Not enough gold!"),!1)}showMessage(e){this.message=e,this.messageTimer=120}update(e,t){this.messageTimer>0&&this.messageTimer--,e.isMenuLeft()&&(this.selectedCategory=(this.selectedCategory-1+this.categories.length)%this.categories.length,this.selectedItem=0),e.isMenuRight()&&(this.selectedCategory=(this.selectedCategory+1)%this.categories.length,this.selectedItem=0);const i=this.categories[this.selectedCategory],s=this.getAvailableUpgrades(t,i);if(e.isMenuUp()&&(this.selectedItem=Math.max(0,this.selectedItem-1)),e.isMenuDown()&&(this.selectedItem=Math.min(s.length-1,this.selectedItem+1)),e.isConfirm()&&s.length>0){const l=s[this.selectedItem];l&&this.purchase(t,i,l)}return!e.isCancel()}draw(e,t,i,s){e.fillStyle="rgba(0, 0, 0, 0.85)",e.fillRect(0,0,i,s),e.fillStyle="#ffd700",e.font='28px "Press Start 2P", monospace',e.textAlign="center",e.fillText("SHOP",i/2,50),e.fillStyle="#ffd700",e.font='14px "Press Start 2P", monospace',e.textAlign="right",e.fillText(`Gold: ${t.gold}`,i-30,50);const l=140,a=(i-l*this.categories.length)/2;e.font='12px "Press Start 2P", monospace',this.categories.forEach((g,p)=>{const w=a+p*l,y=p===this.selectedCategory;e.fillStyle=y?"#3498db":"#2c3e50",e.fillRect(w,80,l-5,35),e.fillStyle=y?"#fff":"#7f8c8d",e.textAlign="center",e.fillText(g.toUpperCase(),w+l/2-2,103)});const o=this.categories[this.selectedCategory],h=this.getCurrentEquipment(t,o);h&&(e.fillStyle="#2c3e50",e.fillRect(50,130,300,80),e.fillStyle="#95a5a6",e.font='10px "Press Start 2P", monospace',e.textAlign="left",e.fillText("EQUIPPED:",60,155),e.fillStyle=h.tier.color,e.font='12px "Press Start 2P", monospace',e.fillText(h.name,60,180),e.fillStyle="#7f8c8d",e.font='10px "Press Start 2P", monospace',e.fillText(h.description,60,200)),e.fillStyle="#2c3e50",e.fillRect(450,130,300,80),e.fillStyle="#fff",e.font='10px "Press Start 2P", monospace',e.textAlign="left",e.fillText(`DMG: ${t.damage}`,460,155),e.fillText(`HP: ${t.health}/${t.maxHealth}`,460,175),e.fillText(`DEF: ${t.defense}`,460,195),e.fillText(`LVL: ${t.level}`,600,155),e.fillText(`EXP: ${t.exp}/${t.expToNextLevel}`,600,175);const d=this.getAvailableUpgrades(t,o);e.fillStyle="#1a1a2e",e.fillRect(50,230,700,220),d.length===0?(e.fillStyle="#7f8c8d",e.font='14px "Press Start 2P", monospace',e.textAlign="center",e.fillText("No upgrades available",i/2,340),e.fillText("(Max level reached!)",i/2,370)):d.forEach((g,p)=>{const w=255+p*60,y=p===this.selectedItem,P=this.canAfford(t,g);y&&(e.fillStyle="rgba(52, 152, 219, 0.3)",e.fillRect(55,w-20,690,55)),e.fillStyle=q(g)?g.tier.color:"#3498db",P||(e.fillStyle="#e74c3c"),e.font='12px "Press Start 2P", monospace',e.textAlign="left",e.fillText(g.name,70,w),e.fillStyle="#7f8c8d",e.font='10px "Press Start 2P", monospace',e.fillText(g.description,70,w+20),e.fillStyle=P?"#ffd700":"#e74c3c",e.textAlign="right",e.fillText(`${g.price} G`,720,w)}),this.messageTimer>0&&(e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(i/2-150,s/2-30,300,60),e.fillStyle="#2ecc71",e.font='14px "Press Start 2P", monospace',e.textAlign="center",e.fillText(this.message,i/2,s/2+5)),e.fillStyle="#5d6d7e",e.font='10px "Press Start 2P", monospace',e.textAlign="center",e.fillText("← → Categories | ↑ ↓ Select | ENTER Buy | ESC Exit",i/2,s-20)}}class ee{constructor(){this.stars=[],this.shootingStars=[],this.magicParticles=[],this.fireflies=[],this.lastShootingStarTime=0,this.auroraOffset=0,this.initialized=!1,this.menuSelection=0,this.menuOptions=["Start Game","2 Player Co-op"]}initMenuBackground(){if(!this.initialized){this.initialized=!0;for(let e=0;e<3;e++){const t=e===0?100:e===1?60:30;for(let i=0;i<t;i++)this.stars.push({x:Math.random()*r,y:Math.random()*f*.7,size:e===0?1:e===1?1.5:2.5,speed:(e+1)*.15,twinkleOffset:Math.random()*Math.PI*2,layer:e})}for(let e=0;e<15;e++){const t=Math.random()*r,i=f*.5+Math.random()*f*.4;this.fireflies.push({x:t,y:i,baseX:t,baseY:i,phase:Math.random()*Math.PI*2,speed:.5+Math.random()*1,brightness:Math.random()})}}}updateMenuBackground(){const e=Date.now();if(this.stars.forEach(t=>{t.x-=t.speed,t.x<0&&(t.x=r,t.y=Math.random()*f*.7)}),e-this.lastShootingStarTime>3e3+Math.random()*4e3&&this.shootingStars.length<3&&(this.shootingStars.push({x:Math.random()*r*.5+r*.25,y:Math.random()*100,vx:8+Math.random()*4,vy:3+Math.random()*2,length:50+Math.random()*50,life:60+Math.random()*40,maxLife:60+Math.random()*40}),this.lastShootingStarTime=e),this.shootingStars=this.shootingStars.filter(t=>(t.x+=t.vx,t.y+=t.vy,t.life--,t.life>0&&t.x<r+100)),Math.random()<.1){const t=["#ffd700","#ff6b6b","#4ecdc4","#9b59b6","#3498db"];this.magicParticles.push({x:r*.5+(Math.random()-.5)*100,y:f*.45,vx:(Math.random()-.5)*2,vy:-1-Math.random()*2,size:2+Math.random()*3,color:t[Math.floor(Math.random()*t.length)],life:80+Math.random()*40,maxLife:80+Math.random()*40})}this.magicParticles=this.magicParticles.filter(t=>(t.x+=t.vx,t.y+=t.vy,t.vy-=.02,t.vx*=.99,t.life--,t.life>0)),this.fireflies.forEach(t=>{t.phase+=.02*t.speed,t.x=t.baseX+Math.sin(t.phase)*30,t.y=t.baseY+Math.cos(t.phase*.7)*20,t.brightness=.3+Math.sin(t.phase*3)*.35+.35}),this.auroraOffset+=.005}drawMenuBackground(e){const t=Date.now(),i=e.createLinearGradient(0,0,0,f);i.addColorStop(0,"#0a0520"),i.addColorStop(.3,"#0f0c29"),i.addColorStop(.6,"#1a1040"),i.addColorStop(1,"#0d1b2a"),e.fillStyle=i,e.fillRect(0,0,r,f),this.drawAurora(e),this.drawNebula(e,t),this.stars.forEach(s=>{const l=Math.sin(t/300+s.twinkleOffset)*.5+.5,a=.3+l*.7,o=s.size*(.8+l*.4);e.globalAlpha=a,e.fillStyle=s.layer===2?"#ffffd0":"#ffffff",e.beginPath(),e.arc(s.x,s.y,o,0,Math.PI*2),e.fill(),s.layer===2&&(e.globalAlpha=a*.3,e.beginPath(),e.arc(s.x,s.y,o*3,0,Math.PI*2),e.fill())}),e.globalAlpha=1,this.shootingStars.forEach(s=>{const l=s.life/s.maxLife,a=e.createLinearGradient(s.x,s.y,s.x-s.vx*(s.length/10),s.y-s.vy*(s.length/10));a.addColorStop(0,`rgba(255, 255, 255, ${l})`),a.addColorStop(1,"rgba(255, 255, 255, 0)"),e.strokeStyle=a,e.lineWidth=2,e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(s.x-s.vx*(s.length/10),s.y-s.vy*(s.length/10)),e.stroke(),e.globalAlpha=l,e.fillStyle="#fff",e.beginPath(),e.arc(s.x,s.y,2,0,Math.PI*2),e.fill(),e.globalAlpha=1}),this.drawMountains(e),this.drawCastle(e,t),this.drawGround(e,t),this.magicParticles.forEach(s=>{const l=s.life/s.maxLife;e.globalAlpha=l,e.fillStyle=s.color,e.beginPath(),e.arc(s.x,s.y,s.size,0,Math.PI*2),e.fill(),e.globalAlpha=l*.4,e.beginPath(),e.arc(s.x,s.y,s.size*2.5,0,Math.PI*2),e.fill()}),e.globalAlpha=1,this.fireflies.forEach(s=>{e.globalAlpha=s.brightness,e.fillStyle="#ffff88",e.beginPath(),e.arc(s.x,s.y,2,0,Math.PI*2),e.fill(),e.globalAlpha=s.brightness*.3;const l=e.createRadialGradient(s.x,s.y,0,s.x,s.y,15);l.addColorStop(0,"rgba(255, 255, 100, 0.5)"),l.addColorStop(1,"rgba(255, 255, 100, 0)"),e.fillStyle=l,e.beginPath(),e.arc(s.x,s.y,15,0,Math.PI*2),e.fill()}),e.globalAlpha=1}drawAurora(e){e.globalAlpha=.15;for(let t=0;t<3;t++){const i=Math.sin(this.auroraOffset+t*.5)*30,s=e.createLinearGradient(0,50+t*40+i,0,150+t*40+i);t===0?(s.addColorStop(0,"rgba(0, 255, 150, 0)"),s.addColorStop(.5,"rgba(0, 255, 150, 0.8)"),s.addColorStop(1,"rgba(0, 255, 150, 0)")):t===1?(s.addColorStop(0,"rgba(150, 0, 255, 0)"),s.addColorStop(.5,"rgba(150, 0, 255, 0.6)"),s.addColorStop(1,"rgba(150, 0, 255, 0)")):(s.addColorStop(0,"rgba(0, 150, 255, 0)"),s.addColorStop(.5,"rgba(0, 150, 255, 0.5)"),s.addColorStop(1,"rgba(0, 150, 255, 0)")),e.fillStyle=s,e.beginPath(),e.moveTo(0,80+t*30+i);for(let l=0;l<=r;l+=20){const a=Math.sin(l*.01+this.auroraOffset*2+t)*20;e.lineTo(l,100+t*30+i+a)}e.lineTo(r,200+t*30),e.lineTo(0,200+t*30),e.closePath(),e.fill()}e.globalAlpha=1}drawNebula(e,t){e.globalAlpha=.08,["#ff6b6b","#9b59b6","#3498db"].forEach((s,l)=>{const a=150+l*250+Math.sin(t/5e3+l)*30,o=100+Math.cos(t/4e3+l*2)*20,h=80+Math.sin(t/3e3+l)*20,d=e.createRadialGradient(a,o,0,a,o,h);d.addColorStop(0,s),d.addColorStop(1,"transparent"),e.fillStyle=d,e.beginPath(),e.arc(a,o,h,0,Math.PI*2),e.fill()}),e.globalAlpha=1}drawMountains(e){e.fillStyle="#1a1030",e.beginPath(),e.moveTo(0,f*.65),e.lineTo(80,f*.45),e.lineTo(150,f*.55),e.lineTo(250,f*.35),e.lineTo(350,f*.5),e.lineTo(450,f*.4),e.lineTo(550,f*.48),e.lineTo(650,f*.38),e.lineTo(750,f*.52),e.lineTo(r,f*.45),e.lineTo(r,f),e.lineTo(0,f),e.closePath(),e.fill(),e.fillStyle="#120a20",e.beginPath(),e.moveTo(0,f*.7),e.lineTo(100,f*.55),e.lineTo(200,f*.62),e.lineTo(300,f*.5),e.lineTo(400,f*.58),e.lineTo(500,f*.52),e.lineTo(600,f*.6),e.lineTo(700,f*.54),e.lineTo(r,f*.6),e.lineTo(r,f),e.lineTo(0,f),e.closePath(),e.fill()}drawCastle(e,t){const i=r*.5,s=f*.68;e.fillStyle="#0a0515",e.fillRect(i-80,s-100,160,100),e.fillRect(i-25,s-200,50,200),e.beginPath(),e.moveTo(i-30,s-200),e.lineTo(i,s-250),e.lineTo(i+30,s-200),e.closePath(),e.fill(),e.fillRect(i-100,s-140,35,140),e.beginPath(),e.moveTo(i-105,s-140),e.lineTo(i-82.5,s-175),e.lineTo(i-60,s-140),e.closePath(),e.fill(),e.fillRect(i+65,s-140,35,140),e.beginPath(),e.moveTo(i+60,s-140),e.lineTo(i+82.5,s-175),e.lineTo(i+105,s-140),e.closePath(),e.fill(),e.fillRect(i-130,s-90,25,90),e.beginPath(),e.moveTo(i-135,s-90),e.lineTo(i-117.5,s-115),e.lineTo(i-100,s-90),e.closePath(),e.fill(),e.fillRect(i+105,s-90,25,90),e.beginPath(),e.moveTo(i+100,s-90),e.lineTo(i+117.5,s-115),e.lineTo(i+135,s-90),e.closePath(),e.fill();for(let h=-70;h<=70;h+=20)e.fillRect(i+h-7,s-110,14,15);const l=.5+Math.sin(t/500)*.3;e.fillStyle=`rgba(255, 200, 100, ${l})`,e.fillRect(i-8,s-180,6,10),e.fillRect(i+2,s-180,6,10),e.fillRect(i-5,s-150,10,15),e.fillRect(i-90,s-120,8,12),e.fillRect(i+80,s-120,8,12);for(let h=-50;h<=30;h+=40)e.fillRect(i+h,s-70,12,20);const a=e.createLinearGradient(i-20,s-50,i-20,s);a.addColorStop(0,`rgba(255, 150, 50, ${l*.8})`),a.addColorStop(1,"rgba(255, 150, 50, 0)"),e.fillStyle=a,e.fillRect(i-20,s-50,40,50),e.fillStyle="#8b0000";const o=Math.sin(t/200)*5;e.beginPath(),e.moveTo(i,s-250),e.lineTo(i+25+o,s-240),e.lineTo(i+20+o*.5,s-230),e.lineTo(i,s-235),e.closePath(),e.fill(),e.strokeStyle="#333",e.lineWidth=2,e.beginPath(),e.moveTo(i,s-250),e.lineTo(i,s-265),e.stroke()}drawGround(e,t){const i=e.createLinearGradient(0,f*.68,0,f);i.addColorStop(0,"#0a0515"),i.addColorStop(.3,"#0d0820"),i.addColorStop(1,"#05030a"),e.fillStyle=i,e.fillRect(0,f*.68,r,f*.32),e.globalAlpha=.15;for(let s=0;s<5;s++){const l=(s*200+t/30)%(r+200)-100,a=f*.65+Math.sin(t/1e3+s)*10,o=e.createRadialGradient(l,a,0,l,a,80);o.addColorStop(0,"rgba(150, 150, 200, 0.5)"),o.addColorStop(1,"transparent"),e.fillStyle=o,e.beginPath(),e.arc(l,a,80,0,Math.PI*2),e.fill()}e.globalAlpha=1,e.fillStyle="#0a0515";for(let s=0;s<r;s+=8){const l=5+Math.sin(s*.1)*3+Math.sin(t/500+s*.05)*2;e.fillRect(s,f*.68-l,2,l)}}drawMenu(e){this.initMenuBackground(),this.updateMenuBackground(),this.drawMenuBackground(e);const t=Date.now();e.textAlign="center";const i=r/2-220,s=60,l=440,a=330,o=e.createLinearGradient(i,s,i,s+a);o.addColorStop(0,"rgba(10, 5, 30, 0.85)"),o.addColorStop(.5,"rgba(15, 10, 40, 0.9)"),o.addColorStop(1,"rgba(10, 5, 30, 0.85)"),e.fillStyle=o;const h=15;e.beginPath(),e.moveTo(i+h,s),e.lineTo(i+l-h,s),e.quadraticCurveTo(i+l,s,i+l,s+h),e.lineTo(i+l,s+a-h),e.quadraticCurveTo(i+l,s+a,i+l-h,s+a),e.lineTo(i+h,s+a),e.quadraticCurveTo(i,s+a,i,s+a-h),e.lineTo(i,s+h),e.quadraticCurveTo(i,s,i+h,s),e.closePath(),e.fill(),e.strokeStyle="rgba(100, 80, 150, 0.6)",e.lineWidth=2,e.stroke(),e.strokeStyle="rgba(150, 120, 200, 0.3)",e.lineWidth=1,e.beginPath(),e.moveTo(i+h+10,s+2),e.lineTo(i+l-h-10,s+2),e.stroke();const d=100+Math.sin(t/500)*3;e.shadowColor="#ffd700",e.shadowBlur=25,e.fillStyle="#ffd700",e.font="bold 28px monospace",e.fillText("RETRO GAME JAM",r/2,d),e.shadowColor="#ff4444",e.shadowBlur=35,e.fillStyle="#ff6b6b",e.font="bold 44px monospace",e.fillText("GO NUTS!",r/2,d+55),e.shadowColor="#4ecdc4",e.shadowBlur=20,e.fillStyle="#4ecdc4",e.font="bold 13px monospace",e.fillText("DRAGON SLAYER ADVENTURE",r/2,d+95),e.shadowBlur=0;const g=d+115,p=e.createLinearGradient(r/2-120,g,r/2+120,g);p.addColorStop(0,"rgba(78, 205, 196, 0)"),p.addColorStop(.3,"rgba(78, 205, 196, 0.5)"),p.addColorStop(.5,"rgba(78, 205, 196, 0.8)"),p.addColorStop(.7,"rgba(78, 205, 196, 0.5)"),p.addColorStop(1,"rgba(78, 205, 196, 0)"),e.strokeStyle=p,e.lineWidth=2,e.beginPath(),e.moveTo(r/2-120,g),e.lineTo(r/2+120,g),e.stroke(),e.font="bold 20px monospace",this.menuOptions.forEach((w,y)=>{const P=270+y*55,L=y===this.menuSelection;if(L){const H=.4+Math.sin(t/200)*.15,S=r/2-140,b=P-20,k=280,M=42,C=8;e.fillStyle=`rgba(52, 152, 219, ${H})`,e.beginPath(),e.moveTo(S+C,b),e.lineTo(S+k-C,b),e.quadraticCurveTo(S+k,b,S+k,b+C),e.lineTo(S+k,b+M-C),e.quadraticCurveTo(S+k,b+M,S+k-C,b+M),e.lineTo(S+C,b+M),e.quadraticCurveTo(S,b+M,S,b+M-C),e.lineTo(S,b+C),e.quadraticCurveTo(S,b,S+C,b),e.closePath(),e.fill(),e.strokeStyle="#5dade2",e.lineWidth=2,e.shadowColor="#3498db",e.shadowBlur=15,e.stroke(),e.shadowBlur=0,e.fillStyle="#ffd700",e.shadowColor="#ffd700",e.shadowBlur=10;const D=Math.sin(t/150)*6;e.font="bold 24px monospace",e.fillText(">",r/2-115+D,P+7),e.fillText("<",r/2+115-D,P+7),e.shadowBlur=0,e.font="bold 20px monospace"}e.shadowColor="rgba(0, 0, 0, 0.8)",e.shadowBlur=4,e.shadowOffsetX=2,e.shadowOffsetY=2,e.fillStyle=L?"#ffffff":"rgba(160, 160, 180, 0.8)",e.fillText(w,r/2,P+7),e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0}),e.font="12px monospace",e.fillStyle="rgba(120, 130, 150, 0.9)",e.shadowColor="rgba(0, 0, 0, 0.5)",e.shadowBlur=3,e.fillText("UP/DOWN Select  |  ENTER/SPACE Start",r/2,f-55),e.shadowBlur=0,e.fillStyle="rgba(80, 80, 120, 0.7)",e.fillText("Retro Game Jam 2024",r/2,f-25)}drawHUD(e,t,i){const s=i.currentLevel,l=i.currentWaveIndex+1,a=s.waves.length;e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(10,10,250,30),e.fillStyle="#ffd700",e.font='12px "Press Start 2P", monospace',e.textAlign="left",e.fillText(`${s.name}`,20,30),e.fillStyle="#fff",e.font='10px "Press Start 2P", monospace',e.fillText(`Wave ${l}/${a}`,180,30),t.forEach((o,h)=>{if(!o)return;const d=10+h*200,g=50,p=180,w=25;e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(d,g,p,w+20),e.fillStyle=h===0?"#ff6b6b":"#4ecdc4",e.font='10px "Press Start 2P", monospace',e.textAlign="left",e.fillText(`P${h+1} LV${o.level}`,d+5,g+12),e.fillStyle="#ffd700",e.textAlign="right",e.fillText(`${o.gold}G`,d+p-5,g+12),e.fillStyle="#333",e.fillRect(d+5,g+18,p-10,12);const y=o.health/o.maxHealth,P=y>.5?"#2ecc71":y>.25?"#f1c40f":"#e74c3c";e.fillStyle=P,e.fillRect(d+6,g+19,(p-12)*y,10),e.fillStyle="#fff",e.font='8px "Press Start 2P", monospace',e.textAlign="center",e.fillText(`${Math.ceil(o.health)}/${o.maxHealth}`,d+p/2,g+28),e.fillStyle="#1a1a2e",e.fillRect(d+5,g+32,p-10,6),e.fillStyle="#9b59b6";const L=o.exp/o.expToNextLevel;e.fillRect(d+6,g+33,(p-12)*L,4)}),i.waveComplete&&i.waveDelay>60&&(e.fillStyle="rgba(0, 0, 0, 0.6)",e.fillRect(0,f/2-40,r,80),e.fillStyle="#2ecc71",e.font='20px "Press Start 2P", monospace',e.textAlign="center",e.fillText("WAVE COMPLETE!",r/2,f/2),e.fillStyle="#fff",e.font='12px "Press Start 2P", monospace',e.fillText("Next wave incoming...",r/2,f/2+25))}drawLevelComplete(e,t,i){e.fillStyle="rgba(0, 0, 0, 0.85)",e.fillRect(0,0,r,f),e.fillStyle="#ffd700",e.font='32px "Press Start 2P", monospace',e.textAlign="center",e.fillText("LEVEL COMPLETE!",r/2,120),e.fillStyle="#2ecc71",e.font='20px "Press Start 2P", monospace',e.fillText(t.currentLevel.name,r/2,170),e.fillStyle="#fff",e.font='14px "Press Start 2P", monospace',e.fillText("All enemies defeated!",r/2,250);const s=Math.floor(Date.now()/500)%2;return e.fillStyle=s?"#4ecdc4":"#3498db",e.font='16px "Press Start 2P", monospace',e.fillText("Press ENTER to continue",r/2,350),e.fillStyle="#7f8c8d",e.font='12px "Press Start 2P", monospace',e.fillText("Press S for Shop",r/2,390),i.isConfirm()?"continue":i.isDown("s")||i.isDown("KeyS")?"shop":null}drawGameOver(e,t){return e.fillStyle="rgba(100, 0, 0, 0.9)",e.fillRect(0,0,r,f),e.fillStyle="#e74c3c",e.font='48px "Press Start 2P", monospace',e.textAlign="center",e.fillText("GAME OVER",r/2,180),e.fillStyle="#fff",e.font='16px "Press Start 2P", monospace',e.fillText("The heroes have fallen...",r/2,250),Math.floor(Date.now()/500)%2&&(e.fillStyle="#ffd700",e.font='14px "Press Start 2P", monospace',e.fillText("Press ENTER to try again",r/2,350)),t.isConfirm()}drawVictory(e,t){e.fillStyle="rgba(0, 50, 0, 0.9)",e.fillRect(0,0,r,f),e.fillStyle="#ffd700";for(let s=0;s<30;s++){const l=(s*67+Date.now()/20)%r,a=(s*43+Date.now()/30)%f;e.fillRect(l,a,6,6)}e.fillStyle="#ff6b6b";for(let s=0;s<20;s++){const l=(s*89+Date.now()/25)%r,a=(s*51+Date.now()/35)%f;e.fillRect(l,a,5,5)}return e.fillStyle="#ffd700",e.font='40px "Press Start 2P", monospace',e.textAlign="center",e.fillText("VICTORY!",r/2,150),e.fillStyle="#2ecc71",e.font='20px "Press Start 2P", monospace',e.fillText("The Dragon King is defeated!",r/2,220),e.fillStyle="#fff",e.font='14px "Press Start 2P", monospace',e.fillText("Peace has returned to the land.",r/2,280),e.fillText("Thank you for playing!",r/2,310),Math.floor(Date.now()/500)%2&&(e.fillStyle="#4ecdc4",e.font='12px "Press Start 2P", monospace',e.fillText("Press ENTER to play again",r/2,400)),t.isConfirm()}drawPauseOverlay(e){e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(0,0,r,f),e.fillStyle="#fff",e.font='32px "Press Start 2P", monospace',e.textAlign="center",e.fillText("PAUSED",r/2,f/2-20),e.font='14px "Press Start 2P", monospace',e.fillText("Press ESC to resume",r/2,f/2+30),e.fillText("Press S for Shop",r/2,f/2+60)}}class ie{constructor(){this.audioContext=null,this.enabled=!0,this.volume=.3,this.initialized=!1}init(){if(!this.initialized)try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.initialized=!0}catch{this.enabled=!1}}resume(){this.audioContext&&this.audioContext.state==="suspended"&&this.audioContext.resume()}playTone(e,t,i="square",s=1){if(!this.enabled||!this.audioContext)return;this.resume();const l=this.audioContext.createOscillator(),a=this.audioContext.createGain();l.connect(a),a.connect(this.audioContext.destination),l.frequency.value=e,l.type=i;const o=this.audioContext.currentTime;a.gain.setValueAtTime(this.volume*s,o),a.gain.exponentialRampToValueAtTime(.001,o+t),l.start(o),l.stop(o+t)}playSequence(e,t=.1){!this.enabled||!this.audioContext||(this.resume(),e.forEach((i,s)=>{setTimeout(()=>{this.playTone(i.freq,i.duration||t,i.type||"square",i.volume||1)},s*(t*1e3*.8))}))}jump(){if(!this.enabled||!this.audioContext)return;this.resume();const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.type="square";const i=this.audioContext.currentTime;e.frequency.setValueAtTime(150,i),e.frequency.exponentialRampToValueAtTime(400,i+.1),t.gain.setValueAtTime(this.volume*.4,i),t.gain.exponentialRampToValueAtTime(.001,i+.15),e.start(i),e.stop(i+.15)}attack(){if(!this.enabled||!this.audioContext)return;this.resume();const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.type="sawtooth";const i=this.audioContext.currentTime;e.frequency.setValueAtTime(200,i),e.frequency.exponentialRampToValueAtTime(80,i+.1),t.gain.setValueAtTime(this.volume*.3,i),t.gain.exponentialRampToValueAtTime(.001,i+.1),e.start(i),e.stop(i+.1)}hit(){if(!this.enabled||!this.audioContext)return;this.resume();const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.type="square";const i=this.audioContext.currentTime;e.frequency.setValueAtTime(300,i),e.frequency.setValueAtTime(200,i+.05),t.gain.setValueAtTime(this.volume*.4,i),t.gain.exponentialRampToValueAtTime(.001,i+.1),e.start(i),e.stop(i+.1)}criticalHit(){!this.enabled||!this.audioContext||(this.resume(),this.playTone(400,.08,"square",.5),setTimeout(()=>{this.playTone(600,.1,"square",.6)},50))}enemyDeath(){if(!this.enabled||!this.audioContext)return;this.resume();const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.type="square";const i=this.audioContext.currentTime;e.frequency.setValueAtTime(400,i),e.frequency.exponentialRampToValueAtTime(50,i+.3),t.gain.setValueAtTime(this.volume*.4,i),t.gain.exponentialRampToValueAtTime(.001,i+.3),e.start(i),e.stop(i+.3)}playerHurt(){if(!this.enabled||!this.audioContext)return;this.resume();const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.type="sawtooth";const i=this.audioContext.currentTime;e.frequency.setValueAtTime(200,i),e.frequency.setValueAtTime(150,i+.05),e.frequency.setValueAtTime(100,i+.1),t.gain.setValueAtTime(this.volume*.4,i),t.gain.exponentialRampToValueAtTime(.001,i+.2),e.start(i),e.stop(i+.2)}coin(){!this.enabled||!this.audioContext||(this.resume(),this.playTone(800,.05,"square",.3),setTimeout(()=>{this.playTone(1e3,.08,"square",.3)},50))}levelUp(){if(!this.enabled||!this.audioContext)return;this.resume();const e=[{freq:523,duration:.1},{freq:659,duration:.1},{freq:784,duration:.1},{freq:1047,duration:.2}];this.playSequence(e,.12)}waveComplete(){if(!this.enabled||!this.audioContext)return;this.resume();const e=[{freq:440,duration:.1},{freq:554,duration:.1},{freq:659,duration:.15}];this.playSequence(e,.1)}gameOver(){if(!this.enabled||!this.audioContext)return;this.resume();const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.type="sawtooth";const i=this.audioContext.currentTime;e.frequency.setValueAtTime(200,i),e.frequency.exponentialRampToValueAtTime(50,i+.8),t.gain.setValueAtTime(this.volume*.5,i),t.gain.exponentialRampToValueAtTime(.001,i+.8),e.start(i),e.stop(i+.8)}victory(){if(!this.enabled||!this.audioContext)return;this.resume();const e=[{freq:523,duration:.15},{freq:523,duration:.15},{freq:523,duration:.15},{freq:523,duration:.4},{freq:415,duration:.4},{freq:466,duration:.4},{freq:523,duration:.3},{freq:466,duration:.1},{freq:523,duration:.5}];this.playSequence(e,.18)}menuSelect(){this.playTone(600,.05,"square",.3)}menuConfirm(){!this.enabled||!this.audioContext||(this.resume(),this.playTone(500,.08,"square",.3),setTimeout(()=>{this.playTone(700,.1,"square",.4)},80))}purchase(){if(!this.enabled||!this.audioContext)return;this.resume();const e=[{freq:600,duration:.08},{freq:800,duration:.08},{freq:1e3,duration:.12}];this.playSequence(e,.08)}error(){!this.enabled||!this.audioContext||(this.resume(),this.playTone(150,.15,"square",.4),setTimeout(()=>{this.playTone(100,.2,"square",.4)},100))}fireball(){if(!this.enabled||!this.audioContext)return;this.resume();const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.type="sawtooth";const i=this.audioContext.currentTime;e.frequency.setValueAtTime(100,i),e.frequency.exponentialRampToValueAtTime(50,i+.15),t.gain.setValueAtTime(this.volume*.25,i),t.gain.exponentialRampToValueAtTime(.001,i+.15),e.start(i),e.stop(i+.15)}toggle(){return this.enabled=!this.enabled,this.enabled}setVolume(e){this.volume=Math.max(0,Math.min(1,e))}}const v=new ie;class te{constructor(){this.canvas=document.getElementById("game"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=r,this.canvas.height=f,this.state=c.MENU,this.coopMode=!1,this.players=[],this.levelManager=new Q,this.shop=new x,this.ui=new ee,this.particles=[],this.damageNumbers=[],this.groundY=420,this.paused=!1,this.lastTime=0,this.gameLoop=this.gameLoop.bind(this),requestAnimationFrame(this.gameLoop)}initGame(e){this.coopMode=e,this.players=[];const t=new G(1,100,this.groundY-60);if(t.calculateStats(),this.players.push(t),e){const l=new G(2,50,this.groundY-60);l.calculateStats(),this.players.push(l)}const i=new URLSearchParams(window.location.search),s=parseInt(i.get("level")||"0",10);this.levelManager.startLevel(s),this.particles=[],this.damageNumbers=[],this.state=c.PLAYING}gameLoop(e){this.lastTime=e,T.update(),this.update(),this.draw(),requestAnimationFrame(this.gameLoop)}update(){switch(this.state){case c.MENU:T.isMenuUp()&&(this.ui.menuSelection=Math.max(0,this.ui.menuSelection-1),v.menuSelect()),T.isMenuDown()&&(this.ui.menuSelection=Math.min(this.ui.menuOptions.length-1,this.ui.menuSelection+1),v.menuSelect()),T.isConfirm()&&(v.menuConfirm(),v.init(),this.initGame(this.ui.menuSelection===1));break;case c.PLAYING:if(T.isCancel()&&(this.paused=!this.paused),this.paused){(T.isDown("s")||T.isDown("KeyS"))&&(this.state=c.SHOP,this.paused=!1);return}this.updateGame();break;case c.SHOP:{this.shop.update(T,this.players[0])||(this.state=c.PLAYING);break}}}updateGame(){const e=this.levelManager.currentLevel.mechanics;this.players.forEach((i,s)=>{if(i.health<=0)return;const l=s===0?T.getPlayer1Input():T.getPlayer2Input();i.update(l,this.groundY,e)}),this.levelManager.update(this.players),this.players.forEach(i=>{if(i.health<=0)return;const s=i.getAttackHitbox();s&&this.levelManager.enemies.forEach(l=>{if(!l.dead&&I(s,l.getHitbox())){let a=i.damage;const o=Math.random()<i.critChance;o?(a*=i.critMultiplier,v.criticalHit()):v.hit();const h=l.takeDamage(a,i.facing);this.damageNumbers.push(new A(l.x+l.width/2,l.y,a,o?"#ffd700":"#fff"));for(let d=0;d<5;d++)this.particles.push(new N(l.x+l.width/2,l.y+l.height/2,E(-3,3),E(-4,-1),o?"#ffd700":"#e74c3c"));if(h){i.addExp(l.exp),i.addGold(l.gold),v.enemyDeath(),v.coin();for(let d=0;d<15;d++)this.particles.push(new N(l.x+l.width/2,l.y+l.height/2,E(-5,5),E(-6,-2),l.color,40));this.damageNumbers.push(new A(l.x+l.width/2,l.y-20,"+"+l.gold+"G","#ffd700"))}}})}),this.levelManager.enemies.forEach(i=>{i.dead||this.players.forEach(s=>{if(!(s.health<=0||s.invincible)&&I(s,i.getHitbox())){const l=s.x<i.x?-1:1,a=s.takeDamage(i.damage,l);v.playerHurt(),this.damageNumbers.push(new A(s.x+s.width/2,s.y,a,"#e74c3c"))}})}),this.levelManager.projectiles.forEach(i=>{this.players.forEach(s=>{if(!(s.health<=0||s.invincible)&&I(s,i.getHitbox())){const l=i.vx>0?1:-1,a=s.takeDamage(i.damage,l);v.playerHurt(),this.damageNumbers.push(new A(s.x+s.width/2,s.y,a,"#e74c3c")),i.life=0}})}),this.particles=this.particles.filter(i=>i.update()),this.damageNumbers=this.damageNumbers.filter(i=>i.update()),this.levelManager.levelComplete&&(this.levelManager.isLastLevel?this.state=c.VICTORY:this.state=c.LEVEL_COMPLETE),this.players.every(i=>i.health<=0)&&(this.state=c.GAME_OVER)}draw(){switch(this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,r,f),this.state){case c.MENU:this.ui.drawMenu(this.ctx);break;case c.PLAYING:case c.SHOP:case c.LEVEL_COMPLETE:if(this.drawGame(),this.state===c.SHOP)this.shop.draw(this.ctx,this.players[0],r,f);else if(this.state===c.LEVEL_COMPLETE){const e=this.ui.drawLevelComplete(this.ctx,this.levelManager,T);e==="continue"?(this.levelManager.nextLevel(),this.levelManager.startLevel(this.levelManager.currentLevelIndex),this.players.forEach(t=>t.reset()),this.state=c.PLAYING):e==="shop"&&(this.state=c.SHOP)}this.paused&&this.state===c.PLAYING&&this.ui.drawPauseOverlay(this.ctx);break;case c.GAME_OVER:this.drawGame(),this.ui.drawGameOver(this.ctx,T)&&(this.levelManager.startLevel(this.levelManager.currentLevelIndex),this.players.forEach(e=>{e.reset(),e.x=e.playerNum===1?100:50,e.y=this.groundY-60}),this.state=c.PLAYING);break;case c.VICTORY:this.drawGame(),this.ui.drawVictory(this.ctx,T)&&(this.state=c.MENU,this.ui.menuSelection=0);break}}drawGame(){this.levelManager.drawBackground(this.ctx,r,f),this.levelManager.draw(this.ctx),this.players.forEach(e=>{e.health>0&&e.draw(this.ctx)}),this.particles.forEach(e=>e.draw(this.ctx)),this.damageNumbers.forEach(e=>e.draw(this.ctx)),this.ui.drawHUD(this.ctx,this.players,this.levelManager)}}document.addEventListener("DOMContentLoaded",()=>{new te});
