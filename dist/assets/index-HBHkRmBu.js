(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();const r=800,d=500,T={MENU:"menu",PLAYING:"playing",SHOP:"shop",LEVEL_COMPLETE:"level_complete",GAME_OVER:"game_over",VICTORY:"victory"},p={BASIC:{name:"Basic",color:"#95a5a6",multiplier:1},IRON:{name:"Iron",color:"#7f8c8d",multiplier:1.25},STEEL:{name:"Steel",color:"#bdc3c7",multiplier:1.5},GOLD:{name:"Gold",color:"#f1c40f",multiplier:1.75},DIAMOND:{name:"Diamond",color:"#3498db",multiplier:2},LEGENDARY:{name:"Legendary",color:"#9b59b6",multiplier:2.5}},h={SLIME:"slime",GOBLIN:"goblin",SKELETON:"skeleton",ORC:"orc",DRAGON:"dragon",BOSS_DRAGON:"boss_dragon"};class Y{constructor(){this.keys={},this.keysJustPressed={},this.previousKeys={},document.addEventListener("keydown",e=>{this.keys[e.code]=!0,this.keys[e.key.toLowerCase()]=!0,["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Enter"].includes(e.code)&&e.preventDefault()}),document.addEventListener("keyup",e=>{this.keys[e.code]=!1,this.keys[e.key.toLowerCase()]=!1})}update(){this.keysJustPressed={};for(const e in this.keys)this.keys[e]&&!this.previousKeys[e]&&(this.keysJustPressed[e]=!0);this.previousKeys={...this.keys}}isDown(e){return this.keys[e]||!1}isJustPressed(e){return this.keysJustPressed[e]||!1}getPlayer1Input(){return{left:this.isDown("a")||this.isDown("KeyA"),right:this.isDown("d")||this.isDown("KeyD"),up:this.isDown("w")||this.isDown("KeyW"),down:this.isDown("s")||this.isDown("KeyS"),attack:this.isJustPressed("Space"),special:this.isJustPressed("e")||this.isJustPressed("KeyE")}}getPlayer2Input(){return{left:this.isDown("ArrowLeft"),right:this.isDown("ArrowRight"),up:this.isDown("ArrowUp"),down:this.isDown("ArrowDown"),attack:this.isJustPressed("Enter"),special:this.isJustPressed("Shift")||this.isJustPressed("ShiftRight")}}isConfirm(){return this.isJustPressed("Space")||this.isJustPressed("Enter")}isCancel(){return this.isJustPressed("Escape")}isMenuUp(){return this.isJustPressed("w")||this.isJustPressed("KeyW")||this.isJustPressed("ArrowUp")}isMenuDown(){return this.isJustPressed("s")||this.isJustPressed("KeyS")||this.isJustPressed("ArrowDown")}isMenuLeft(){return this.isJustPressed("a")||this.isJustPressed("KeyA")||this.isJustPressed("ArrowLeft")}isMenuRight(){return this.isJustPressed("d")||this.isJustPressed("KeyD")||this.isJustPressed("ArrowRight")}}const b=new Y;class X{constructor(){this.baseHealth=100,this.baseDamage=15,this.baseSpeed=4,this.baseDefense=0,this.baseCritChance=.1,this.baseCritMultiplier=1.5,this.baseJumpForce=-12,this.maxHealth=this.baseHealth,this.damage=this.baseDamage,this.speed=this.baseSpeed,this.defense=this.baseDefense,this.critChance=this.baseCritChance,this.critMultiplier=this.baseCritMultiplier,this.jumpForce=this.baseJumpForce,this.skillModifiers={healthMult:1,damageMult:1,speedMult:1,defenseMult:1,critChanceBonus:0,critMultBonus:0,jumpForceMult:1,doubleJump:!1,dashAbility:!1,shieldAbility:!1,lifeSteal:0,attackSpeed:1,berserkerMode:!1,secondWind:!1,secondWindUsed:!1,goldMult:0},this.equipment={sword:p.BASIC,armor:p.BASIC,helmet:p.BASIC,boots:p.BASIC},this.level=1,this.exp=0,this.expToNextLevel=100,this.gold=0,this.skillPoints=0}recalculate(){const e=this.equipment.sword.multiplier,t=this.equipment.armor.multiplier,i=this.equipment.helmet.multiplier,s=this.equipment.boots.multiplier,a=1+(this.level-1)*.1;this.damage=Math.floor(this.baseDamage*e*a*this.skillModifiers.damageMult),this.maxHealth=Math.floor(this.baseHealth*t*(1+(this.level-1)*.05)*this.skillModifiers.healthMult),this.defense=Math.floor(this.baseDefense+5*i*this.skillModifiers.defenseMult),this.speed=this.baseSpeed*(.9+s*.2)*this.skillModifiers.speedMult,this.critChance=this.baseCritChance+this.skillModifiers.critChanceBonus,this.critMultiplier=this.baseCritMultiplier+this.skillModifiers.critMultBonus,this.jumpForce=this.baseJumpForce*this.skillModifiers.jumpForceMult}addExp(e){this.exp+=e;let t=!1;for(;this.exp>=this.expToNextLevel;)this.exp-=this.expToNextLevel,this.level++,this.skillPoints++,this.expToNextLevel=Math.floor(this.expToNextLevel*1.5),t=!0;return t&&this.recalculate(),t}addGold(e){this.gold+=e}spendGold(e){return this.gold>=e?(this.gold-=e,!0):!1}applySkillModifier(e,t){e in this.skillModifiers&&(typeof this.skillModifiers[e]=="boolean"?this.skillModifiers[e]=t:this.skillModifiers[e]+=t,this.recalculate())}resetSkillModifiers(){this.skillModifiers={healthMult:1,damageMult:1,speedMult:1,defenseMult:1,critChanceBonus:0,critMultBonus:0,jumpForceMult:1,doubleJump:!1,dashAbility:!1,shieldAbility:!1,lifeSteal:0,attackSpeed:1,berserkerMode:!1,secondWind:!1,secondWindUsed:!1,goldMult:0},this.recalculate()}resetSecondWind(){this.skillModifiers.secondWindUsed=!1}}class j{constructor(){this.audioContext=null,this.enabled=!0,this.volume=.3,this.initialized=!1}init(){if(!this.initialized)try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.initialized=!0}catch{this.enabled=!1}}resume(){this.audioContext&&this.audioContext.state==="suspended"&&this.audioContext.resume()}playTone(e,t,i="square",s=1){if(!this.enabled||!this.audioContext)return;this.resume();const a=this.audioContext.createOscillator(),o=this.audioContext.createGain();a.connect(o),o.connect(this.audioContext.destination),a.frequency.value=e,a.type=i;const n=this.audioContext.currentTime;o.gain.setValueAtTime(this.volume*s,n),o.gain.exponentialRampToValueAtTime(.001,n+t),a.start(n),a.stop(n+t)}playSequence(e,t=.1){!this.enabled||!this.audioContext||(this.resume(),e.forEach((i,s)=>{setTimeout(()=>{this.playTone(i.freq,i.duration||t,i.type||"square",i.volume||1)},s*(t*1e3*.8))}))}jump(){if(!this.enabled||!this.audioContext)return;this.resume();const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.type="square";const i=this.audioContext.currentTime;e.frequency.setValueAtTime(150,i),e.frequency.exponentialRampToValueAtTime(400,i+.1),t.gain.setValueAtTime(this.volume*.4,i),t.gain.exponentialRampToValueAtTime(.001,i+.15),e.start(i),e.stop(i+.15)}attack(){if(!this.enabled||!this.audioContext)return;this.resume();const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.audioContext.destination),t.type="sawtooth",t.frequency.setValueAtTime(800,e),t.frequency.exponentialRampToValueAtTime(200,e+.12),i.gain.setValueAtTime(this.volume*.2,e),i.gain.exponentialRampToValueAtTime(.001,e+.12),t.start(e),t.stop(e+.12);const s=this.audioContext.createOscillator(),a=this.audioContext.createGain();s.connect(a),a.connect(this.audioContext.destination),s.type="square",s.frequency.setValueAtTime(1200,e),s.frequency.exponentialRampToValueAtTime(600,e+.08),a.gain.setValueAtTime(this.volume*.15,e),a.gain.exponentialRampToValueAtTime(.001,e+.1),s.start(e),s.stop(e+.1);const o=this.audioContext.createOscillator(),n=this.audioContext.createGain();o.connect(n),n.connect(this.audioContext.destination),o.type="sine",o.frequency.setValueAtTime(150,e),o.frequency.exponentialRampToValueAtTime(60,e+.06),n.gain.setValueAtTime(this.volume*.25,e),n.gain.exponentialRampToValueAtTime(.001,e+.08),o.start(e),o.stop(e+.08)}hit(){if(!this.enabled||!this.audioContext)return;this.resume();const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.audioContext.destination),t.type="sine",t.frequency.setValueAtTime(120,e),t.frequency.exponentialRampToValueAtTime(40,e+.08),i.gain.setValueAtTime(this.volume*.5,e),i.gain.exponentialRampToValueAtTime(.001,e+.1),t.start(e),t.stop(e+.1);const s=this.audioContext.createOscillator(),a=this.audioContext.createGain();s.connect(a),a.connect(this.audioContext.destination),s.type="square",s.frequency.setValueAtTime(400,e),s.frequency.setValueAtTime(250,e+.02),s.frequency.setValueAtTime(180,e+.04),a.gain.setValueAtTime(this.volume*.35,e),a.gain.exponentialRampToValueAtTime(.001,e+.08),s.start(e),s.stop(e+.08);const o=this.audioContext.createOscillator(),n=this.audioContext.createGain();o.connect(n),n.connect(this.audioContext.destination),o.type="square",o.frequency.setValueAtTime(800,e),n.gain.setValueAtTime(this.volume*.2,e),n.gain.exponentialRampToValueAtTime(.001,e+.03),o.start(e),o.stop(e+.03)}criticalHit(){if(!this.enabled||!this.audioContext)return;this.resume();const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.audioContext.destination),t.type="sine",t.frequency.setValueAtTime(80,e),t.frequency.exponentialRampToValueAtTime(30,e+.15),i.gain.setValueAtTime(this.volume*.6,e),i.gain.exponentialRampToValueAtTime(.001,e+.2),t.start(e),t.stop(e+.2);const s=this.audioContext.createOscillator(),a=this.audioContext.createGain();s.connect(a),a.connect(this.audioContext.destination),s.type="square",s.frequency.setValueAtTime(600,e),s.frequency.setValueAtTime(400,e+.02),s.frequency.setValueAtTime(200,e+.05),a.gain.setValueAtTime(this.volume*.5,e),a.gain.exponentialRampToValueAtTime(.001,e+.1),s.start(e),s.stop(e+.1);const o=this.audioContext.createOscillator(),n=this.audioContext.createGain();o.connect(n),n.connect(this.audioContext.destination),o.type="sawtooth",o.frequency.setValueAtTime(400,e),o.frequency.exponentialRampToValueAtTime(1200,e+.1),n.gain.setValueAtTime(this.volume*.25,e),n.gain.exponentialRampToValueAtTime(.001,e+.15),o.start(e),o.stop(e+.15),setTimeout(()=>{if(!this.audioContext)return;const l=this.audioContext.currentTime,u=this.audioContext.createOscillator(),c=this.audioContext.createGain();u.connect(c),c.connect(this.audioContext.destination),u.type="square",u.frequency.setValueAtTime(800,l),u.frequency.exponentialRampToValueAtTime(400,l+.08),c.gain.setValueAtTime(this.volume*.4,l),c.gain.exponentialRampToValueAtTime(.001,l+.1),u.start(l),u.stop(l+.1)},60)}enemyDeath(){if(!this.enabled||!this.audioContext)return;this.resume();const e=this.audioContext.currentTime,t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.audioContext.destination),t.type="sine",t.frequency.setValueAtTime(200,e),t.frequency.exponentialRampToValueAtTime(30,e+.25),i.gain.setValueAtTime(this.volume*.5,e),i.gain.exponentialRampToValueAtTime(.001,e+.3),t.start(e),t.stop(e+.3);const s=this.audioContext.createOscillator(),a=this.audioContext.createGain();s.connect(a),a.connect(this.audioContext.destination),s.type="square",s.frequency.setValueAtTime(500,e),s.frequency.exponentialRampToValueAtTime(100,e+.15),a.gain.setValueAtTime(this.volume*.35,e),a.gain.exponentialRampToValueAtTime(.001,e+.2),s.start(e),s.stop(e+.2);const o=this.audioContext.createOscillator(),n=this.audioContext.createGain();o.connect(n),n.connect(this.audioContext.destination),o.type="square",o.frequency.setValueAtTime(1e3,e),o.frequency.exponentialRampToValueAtTime(300,e+.1),n.gain.setValueAtTime(this.volume*.2,e),n.gain.exponentialRampToValueAtTime(.001,e+.12),o.start(e),o.stop(e+.12)}playerHurt(){if(!this.enabled||!this.audioContext)return;this.resume();const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.type="sawtooth";const i=this.audioContext.currentTime;e.frequency.setValueAtTime(200,i),e.frequency.setValueAtTime(150,i+.05),e.frequency.setValueAtTime(100,i+.1),t.gain.setValueAtTime(this.volume*.4,i),t.gain.exponentialRampToValueAtTime(.001,i+.2),e.start(i),e.stop(i+.2)}coin(){!this.enabled||!this.audioContext||(this.resume(),this.playTone(800,.05,"square",.3),setTimeout(()=>{this.playTone(1e3,.08,"square",.3)},50))}levelUp(){if(!this.enabled||!this.audioContext)return;this.resume();const e=[{freq:523,duration:.1},{freq:659,duration:.1},{freq:784,duration:.1},{freq:1047,duration:.2}];this.playSequence(e,.12)}waveComplete(){if(!this.enabled||!this.audioContext)return;this.resume();const e=[{freq:440,duration:.1},{freq:554,duration:.1},{freq:659,duration:.15}];this.playSequence(e,.1)}gameOver(){if(!this.enabled||!this.audioContext)return;this.resume();const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.type="sawtooth";const i=this.audioContext.currentTime;e.frequency.setValueAtTime(200,i),e.frequency.exponentialRampToValueAtTime(50,i+.8),t.gain.setValueAtTime(this.volume*.5,i),t.gain.exponentialRampToValueAtTime(.001,i+.8),e.start(i),e.stop(i+.8)}victory(){if(!this.enabled||!this.audioContext)return;this.resume();const e=[{freq:523,duration:.15},{freq:523,duration:.15},{freq:523,duration:.15},{freq:523,duration:.4},{freq:415,duration:.4},{freq:466,duration:.4},{freq:523,duration:.3},{freq:466,duration:.1},{freq:523,duration:.5}];this.playSequence(e,.18)}menuSelect(){this.playTone(600,.05,"square",.3)}menuConfirm(){!this.enabled||!this.audioContext||(this.resume(),this.playTone(500,.08,"square",.3),setTimeout(()=>{this.playTone(700,.1,"square",.4)},80))}purchase(){if(!this.enabled||!this.audioContext)return;this.resume();const e=[{freq:600,duration:.08},{freq:800,duration:.08},{freq:1e3,duration:.12}];this.playSequence(e,.08)}error(){!this.enabled||!this.audioContext||(this.resume(),this.playTone(150,.15,"square",.4),setTimeout(()=>{this.playTone(100,.2,"square",.4)},100))}fireball(){if(!this.enabled||!this.audioContext)return;this.resume();const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.type="sawtooth";const i=this.audioContext.currentTime;e.frequency.setValueAtTime(100,i),e.frequency.exponentialRampToValueAtTime(50,i+.15),t.gain.setValueAtTime(this.volume*.25,i),t.gain.exponentialRampToValueAtTime(.001,i+.15),e.start(i),e.stop(i+.15)}toggle(){return this.enabled=!this.enabled,this.enabled}setVolume(e){this.volume=Math.max(0,Math.min(1,e))}}const y=new j;class V{constructor(e,t,i){this.playerNum=e,this.x=t,this.y=i,this.width=40,this.height=60,this.baseSpeed=4,this.speed=this.baseSpeed,this.maxHealth=100,this.health=this.maxHealth,this.baseDamage=15,this.damage=this.baseDamage,this.defense=0,this.critChance=.1,this.critMultiplier=1.5,this.facing=1,this.attacking=!1,this.attackTimer=0,this.attackCooldown=0,this.invincible=!1,this.invincibleTimer=0,this.knockbackX=0,this.knockbackY=0,this.velocityX=0,this.velocityY=0,this.isGrounded=!0,this.jumpForce=-12,this.gravity=.5,this.groundY=i+this.height,this.animFrame=0,this.animTimer=0,this.walkCycle=0,this.equipment={sword:p.BASIC,armor:p.BASIC,helmet:p.BASIC,boots:p.BASIC},this.exp=0,this.level=1,this.expToNextLevel=100,this.gold=0,e===1?(this.type="knight",this.colors={primary:"#c0c0c0",secondary:"#888888",accent:"#e74c3c"}):(this.type="robot",this.colors={primary:"#3498db",secondary:"#2980b9",accent:"#2ecc71"}),this.stats=new X,this.canDoubleJump=!1,this.hasDoubleJumped=!1,this.skillPoints=0}calculateStats(){const e=this.equipment.sword.multiplier,t=this.equipment.armor.multiplier,i=this.equipment.helmet.multiplier,s=this.equipment.boots.multiplier,a=this.stats.skillModifiers.damageMult,o=this.stats.skillModifiers.healthMult,n=this.stats.skillModifiers.defenseMult,l=this.stats.skillModifiers.speedMult;this.damage=Math.floor(this.baseDamage*e*(1+(this.level-1)*.1)*a);const u=this.maxHealth;if(this.maxHealth=Math.floor(100*t*(1+(this.level-1)*.05)*o),this.defense=Math.floor(5*i*n),this.speed=this.baseSpeed*(.9+s*.2)*l,this.critChance=.1+this.stats.skillModifiers.critChanceBonus,this.critMultiplier=1.5+this.stats.skillModifiers.critMultBonus,this.canDoubleJump=this.stats.skillModifiers.doubleJump,u>0){const c=this.health/u;this.health=Math.floor(this.maxHealth*c)}}getEffectiveDamage(){let e=this.damage;return this.stats.skillModifiers.berserkerMode&&this.health<this.maxHealth*.3&&(e=Math.floor(e*1.4)),e}isBerserkerActive(){return this.stats.skillModifiers.berserkerMode&&this.health<this.maxHealth*.3}update(e,t,i){this.groundY=t,this.knockbackX!==0&&(this.x+=this.knockbackX,this.knockbackX*=.8,Math.abs(this.knockbackX)<.5&&(this.knockbackX=0));const s=i?.slipperyFloor?i.friction||.92:.8;let a=0,o=!1;e.left&&(a=-this.speed,this.facing=-1,o=!0),e.right&&(a=this.speed,this.facing=1,o=!0),i?.slipperyFloor?this.velocityX=this.velocityX*s+a*(1-s)*.5:this.velocityX=a,this.x+=this.velocityX,e.up&&(this.isGrounded?(this.velocityY=this.jumpForce,this.isGrounded=!1,this.hasDoubleJumped=!1,y.jump()):this.canDoubleJump&&!this.hasDoubleJumped&&(this.velocityY=this.jumpForce*.85,this.hasDoubleJumped=!0,y.jump())),this.velocityY+=this.gravity,this.y+=this.velocityY;const n=t-this.height;this.y>=n&&(this.y=n,this.velocityY=0,this.isGrounded=!0),o&&this.isGrounded?this.walkCycle+=.2:this.isGrounded&&(this.walkCycle=0),this.x=Math.max(0,Math.min(r-this.width,this.x)),e.attack&&this.attackCooldown<=0&&(this.attacking=!0,this.attackTimer=20,this.attackCooldown=30),this.attacking&&(this.attackTimer--,this.attackTimer<=0&&(this.attacking=!1)),this.attackCooldown>0&&this.attackCooldown--,this.invincible&&(this.invincibleTimer--,this.invincibleTimer<=0&&(this.invincible=!1)),this.animTimer++,this.animTimer>=10&&(this.animTimer=0,this.animFrame=(this.animFrame+1)%4)}getAttackHitbox(){if(!this.attacking||this.attackTimer<15)return null;const e=50,t=this.height;return{x:this.facing===1?this.x+this.width:this.x-e,y:this.y,width:e,height:t}}takeDamage(e,t=0){if(this.invincible)return 0;const i=Math.max(1,e-this.defense);return this.health-=i,this.invincible=!0,this.invincibleTimer=60,this.knockbackX=t*8,this.health<=0&&this.stats.skillModifiers.secondWind&&!this.stats.skillModifiers.secondWindUsed?(this.health=Math.floor(this.maxHealth*.25),this.stats.skillModifiers.secondWindUsed=!0,this.invincible=!0,this.invincibleTimer=120,y.levelUp(),0):(this.health<=0&&(this.health=0),i)}heal(e){this.health=Math.min(this.maxHealth,this.health+e)}addExp(e){this.exp+=e;let t=!1;for(;this.exp>=this.expToNextLevel;)this.exp-=this.expToNextLevel,this.level++,this.stats.skillPoints++,this.expToNextLevel=Math.floor(this.expToNextLevel*1.5),this.calculateStats(),this.health=this.maxHealth,t=!0;return t}addGold(e){this.gold+=e}draw(e){if(this.invincible&&Math.floor(this.invincibleTimer/4)%2===0)return;const t=Math.floor(this.x),i=Math.floor(this.y),s=Math.sin(this.walkCycle)*2;this.type==="knight"?this.drawKnight(e,t,i+s):this.drawRobot(e,t,i+s)}drawKnight(e,t,i){const s=this.equipment.sword.color,a=this.equipment.armor.color,o=this.equipment.helmet.color;e.fillStyle=o,e.fillRect(t+8,i,24,20),e.fillStyle="#444",e.fillRect(t+10,i+8,20,8),e.fillStyle=this.colors.accent,e.fillRect(t+14,i-10,12,12),e.fillRect(t+12,i-6,16,4),e.fillStyle=a,e.fillRect(t+5,i+20,30,25),e.fillStyle="#555",e.fillRect(t+17,i+22,6,20);const n=Math.sin(this.walkCycle)*3;if(e.fillStyle="#666",e.fillRect(t+8,i+45-n,10,15),e.fillRect(t+22,i+45+n,10,15),e.fillStyle=s,this.attacking){const l=1-this.attackTimer/20;this.facing===1?(e.save(),e.translate(t+35,i+25),e.rotate(-Math.PI/2+l*Math.PI),e.fillRect(0,-3,45,6),e.fillStyle="#8b4513",e.fillRect(-5,-6,10,12),e.restore()):(e.save(),e.translate(t+5,i+25),e.rotate(Math.PI/2-l*Math.PI),e.fillRect(-45,-3,45,6),e.fillStyle="#8b4513",e.fillRect(-5,-6,10,12),e.restore())}else this.facing===1?(e.fillRect(t+35,i+18,8,30),e.fillStyle="#8b4513",e.fillRect(t+33,i+15,12,6)):(e.fillRect(t-3,i+18,8,30),e.fillStyle="#8b4513",e.fillRect(t-5,i+15,12,6))}drawRobot(e,t,i){const s=this.equipment.armor.color,a=this.colors.accent;e.fillStyle="#e74c3c",e.fillRect(t+15,i-10,4,10),e.fillStyle=this.attacking?"#ff0":"#f00",e.fillRect(t+13,i-14,8,6),e.fillStyle=s,e.fillRect(t+5,i,25,20),e.fillStyle=a,e.fillRect(t+9,i+6,6,6),e.fillRect(t+20,i+6,6,6),e.fillStyle="#fff",e.fillRect(t+10,i+7,2,2),e.fillRect(t+21,i+7,2,2),e.fillStyle=this.colors.secondary,e.fillRect(t+3,i+20,29,24),e.fillStyle="#333",e.fillRect(t+8,i+24,19,16),e.fillStyle=this.attacking?"#f00":a,e.fillRect(t+11,i+27,5,5),e.fillRect(t+19,i+27,5,5),e.fillRect(t+15,i+34,5,5);const o=Math.sin(this.walkCycle)*3;e.fillStyle="#1a5276",e.fillRect(t+6,i+44-o,10,16),e.fillRect(t+19,i+44+o,10,16),e.fillStyle="#555",this.attacking?this.facing===1?(e.fillRect(t+32,i+22,25,10),e.fillStyle="#ff0",e.fillRect(t+57,i+24,20,6),e.fillStyle="#fff",e.fillRect(t+57,i+26,20,2)):(e.fillRect(t-22,i+22,25,10),e.fillStyle="#ff0",e.fillRect(t-42,i+24,20,6),e.fillStyle="#fff",e.fillRect(t-42,i+26,20,2)):this.facing===1?e.fillRect(t+32,i+24,8,16):e.fillRect(t-5,i+24,8,16)}reset(){this.health=this.maxHealth,this.attacking=!1,this.attackTimer=0,this.attackCooldown=0,this.invincible=!1,this.invincibleTimer=0,this.knockbackX=0,this.knockbackY=0,this.velocityX=0,this.velocityY=0,this.isGrounded=!0,this.hasDoubleJumped=!1,this.stats.skillModifiers.secondWindUsed=!1}}function B(f,e){return f.x<e.x+e.width&&f.x+f.width>e.x&&f.y<e.y+e.height&&f.y+f.height>e.y}function L(f,e){return Math.random()*(e-f)+f}function A(f,e){return Math.floor(L(f,e+1))}function Q(f,e,t,i){return Math.sqrt((t-f)**2+(i-e)**2)}class F{constructor(e,t,i,s,a,o=30){this.x=e,this.y=t,this.vx=i,this.vy=s,this.color=a,this.life=o,this.maxLife=o,this.size=L(2,6)}update(){return this.x+=this.vx,this.y+=this.vy,this.vy+=.2,this.life--,this.life>0}draw(e){const t=this.life/this.maxLife;e.globalAlpha=t,e.fillStyle=this.color,e.fillRect(this.x,this.y,this.size,this.size),e.globalAlpha=1}}class I{constructor(e,t,i,s="#fff"){this.x=e,this.y=t,this.damage=i,this.color=s,this.life=60,this.vy=-2}update(){return this.y+=this.vy,this.vy*=.95,this.life--,this.life>0}draw(e){const t=this.life/60;e.globalAlpha=t,e.fillStyle=this.color,e.font='16px "Press Start 2P", monospace',e.textAlign="center";const i=typeof this.damage=="number"?Math.floor(this.damage).toString():this.damage;e.fillText(i,this.x,this.y),e.globalAlpha=1}}class Z{constructor(e,t,i,s=""){this.width=0,this.height=0,this.maxHealth=0,this.health=0,this.damage=0,this.speed=0,this.exp=0,this.gold=0,this.color="",this.baseColor="",this.canFly=!1,this.isBoss=!1,this.levelBackground="",this.x=e,this.y=t,this.type=i,this.levelBackground=s,this.facing=-1,this.attackTimer=0,this.attackCooldown=0,this.animFrame=0,this.animTimer=0,this.knockbackX=0,this.dead=!1,this.deathTimer=0,this.setupStats()}getColorForLevel(e){return this.levelBackground==="iceCave"&&{"#2ecc71":"#87CEEB","#27ae60":"#5DADE2","#1e8449":"#F0F8FF"}[e]||e}setupStats(){switch(this.type){case h.SLIME:this.width=30,this.height=25,this.maxHealth=30,this.damage=5,this.speed=1,this.exp=15,this.gold=A(5,15),this.baseColor="#2ecc71",this.color=this.getColorForLevel(this.baseColor);break;case h.GOBLIN:this.width=35,this.height=45,this.maxHealth=50,this.damage=10,this.speed=2,this.exp=25,this.gold=A(10,25),this.baseColor="#27ae60",this.color=this.getColorForLevel(this.baseColor);break;case h.SKELETON:this.width=35,this.height=55,this.maxHealth=70,this.damage=15,this.speed=1.5,this.exp=40,this.gold=A(20,40),this.baseColor="#ecf0f1",this.color=this.getColorForLevel(this.baseColor);break;case h.ORC:this.width=50,this.height=65,this.maxHealth=120,this.damage=20,this.speed=1.2,this.exp=60,this.gold=A(30,60),this.baseColor="#1e8449",this.color=this.getColorForLevel(this.baseColor);break;case h.DRAGON:this.width=80,this.height=70,this.maxHealth=200,this.damage=25,this.speed=1.5,this.exp=100,this.gold=A(50,100),this.baseColor="#c0392b",this.color=this.getColorForLevel(this.baseColor),this.canFly=!0;break;case h.BOSS_DRAGON:this.width=140,this.height=110,this.maxHealth=500,this.damage=35,this.speed=1,this.exp=300,this.gold=A(200,400),this.baseColor="#8e44ad",this.color=this.getColorForLevel(this.baseColor),this.canFly=!0,this.isBoss=!0;break}this.health=this.maxHealth}update(e,t,i){if(this.dead)return this.deathTimer++,this.deathTimer<30;this.knockbackX!==0&&(this.x+=this.knockbackX,this.knockbackX*=.85,Math.abs(this.knockbackX)<.5&&(this.knockbackX=0));let s=null,a=1/0;for(const o of e){if(o.health<=0)continue;const n=Q(this.x,this.y,o.x,o.y);n<a&&(a=n,s=o)}return s&&(this.facing=s.x<this.x?-1:1,a>60&&(this.x+=this.facing*this.speed),a<80&&this.attackCooldown<=0&&(this.attackTimer=30,this.attackCooldown=60+A(0,30),(this.type===h.DRAGON||this.type===h.BOSS_DRAGON)&&i.push(new x(this.x+(this.facing===1?this.width:0),this.y+this.height/2,this.facing*5,this.damage)))),this.x=Math.max(0,Math.min(r-this.width,this.x)),this.canFly?this.y=t-this.height-30+Math.sin(Date.now()/500)*10:this.y=t-this.height,this.attackTimer>0&&this.attackTimer--,this.attackCooldown>0&&this.attackCooldown--,this.animTimer++,this.animTimer>=15&&(this.animTimer=0,this.animFrame=(this.animFrame+1)%2),!0}takeDamage(e,t=0){return this.health-=e,this.knockbackX=t*6,this.health<=0&&(this.health=0,this.dead=!0),this.dead}getHitbox(){return{x:this.x,y:this.y,width:this.width,height:this.height}}draw(e){const t=Math.floor(this.x),i=Math.floor(this.y);switch(this.dead&&(e.globalAlpha=1-this.deathTimer/30),this.type){case h.SLIME:this.drawSlime(e,t,i);break;case h.GOBLIN:this.drawGoblin(e,t,i);break;case h.SKELETON:this.drawSkeleton(e,t,i);break;case h.ORC:this.drawOrc(e,t,i);break;case h.DRAGON:case h.BOSS_DRAGON:this.drawDragon(e,t,i);break}e.globalAlpha=1,this.dead||this.drawHealthBar(e,t,i)}drawHealthBar(e,t,i){const s=this.width,a=6,o=i-12;e.fillStyle="#333",e.fillRect(t,o,s,a);const n=this.health/this.maxHealth;e.fillStyle=n>.5?"#2ecc71":n>.25?"#f1c40f":"#e74c3c",e.fillRect(t+1,o+1,(s-2)*n,a-2)}drawSlime(e,t,i){const s=1+Math.sin(this.animTimer/5)*.1;e.fillStyle=this.color,e.beginPath(),e.ellipse(t+this.width/2,i+this.height-5,this.width/2*s,this.height/2/s,0,0,Math.PI*2),e.fill(),e.fillStyle="#fff",e.fillRect(t+8,i+5,6,6),e.fillRect(t+18,i+5,6,6),e.fillStyle="#000",e.fillRect(t+10,i+7,3,3),e.fillRect(t+20,i+7,3,3)}drawGoblin(e,t,i){e.fillStyle=this.color,e.fillRect(t+5,i+15,25,20),e.fillStyle="#27ae60",e.fillRect(t+3,i,29,18),e.fillRect(t-3,i+2,8,10),e.fillRect(t+30,i+2,8,10),e.fillStyle="#ff0",e.fillRect(t+8,i+6,6,5),e.fillRect(t+21,i+6,6,5);const s=this.animFrame*3;e.fillStyle="#1e8449",e.fillRect(t+8,i+35-s,8,10),e.fillRect(t+19,i+35+s,8,10),this.attackTimer>0&&(e.fillStyle="#8b4513",e.fillRect(this.facing===1?t+30:t-15,i+15,15,5))}drawSkeleton(e,t,i){e.fillStyle=this.color,e.fillRect(t+5,i,25,22),e.fillStyle="#000",e.fillRect(t+9,i+6,7,8),e.fillRect(t+19,i+6,7,8),e.fillStyle="#e74c3c",e.fillRect(t+11,i+8,3,4),e.fillRect(t+21,i+8,3,4),e.fillStyle=this.color,e.fillRect(t+10,i+16,15,6),e.fillRect(t+10,i+24,15,18),e.fillStyle="#000";for(let s=0;s<3;s++)e.fillRect(t+12,i+26+s*5,11,2);e.fillStyle=this.color,e.fillRect(t+2,i+24,6,20),e.fillRect(t+27,i+24,6,20),e.fillRect(t+10,i+42,6,13),e.fillRect(t+19,i+42,6,13),e.fillStyle="#7f8c8d",this.attackTimer>0?e.fillRect(this.facing===1?t+33:t-15,i+20,20,4):e.fillRect(t+33,i+25,4,20)}drawOrc(e,t,i){e.fillStyle=this.color,e.fillRect(t+5,i+25,40,28),e.fillRect(t+10,i,30,28),e.fillStyle="#fff",e.fillRect(t+12,i+20,4,8),e.fillRect(t+34,i+20,4,8),e.fillStyle="#c0392b",e.fillRect(t+16,i+8,8,6),e.fillRect(t+26,i+8,8,6),e.fillStyle=this.color,e.fillRect(t-3,i+25,10,25),e.fillRect(t+43,i+25,10,25);const s=this.animFrame*4;e.fillRect(t+10,i+53-s,12,12),e.fillRect(t+28,i+53+s,12,12),e.fillStyle="#8b4513",this.attackTimer>0?e.fillRect(this.facing===1?t+50:t-25,i+20,25,10):e.fillRect(t+50,i+30,8,25)}drawDragon(e,t,i){const s=this.width,a=this.height;e.fillStyle=this.color,e.fillRect(t+s*.2,i+a*.3,s*.6,a*.5),e.fillStyle="#f1c40f",e.fillRect(t+s*.25,i+a*.4,s*.35,a*.35),e.fillStyle=this.color;const o=this.facing===1?t+s*.6:t;if(e.fillRect(o,i+a*.15,s*.4,a*.4),e.fillStyle="#fff",e.fillRect(o+s*.1,i+a*.22,s*.12,a*.12),e.fillStyle="#f1c40f",e.fillRect(o+s*.12,i+a*.25,s*.06,a*.06),this.attackTimer>15){e.fillStyle="#f39c12";const u=this.facing===1?o+s*.35:o-s*.2;e.fillRect(u,i+a*.35,s*.25,a*.15),e.fillStyle="#e74c3c",e.fillRect(u+s*.05,i+a*.38,s*.15,a*.08)}e.fillStyle=this.isBoss?"#6c3483":"#922b21";const n=i+a*.1+Math.sin(Date.now()/200)*5;e.beginPath(),e.moveTo(t+s*.3,i+a*.3),e.lineTo(t+s*.1,n),e.lineTo(t+s*.5,i+a*.25),e.fill(),e.beginPath(),e.moveTo(t+s*.5,i+a*.3),e.lineTo(t+s*.9,n),e.lineTo(t+s*.7,i+a*.25),e.fill(),e.fillStyle=this.color;const l=this.facing===1?t:t+s*.8;e.fillRect(l,i+a*.5,s*.25,a*.15),e.fillRect(t+s*.2,i+a*.75,s*.15,a*.25),e.fillRect(t+s*.55,i+a*.75,s*.15,a*.25),this.isBoss&&(e.fillStyle="#ffd700",e.fillRect(o+s*.05,i,s*.3,a*.12),e.fillRect(o+s*.08,i-a*.08,s*.06,a*.1),e.fillRect(o+s*.17,i-a*.1,s*.06,a*.12),e.fillRect(o+s*.26,i-a*.08,s*.06,a*.1))}}class x{constructor(e,t,i,s){this.x=e,this.y=t,this.vx=i,this.vy=0,this.width=25,this.height=20,this.damage=s,this.life=120}update(){return this.x+=this.vx,this.y+=this.vy,this.life--,this.life>0&&this.x>-50&&this.x<r+50}draw(e){e.fillStyle="#e74c3c",e.beginPath(),e.ellipse(this.x+this.width/2,this.y+this.height/2,this.width/2,this.height/2,0,0,Math.PI*2),e.fill(),e.fillStyle="#f39c12",e.beginPath(),e.ellipse(this.x+this.width/2,this.y+this.height/2,this.width/3,this.height/3,0,0,Math.PI*2),e.fill(),e.fillStyle="#f1c40f",e.beginPath(),e.ellipse(this.x+this.width/2,this.y+this.height/2,this.width/5,this.height/5,0,0,Math.PI*2),e.fill()}getHitbox(){return{x:this.x,y:this.y,width:this.width,height:this.height}}}class ee{constructor(){this.time=0,this.clouds=[],this.trees=[],this.gravestones=[],this.lavaPools=[],this.icicles=[],this.sparkles=[],this.birds=[],this.width=800,this.groundY=420,this.currentBackground="",this.reset()}reset(){this.time=0,this.clouds=[],this.trees=[],this.gravestones=[],this.lavaPools=[],this.icicles=[],this.sparkles=[],this.birds=[]}setupForLevel(e,t,i){if(this.currentBackground!==e)switch(this.currentBackground=e,this.width=t,this.groundY=i,this.reset(),e){case"forest":this.setupForestElements();break;case"graveyard":this.setupGraveyardElements();break;case"mountains":case"skyCastle":this.setupMountainElements();break;case"iceCave":this.setupIceCaveElements();break;case"volcano":this.setupVolcanoElements();break;case"castle":this.setupCastleElements();break}}setupForestElements(){this.clouds=[{x:50,y:50,width:80,height:30,speed:.15,opacity:.6,layer:0},{x:200,y:80,width:100,height:35,speed:.2,opacity:.7,layer:1},{x:450,y:40,width:70,height:25,speed:.12,opacity:.5,layer:0},{x:600,y:90,width:90,height:32,speed:.25,opacity:.8,layer:2},{x:750,y:60,width:75,height:28,speed:.18,opacity:.65,layer:1}],this.trees=[{x:50,baseY:this.groundY,height:80,swayOffset:0,swaySpeed:1.2,swayAmount:3},{x:150,baseY:this.groundY,height:90,swayOffset:Math.PI/3,swaySpeed:1,swayAmount:4},{x:650,baseY:this.groundY,height:85,swayOffset:Math.PI/2,swaySpeed:1.3,swayAmount:3.5},{x:750,baseY:this.groundY,height:75,swayOffset:Math.PI,swaySpeed:1.1,swayAmount:2.5}],this.birds=[{x:100,y:120,speed:1.5,wingPhase:0,amplitude:15},{x:300,y:80,speed:1.2,wingPhase:Math.PI/2,amplitude:20},{x:500,y:150,speed:1.8,wingPhase:Math.PI,amplitude:12}]}setupGraveyardElements(){this.gravestones=[{x:80,y:this.groundY,height:55,wobblePhase:0},{x:200,y:this.groundY,height:40,wobblePhase:Math.PI/4},{x:350,y:this.groundY,height:70,wobblePhase:Math.PI/2},{x:500,y:this.groundY,height:45,wobblePhase:Math.PI*.75},{x:680,y:this.groundY,height:60,wobblePhase:Math.PI}],this.sparkles=[];for(let e=0;e<12;e++)this.sparkles.push({x:Math.random()*this.width,y:100+Math.random()*(this.groundY-150),phase:Math.random()*Math.PI*2,maxSize:3+Math.random()*4})}setupMountainElements(){this.clouds=[{x:30,y:60,width:100,height:40,speed:.1,opacity:.7,layer:0},{x:180,y:100,width:120,height:45,speed:.15,opacity:.8,layer:1},{x:380,y:45,width:90,height:35,speed:.08,opacity:.6,layer:0},{x:550,y:85,width:110,height:42,speed:.2,opacity:.75,layer:1},{x:720,y:55,width:85,height:32,speed:.12,opacity:.65,layer:0}],this.birds=[{x:200,y:100,speed:1,wingPhase:0,amplitude:20},{x:400,y:130,speed:.8,wingPhase:Math.PI/3,amplitude:25},{x:600,y:90,speed:1.2,wingPhase:Math.PI*.7,amplitude:18}]}setupIceCaveElements(){const e=[50,150,280,420,550,680,750];this.icicles=e.map((t,i)=>({x:t,y:80,height:40+i%3*20,dripTimer:Math.random()*200,dripPhase:Math.random()*Math.PI*2})),this.sparkles=[];for(let t=0;t<20;t++)this.sparkles.push({x:Math.random()*this.width,y:100+Math.random()*(this.groundY-150),phase:Math.random()*Math.PI*2,maxSize:2+Math.random()*3})}setupVolcanoElements(){this.lavaPools=[{x:100,y:this.groundY+30,width:80,bubbles:this.createLavaBubbles(100,this.groundY+30,80,5)},{x:600,y:this.groundY+35,width:100,bubbles:this.createLavaBubbles(600,this.groundY+35,100,6)}],this.sparkles=[];for(let e=0;e<15;e++)this.sparkles.push({x:300+Math.random()*200,y:this.groundY-200+Math.random()*100,phase:Math.random()*Math.PI*2,maxSize:2+Math.random()*4})}setupCastleElements(){this.birds=[{x:150,y:80,speed:2,wingPhase:0,amplitude:30},{x:350,y:120,speed:1.8,wingPhase:Math.PI/2,amplitude:25},{x:550,y:70,speed:2.2,wingPhase:Math.PI,amplitude:35},{x:700,y:100,speed:1.5,wingPhase:Math.PI*1.5,amplitude:28}],this.sparkles=[];for(let e=0;e<8;e++)this.sparkles.push({x:100+Math.random()*600,y:this.groundY-200+Math.random()*100,phase:Math.random()*Math.PI*2,maxSize:4+Math.random()*5})}createLavaBubbles(e,t,i,s){const a=[];for(let o=0;o<s;o++)a.push({x:e+Math.random()*i,y:t,size:3+Math.random()*5,speed:.5+Math.random()*1.5,phase:Math.random()*Math.PI*2});return a}update(e=1){this.time+=e*.016,this.clouds.forEach(t=>{t.x+=t.speed,t.x>this.width+t.width&&(t.x=-t.width)}),this.birds.forEach(t=>{t.x+=t.speed,t.wingPhase+=.2,t.x>this.width+50&&(t.x=-50)}),this.lavaPools.forEach(t=>{t.bubbles.forEach(i=>{i.phase+=i.speed*.1,i.phase>Math.PI*2&&(i.phase=0,i.x=t.x+Math.random()*t.width)})}),this.icicles.forEach(t=>{t.dripTimer+=1,t.dripTimer>180&&(t.dripTimer=0)})}drawClouds(e){this.clouds.forEach(t=>{e.fillStyle=`rgba(255, 255, 255, ${t.opacity})`;const i=t.y+Math.sin(this.time*.5+t.x*.01)*2;e.fillRect(t.x,i,t.width,t.height*.8),e.fillRect(t.x+t.width*.1,i-t.height*.3,t.width*.8,t.height*.7),e.fillRect(t.x+t.width*.2,i+t.height*.5,t.width*.6,t.height*.5)})}drawTrees(e){this.trees.forEach(t=>{const i=Math.sin(this.time*t.swaySpeed+t.swayOffset)*t.swayAmount;e.save(),e.translate(t.x+25,t.baseY-20),e.rotate(i*.02),e.fillStyle="#8b4513",e.fillRect(-10,-60,20,60),e.save(),e.rotate(i*.01),e.fillStyle="#228b22",e.beginPath(),e.moveTo(0,-t.height-60),e.lineTo(-35+i*.5,-60),e.lineTo(35+i*.5,-60),e.closePath(),e.fill(),e.fillStyle="#1e7b1e",e.beginPath(),e.moveTo(0,-t.height-40),e.lineTo(-28+i*.3,-50),e.lineTo(28+i*.3,-50),e.closePath(),e.fill(),e.restore(),e.restore()})}drawGravestones(e){this.gravestones.forEach(t=>{const i=Math.sin(this.time*.5+t.wobblePhase)*.5;e.save(),e.translate(t.x+15,t.y-20),e.rotate(i*.02),e.fillStyle="#7f8c8d",e.fillRect(-15,-t.height,30,t.height),e.beginPath(),e.arc(0,-t.height,15,Math.PI,0),e.fill(),e.fillStyle="#5d6d7e",e.fillRect(-2,-t.height+10,4,20),e.fillRect(-8,-t.height+15,16,4),e.restore()})}drawWisps(e,t="rgba(200, 200, 255, "){this.sparkles.forEach(i=>{const s=(Math.sin(this.time*2+i.phase)+1)*.5,a=i.maxSize*s,o=i.y+Math.sin(this.time*.8+i.phase)*10,n=i.x+Math.cos(this.time*.5+i.phase)*5,l=.3+s*.4;e.fillStyle=`${t}${l})`,e.beginPath(),e.arc(n,o,a,0,Math.PI*2),e.fill()})}drawIceSparkles(e){this.sparkles.forEach(t=>{const i=Math.sin(this.time*3+t.phase);if(i>.6){const s=t.maxSize*(i-.6)*2.5;e.fillStyle="#ffffff",e.fillRect(t.x-s/2,t.y-s/2,s,s)}})}drawIcicles(e){this.icicles.forEach(t=>{if(e.fillStyle="#a8d8ea",e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(t.x+10,t.y),e.lineTo(t.x+5,t.y+t.height),e.closePath(),e.fill(),e.fillStyle="#d4f1f9",e.beginPath(),e.moveTo(t.x+2,t.y),e.lineTo(t.x+5,t.y),e.lineTo(t.x+4,t.y+t.height*.7),e.closePath(),e.fill(),t.dripTimer>120&&t.dripTimer<180){const i=(t.dripTimer-120)/60,s=t.y+t.height+i*50,a=3*(1-i*.5);e.fillStyle="#a8d8ea",e.beginPath(),e.arc(t.x+5,s,a,0,Math.PI*2),e.fill()}})}drawLavaPools(e){this.lavaPools.forEach(t=>{e.fillStyle="#e74c3c",e.fillRect(t.x,t.y,t.width,20);const i=.3+Math.sin(this.time*2)*.1;e.fillStyle=`rgba(243, 156, 18, ${i})`,e.fillRect(t.x,t.y,t.width,8),t.bubbles.forEach(s=>{const a=t.y-Math.sin(s.phase)*15,o=s.size*(1-s.phase/(Math.PI*2)*.5);s.phase<Math.PI*1.8&&(e.fillStyle="#f39c12",e.beginPath(),e.arc(s.x,a,o,0,Math.PI*2),e.fill(),e.fillStyle="#f1c40f",e.beginPath(),e.arc(s.x-o*.3,a-o*.3,o*.3,0,Math.PI*2),e.fill())})})}drawEmbers(e){this.sparkles.forEach(t=>{const i=t.y-(this.time*20+t.phase*50)%250,s=t.x+Math.sin(this.time*2+t.phase)*15,a=(Math.sin(this.time*10+t.phase)+1)*.5,o=.5+a*.5,n=t.maxSize*(.5+a*.5);e.fillStyle=`rgba(255, ${100+Math.floor(a*100)}, 0, ${o})`,e.beginPath(),e.arc(s,i,n,0,Math.PI*2),e.fill()})}drawBirds(e,t=!1){this.birds.forEach(i=>{const s=Math.sin(i.wingPhase)*.5,a=i.y+Math.sin(this.time+i.x*.01)*i.amplitude*.1;e.save(),e.translate(i.x,a),t?(e.fillStyle="#1a0a2e",e.beginPath(),e.ellipse(0,0,5,3,0,0,Math.PI*2),e.fill(),e.beginPath(),e.moveTo(-3,0),e.quadraticCurveTo(-10,-8*s,-15,2),e.lineTo(-3,2),e.fill(),e.beginPath(),e.moveTo(3,0),e.quadraticCurveTo(10,-8*s,15,2),e.lineTo(3,2),e.fill()):(e.strokeStyle="#333",e.lineWidth=2,e.beginPath(),e.moveTo(-8,s*5),e.quadraticCurveTo(0,-5-s*3,8,s*5),e.stroke()),e.restore()})}getTime(){return this.time}}const w=new ee,te={id:1,name:"The Forest",background:"forest",waves:[{enemies:[h.SLIME,h.SLIME,h.SLIME]},{enemies:[h.SLIME,h.SLIME,h.GOBLIN]},{enemies:[h.GOBLIN,h.GOBLIN]}],colors:{sky:"#87ceeb",skyGradient:"#5dade2",grass:"#27ae60",grassLight:"#2ecc71",ground:"#8b4513"},mechanics:{hazards:[],modifiers:{}}},ie={id:2,name:"The Graveyard",background:"graveyard",waves:[{enemies:[h.SKELETON,h.SKELETON]},{enemies:[h.SKELETON,h.GOBLIN,h.GOBLIN]},{enemies:[h.SKELETON,h.SKELETON,h.SKELETON]}],colors:{sky:"#2c3e50",skyGradient:"#1a252f",grass:"#1e3d2f",grassLight:"#2d5a45",ground:"#4a4a4a"},mechanics:{hazards:[],modifiers:{}}},se={id:3,name:"The Mountains",background:"mountains",waves:[{enemies:[h.ORC,h.GOBLIN]},{enemies:[h.ORC,h.ORC]},{enemies:[h.ORC,h.SKELETON,h.SKELETON]}],colors:{sky:"#85929e",skyGradient:"#5d6d7e",grass:"#5d6d7e",grassLight:"#7f8c8d",ground:"#626567"},mechanics:{hazards:[],modifiers:{}}},ae={id:4,name:"Frozen Depths",background:"iceCave",waves:[{enemies:[h.SLIME,h.SLIME,h.SLIME]},{enemies:[h.GOBLIN,h.SLIME,h.GOBLIN]},{enemies:[h.GOBLIN,h.GOBLIN,h.SKELETON]},{enemies:[h.ORC,h.GOBLIN,h.GOBLIN]}],colors:{sky:"#1a3a5c",skyGradient:"#0d1f2d",grass:"#a8d8ea",grassLight:"#d4f1f9",ground:"#2d5a7b"},mechanics:{hazards:["slipperyFloor"],modifiers:{},slipperyFloor:!0,friction:.92}},oe={id:5,name:"Dragon's Lair",background:"volcano",waves:[{enemies:[h.ORC,h.ORC,h.SKELETON]},{enemies:[h.DRAGON]},{enemies:[h.DRAGON,h.ORC]}],colors:{sky:"#922b21",skyGradient:"#641e16",grass:"#7b241c",grassLight:"#943126",ground:"#4a1c1c"},mechanics:{hazards:[],modifiers:{}}},ne={id:6,name:"Sky Citadel",background:"skyCastle",waves:[{enemies:[h.GOBLIN,h.GOBLIN]},{enemies:[h.SKELETON,h.GOBLIN,h.SKELETON]},{enemies:[h.SKELETON,h.SKELETON,h.ORC]},{enemies:[h.DRAGON,h.SKELETON,h.SKELETON]},{enemies:[h.DRAGON,h.ORC,h.GOBLIN,h.GOBLIN]}],colors:{sky:"#87CEEB",skyGradient:"#E0F4FF",grass:"#DAA520",grassLight:"#FFD700",ground:"#8B7355"},mechanics:{hazards:["windGusts"],modifiers:{},windGusts:!0,windInterval:240,windForce:4}},le={id:7,name:"The Final Battle",background:"castle",waves:[{enemies:[h.DRAGON,h.ORC,h.ORC]},{enemies:[h.DRAGON,h.DRAGON]},{enemies:[h.BOSS_DRAGON]}],colors:{sky:"#4a235a",skyGradient:"#1a0a2e",grass:"#512e5f",grassLight:"#6c3483",ground:"#2e1a47"},mechanics:{hazards:[],modifiers:{}}},O=[te,ie,se,ae,oe,ne,le];class re{constructor(){this.currentLevelIndex=0,this.currentWaveIndex=0,this.enemies=[],this.projectiles=[],this.waveComplete=!1,this.waveDelay=0,this.levelComplete=!1,this.windTimer=0,this.windActive=!1,this.windDirection=1,this.windDuration=0,this.windWarning=!1}get currentLevel(){return O[this.currentLevelIndex]}get currentWave(){return this.currentLevel.waves[this.currentWaveIndex]}get isLastLevel(){return this.currentLevelIndex>=O.length-1}get isLastWave(){return this.currentWaveIndex>=this.currentLevel.waves.length-1}startLevel(e){this.currentLevelIndex=Math.min(e,O.length-1),this.currentWaveIndex=0,this.enemies=[],this.projectiles=[],this.waveComplete=!1,this.levelComplete=!1,this.windTimer=0,this.windActive=!1,this.windDirection=1,this.windDuration=0,this.windWarning=!1,w.setupForLevel(this.currentLevel.background,800,420),this.spawnWave()}spawnWave(){const e=this.currentWave,t=420,i=this.currentLevel.background;e.enemies.forEach((s,a)=>{const o=600+a*100+A(-20,20),n=new Z(o,t-60,s,i);this.enemies.push(n)}),this.waveComplete=!1}nextWave(){this.currentWaveIndex++,this.currentWaveIndex>=this.currentLevel.waves.length?this.levelComplete=!0:this.spawnWave()}nextLevel(){return this.currentLevelIndex<O.length-1?(this.currentLevelIndex++,this.currentWaveIndex=0,this.levelComplete=!1,!0):!1}update(e){w.update(),this.enemies=this.enemies.filter(t=>t.update(e,420,this.projectiles)),this.projectiles=this.projectiles.filter(t=>t.update()),this.currentLevel.mechanics?.windGusts&&this.updateWind(e),this.enemies.length===0&&!this.waveComplete&&(this.waveComplete=!0,this.waveDelay=90),this.waveComplete&&this.waveDelay>0&&(this.waveDelay--,this.waveDelay<=0&&this.nextWave())}updateWind(e){const t=this.currentLevel.mechanics?.windInterval||180,i=this.currentLevel.mechanics?.windForce||3,s=60;this.windTimer++,!this.windActive&&this.windTimer>=t-s&&(this.windWarning=!0),!this.windActive&&this.windTimer>=t&&(this.windActive=!0,this.windWarning=!1,this.windTimer=0,this.windDuration=60,this.windDirection=Math.random()>.5?1:-1),this.windActive&&(this.windDuration--,e.forEach(a=>{a&&a.health>0&&(a.x+=this.windDirection*i*.5,a.isGrounded||(a.x+=this.windDirection*i*.3),a.x=Math.max(0,Math.min(800-a.width,a.x)))}),this.windDuration<=0&&(this.windActive=!1))}drawBackground(e,t,i){const s=this.currentLevel.colors,a=420,o=e.createLinearGradient(0,0,0,a);o.addColorStop(0,s.sky),o.addColorStop(1,s.skyGradient),e.fillStyle=o,e.fillRect(0,0,t,a),this.drawBackgroundElements(e,t,a),e.fillStyle=s.grass,e.fillRect(0,a-20,t,40),e.fillStyle=s.grassLight;for(let l=0;l<t;l+=15)e.fillRect(l,a-20,10,5);e.fillStyle=s.ground,e.fillRect(0,a+20,t,i-a);const n=this.adjustColor(s.ground,20);e.fillStyle=n;for(let l=0;l<t;l+=25)e.fillRect(l+5,a+25,12,6)}drawBackgroundElements(e,t,i){switch(this.currentLevel.background){case"forest":w.drawClouds(e),w.drawTrees(e),w.drawBirds(e,!1);break;case"graveyard":w.drawGravestones(e),w.drawWisps(e,"rgba(100, 200, 100, "),this.drawMoon(e);break;case"mountains":this.drawMountains(e,t,i),w.drawClouds(e),w.drawBirds(e,!1);break;case"iceCave":this.drawIceCaveStatic(e,t,i),w.drawIcicles(e),w.drawIceSparkles(e);break;case"volcano":this.drawVolcano(e,t,i),w.drawLavaPools(e),w.drawEmbers(e);break;case"castle":this.drawCastle(e,t,i),w.drawBirds(e,!0),w.drawWisps(e,"rgba(200, 200, 255, "),this.drawMoon(e);break;case"skyCastle":this.drawSkyCastle(e,t,i),w.drawClouds(e),w.drawBirds(e,!1),this.windActive&&this.drawWindEffect(e,t,i),this.windWarning&&!this.windActive&&this.drawWindWarning(e,t);break}}drawClouds(e,t){e.fillStyle="rgba(255, 255, 255, 0.8)",[[50,50],[200,80],[450,40],[600,90],[750,60]].forEach(([s,a])=>{e.fillRect(s,a,60,25),e.fillRect(s-10,a+10,80,20)})}drawTrees(e,t,i){[50,150,650,750].forEach(a=>{e.fillStyle="#8b4513",e.fillRect(a+15,i-80,20,60),e.fillStyle="#228b22",e.beginPath(),e.moveTo(a+25,i-140),e.lineTo(a-10,i-60),e.lineTo(a+60,i-60),e.fill()})}drawGravestones(e,t,i){const s=[80,200,350,500,680];e.fillStyle="#7f8c8d",s.forEach((a,o)=>{const n=40+o%3*15;e.fillRect(a,i-n-20,30,n),e.beginPath(),e.arc(a+15,i-n-20,15,Math.PI,0),e.fill()})}drawMoon(e){e.fillStyle="#f5f5dc",e.beginPath(),e.arc(680,80,50,0,Math.PI*2),e.fill(),e.fillStyle="#e0e0c0",e.beginPath(),e.arc(670,70,10,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(695,95,8,0,Math.PI*2),e.fill()}drawMountains(e,t,i){e.fillStyle="#5d6d7e",e.beginPath(),e.moveTo(0,i-20),e.lineTo(150,i-180),e.lineTo(300,i-20),e.fill(),e.beginPath(),e.moveTo(250,i-20),e.lineTo(450,i-220),e.lineTo(650,i-20),e.fill(),e.fillStyle="#fff",e.beginPath(),e.moveTo(130,i-160),e.lineTo(150,i-180),e.lineTo(170,i-160),e.fill(),e.beginPath(),e.moveTo(420,i-195),e.lineTo(450,i-220),e.lineTo(480,i-195),e.fill()}drawIceCaveStatic(e,t,i){e.fillStyle="#1a2a3a",e.fillRect(0,0,t,80),e.fillStyle="rgba(168, 216, 234, 0.3)",e.fillRect(100,i-15,120,10),e.fillRect(400,i-15,150,10),e.fillRect(650,i-15,100,10),e.fillStyle="#0d1520",e.fillRect(0,100,30,i-100),e.fillRect(t-25,120,25,i-120)}drawVolcano(e,t,i){e.fillStyle="#4a1c1c",e.beginPath(),e.moveTo(250,i-20),e.lineTo(400,i-200),e.lineTo(550,i-20),e.fill(),e.fillStyle="#e74c3c",e.beginPath(),e.moveTo(370,i-190),e.lineTo(400,i-200),e.lineTo(430,i-190),e.lineTo(420,i-170),e.lineTo(380,i-170),e.fill(),e.fillStyle="#f39c12",e.beginPath(),e.arc(400,i-180,15+Math.sin(Date.now()/200)*3,0,Math.PI*2),e.fill()}drawLava(e,t,i){e.fillStyle="#e74c3c",e.fillRect(100,i+30,80,20),e.fillRect(600,i+35,100,15),e.fillStyle="#f39c12";const s=Date.now()/300;e.beginPath(),e.arc(130+Math.sin(s)*10,i+35,5,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(650+Math.cos(s)*15,i+40,4,0,Math.PI*2),e.fill()}drawCastle(e,t,i){e.fillStyle="#1a0a2e",e.fillRect(100,i-200,60,180),e.fillRect(640,i-200,60,180),e.beginPath(),e.moveTo(100,i-200),e.lineTo(130,i-250),e.lineTo(160,i-200),e.fill(),e.beginPath(),e.moveTo(640,i-200),e.lineTo(670,i-250),e.lineTo(700,i-200),e.fill(),e.fillRect(200,i-150,400,130),e.fillStyle="#f39c12",e.fillRect(120,i-150,20,30),e.fillRect(660,i-150,20,30),e.fillRect(350,i-120,30,40),e.fillRect(420,i-120,30,40);for(let s=0;s<10;s++)e.fillStyle="#1a0a2e",e.fillRect(200+s*40,i-170,25,25)}drawSkyCastle(e,t,i){const s=Date.now()/1e3;e.fillStyle="rgba(255, 255, 255, 0.6)",[[50,60],[200,90],[400,50],[600,80],[750,70]].forEach(([o,n])=>{const l=Date.now()/100%t,u=(o+l*.1)%t;e.fillRect(u,n,80,30),e.fillRect(u+10,n-10,60,25),e.fillRect(u+20,n+15,50,20)}),e.fillStyle="#8B7355",e.beginPath(),e.ellipse(150,i-100,60,20,0,0,Math.PI*2),e.fill(),e.fillStyle="#228B22",e.fillRect(130,i-115,40,15),e.fillStyle="#8B7355",e.beginPath(),e.ellipse(650,i-150,40,15,0,0,Math.PI*2),e.fill(),e.fillStyle="#4a4a6a",e.fillRect(680,i-250,40,150),e.fillRect(720,i-200,30,100),e.beginPath(),e.moveTo(680,i-250),e.lineTo(700,i-290),e.lineTo(720,i-250),e.fill(),e.fillStyle="#FFD700",e.fillRect(695,i-220,10,15),e.fillRect(695,i-180,10,15),e.strokeStyle="#333",e.lineWidth=2;for(let o=0;o<3;o++){const n=(300+o*100+s*20)%(t+50)-25,l=100+Math.sin(s+o)*20+o*30;e.beginPath(),e.moveTo(n-8,l),e.quadraticCurveTo(n,l-5,n+8,l),e.stroke()}e.fillStyle="#FFD700",e.beginPath(),e.arc(700,60,30,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(255, 215, 0, 0.3)",e.lineWidth=3;for(let o=0;o<8;o++){const n=o/8*Math.PI*2+s*.1;e.beginPath(),e.moveTo(700+Math.cos(n)*35,60+Math.sin(n)*35),e.lineTo(700+Math.cos(n)*55,60+Math.sin(n)*55),e.stroke()}}drawWindEffect(e,t,i){e.strokeStyle="rgba(255, 255, 255, 0.5)",e.lineWidth=2;const s=this.windDirection;for(let a=0;a<20;a++){const o=s>0?a*40%t:t-a*40%t,n=100+a*37%(i-150),l=20+Math.random()*30;e.beginPath(),e.moveTo(o,n),e.lineTo(o+s*l,n+Math.sin(Date.now()/100+a)*5),e.stroke()}e.fillStyle="rgba(139, 115, 85, 0.6)";for(let a=0;a<10;a++){const o=(Date.now()/10*s+a*80)%(t+100)-50,n=150+a*47%(i-200),l=Date.now()/200+a;e.save(),e.translate(o,n),e.rotate(l),e.fillRect(-4,-2,8,4),e.restore()}}drawWindWarning(e,t){const i=.5+Math.sin(Date.now()/100)*.3;e.fillStyle=`rgba(255, 255, 0, ${i})`,e.font="bold 24px Arial",e.textAlign="center",e.fillText("WIND INCOMING!",t/2,50),e.strokeStyle=`rgba(255, 255, 0, ${i})`,e.lineWidth=3,e.beginPath(),e.moveTo(t/2-80,70),e.lineTo(t/2-100,70),e.lineTo(t/2-90,60),e.moveTo(t/2-100,70),e.lineTo(t/2-90,80),e.stroke(),e.beginPath(),e.moveTo(t/2+80,70),e.lineTo(t/2+100,70),e.lineTo(t/2+90,60),e.moveTo(t/2+100,70),e.lineTo(t/2+90,80),e.stroke()}adjustColor(e,t){const i=parseInt(e.slice(1),16),s=Math.min(255,(i>>16&255)+t),a=Math.min(255,(i>>8&255)+t),o=Math.min(255,(i&255)+t);return`rgb(${s}, ${a}, ${o})`}draw(e){this.enemies.forEach(t=>t.draw(e)),this.projectiles.forEach(t=>t.draw(e))}}function he(f){return"effect"in f}function H(f){return"tier"in f}const W={sword:[{tier:p.BASIC,price:0,name:"Wooden Sword",description:"A basic training sword"},{tier:p.IRON,price:100,name:"Iron Sword",description:"+25% damage"},{tier:p.STEEL,price:250,name:"Steel Sword",description:"+50% damage"},{tier:p.GOLD,price:500,name:"Golden Blade",description:"+75% damage"},{tier:p.DIAMOND,price:1e3,name:"Diamond Edge",description:"+100% damage"},{tier:p.LEGENDARY,price:2e3,name:"Excalibur",description:"+150% damage"}],armor:[{tier:p.BASIC,price:0,name:"Cloth Armor",description:"Basic protection"},{tier:p.IRON,price:120,name:"Iron Armor",description:"+25% max HP"},{tier:p.STEEL,price:300,name:"Steel Plate",description:"+50% max HP"},{tier:p.GOLD,price:600,name:"Golden Mail",description:"+75% max HP"},{tier:p.DIAMOND,price:1200,name:"Diamond Armor",description:"+100% max HP"},{tier:p.LEGENDARY,price:2500,name:"Dragon Scale",description:"+150% max HP"}],helmet:[{tier:p.BASIC,price:0,name:"Leather Cap",description:"Basic headwear"},{tier:p.IRON,price:80,name:"Iron Helm",description:"+25% defense"},{tier:p.STEEL,price:200,name:"Steel Helm",description:"+50% defense"},{tier:p.GOLD,price:400,name:"Golden Crown",description:"+75% defense"},{tier:p.DIAMOND,price:800,name:"Diamond Visor",description:"+100% defense"},{tier:p.LEGENDARY,price:1800,name:"Helm of Ages",description:"+150% defense"}],boots:[{tier:p.BASIC,price:0,name:"Sandals",description:"Basic footwear"},{tier:p.IRON,price:60,name:"Iron Boots",description:"+5% speed"},{tier:p.STEEL,price:150,name:"Steel Greaves",description:"+10% speed"},{tier:p.GOLD,price:350,name:"Golden Steps",description:"+15% speed"},{tier:p.DIAMOND,price:700,name:"Diamond Dash",description:"+20% speed"},{tier:p.LEGENDARY,price:1500,name:"Hermes Wings",description:"+30% speed"}]},de=[{id:"health_potion",name:"Health Potion",price:30,description:"Restore 50 HP",effect:f=>f.heal(50)},{id:"full_heal",name:"Full Restore",price:100,description:"Restore all HP",effect:f=>f.heal(f.maxHealth)}];class ue{constructor(){this.selectedCategory=0,this.selectedItem=0,this.categories=["sword","armor","helmet","boots","items"],this.message="",this.messageTimer=0}getAvailableUpgrades(e,t){if(t==="items")return de;const i=W[t],s=e.equipment[t],a=i.findIndex(o=>o.tier.name===s.name);return i.slice(a+1,a+4)}getCurrentEquipment(e,t){if(t==="items")return null;const i=W[t],s=e.equipment[t];return i.find(a=>a.tier.name===s.name)}canAfford(e,t){return e.gold>=t.price}purchase(e,t,i){return this.canAfford(e,i)?(e.gold-=i.price,he(i)?(i.effect(e),this.showMessage(`Used ${i.name}!`)):H(i)&&(e.equipment[t]=i.tier,e.calculateStats(),this.showMessage(`Equipped ${i.name}!`)),!0):(this.showMessage("Not enough gold!"),!1)}showMessage(e){this.message=e,this.messageTimer=120}update(e,t){this.messageTimer>0&&this.messageTimer--,e.isMenuLeft()&&(this.selectedCategory=(this.selectedCategory-1+this.categories.length)%this.categories.length,this.selectedItem=0),e.isMenuRight()&&(this.selectedCategory=(this.selectedCategory+1)%this.categories.length,this.selectedItem=0);const i=this.categories[this.selectedCategory],s=this.getAvailableUpgrades(t,i);if(e.isMenuUp()&&(this.selectedItem=Math.max(0,this.selectedItem-1)),e.isMenuDown()&&(this.selectedItem=Math.min(s.length-1,this.selectedItem+1)),e.isConfirm()&&s.length>0){const a=s[this.selectedItem];a&&this.purchase(t,i,a)}return!e.isCancel()}draw(e,t,i,s){e.fillStyle="rgba(0, 0, 0, 0.85)",e.fillRect(0,0,i,s),e.fillStyle="#ffd700",e.font='28px "Press Start 2P", monospace',e.textAlign="center",e.fillText("SHOP",i/2,50),e.fillStyle="#ffd700",e.font='14px "Press Start 2P", monospace',e.textAlign="right",e.fillText(`Gold: ${t.gold}`,i-30,50);const a=140,o=(i-a*this.categories.length)/2;e.font='12px "Press Start 2P", monospace',this.categories.forEach((c,m)=>{const g=o+m*a,S=m===this.selectedCategory;e.fillStyle=S?"#3498db":"#2c3e50",e.fillRect(g,80,a-5,35),e.fillStyle=S?"#fff":"#7f8c8d",e.textAlign="center",e.fillText(c.toUpperCase(),g+a/2-2,103)});const n=this.categories[this.selectedCategory],l=this.getCurrentEquipment(t,n);l&&(e.fillStyle="#2c3e50",e.fillRect(50,130,300,80),e.fillStyle="#95a5a6",e.font='10px "Press Start 2P", monospace',e.textAlign="left",e.fillText("EQUIPPED:",60,155),e.fillStyle=l.tier.color,e.font='12px "Press Start 2P", monospace',e.fillText(l.name,60,180),e.fillStyle="#7f8c8d",e.font='10px "Press Start 2P", monospace',e.fillText(l.description,60,200)),e.fillStyle="#2c3e50",e.fillRect(450,130,300,80),e.fillStyle="#fff",e.font='10px "Press Start 2P", monospace',e.textAlign="left",e.fillText(`DMG: ${t.damage}`,460,155),e.fillText(`HP: ${t.health}/${t.maxHealth}`,460,175),e.fillText(`DEF: ${t.defense}`,460,195),e.fillText(`LVL: ${t.level}`,600,155),e.fillText(`EXP: ${t.exp}/${t.expToNextLevel}`,600,175);const u=this.getAvailableUpgrades(t,n);e.fillStyle="#1a1a2e",e.fillRect(50,230,700,220),u.length===0?(e.fillStyle="#7f8c8d",e.font='14px "Press Start 2P", monospace',e.textAlign="center",e.fillText("No upgrades available",i/2,340),e.fillText("(Max level reached!)",i/2,370)):u.forEach((c,m)=>{const g=255+m*60,S=m===this.selectedItem,k=this.canAfford(t,c);S&&(e.fillStyle="rgba(52, 152, 219, 0.3)",e.fillRect(55,g-20,690,55)),e.fillStyle=H(c)?c.tier.color:"#3498db",k||(e.fillStyle="#e74c3c"),e.font='12px "Press Start 2P", monospace',e.textAlign="left",e.fillText(c.name,70,g),e.fillStyle="#7f8c8d",e.font='10px "Press Start 2P", monospace',e.fillText(c.description,70,g+20),e.fillStyle=k?"#ffd700":"#e74c3c",e.textAlign="right",e.fillText(`${c.price} G`,720,g)}),this.messageTimer>0&&(e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(i/2-150,s/2-30,300,60),e.fillStyle="#2ecc71",e.font='14px "Press Start 2P", monospace',e.textAlign="center",e.fillText(this.message,i/2,s/2+5)),e.fillStyle="#5d6d7e",e.font='10px "Press Start 2P", monospace',e.textAlign="center",e.fillText("  Categories |   Select | ENTER Buy | ESC Exit",i/2,s-20)}}class fe{constructor(){this.stars=[],this.shootingStars=[],this.magicParticles=[],this.fireflies=[],this.lastShootingStarTime=0,this.auroraOffset=0,this.initialized=!1,this.menuSelection=0,this.menuOptions=["Start Game","2 Player Co-op"]}initMenuBackground(){if(!this.initialized){this.initialized=!0;for(let e=0;e<3;e++){const t=e===0?100:e===1?60:30;for(let i=0;i<t;i++)this.stars.push({x:Math.random()*r,y:Math.random()*d*.7,size:e===0?1:e===1?1.5:2.5,speed:(e+1)*.15,twinkleOffset:Math.random()*Math.PI*2,layer:e})}for(let e=0;e<15;e++){const t=Math.random()*r,i=d*.5+Math.random()*d*.4;this.fireflies.push({x:t,y:i,baseX:t,baseY:i,phase:Math.random()*Math.PI*2,speed:.5+Math.random()*1,brightness:Math.random()})}}}updateMenuBackground(){const e=Date.now();if(this.stars.forEach(t=>{t.x-=t.speed,t.x<0&&(t.x=r,t.y=Math.random()*d*.7)}),e-this.lastShootingStarTime>3e3+Math.random()*4e3&&this.shootingStars.length<3&&(this.shootingStars.push({x:Math.random()*r*.5+r*.25,y:Math.random()*100,vx:8+Math.random()*4,vy:3+Math.random()*2,length:50+Math.random()*50,life:60+Math.random()*40,maxLife:60+Math.random()*40}),this.lastShootingStarTime=e),this.shootingStars=this.shootingStars.filter(t=>(t.x+=t.vx,t.y+=t.vy,t.life--,t.life>0&&t.x<r+100)),Math.random()<.1){const t=["#ffd700","#ff6b6b","#4ecdc4","#9b59b6","#3498db"];this.magicParticles.push({x:r*.5+(Math.random()-.5)*100,y:d*.45,vx:(Math.random()-.5)*2,vy:-1-Math.random()*2,size:2+Math.random()*3,color:t[Math.floor(Math.random()*t.length)],life:80+Math.random()*40,maxLife:80+Math.random()*40})}this.magicParticles=this.magicParticles.filter(t=>(t.x+=t.vx,t.y+=t.vy,t.vy-=.02,t.vx*=.99,t.life--,t.life>0)),this.fireflies.forEach(t=>{t.phase+=.02*t.speed,t.x=t.baseX+Math.sin(t.phase)*30,t.y=t.baseY+Math.cos(t.phase*.7)*20,t.brightness=.3+Math.sin(t.phase*3)*.35+.35}),this.auroraOffset+=.005}drawMenuBackground(e){const t=Date.now(),i=e.createLinearGradient(0,0,0,d);i.addColorStop(0,"#0a0520"),i.addColorStop(.3,"#0f0c29"),i.addColorStop(.6,"#1a1040"),i.addColorStop(1,"#0d1b2a"),e.fillStyle=i,e.fillRect(0,0,r,d),this.drawAurora(e),this.drawNebula(e,t),this.stars.forEach(s=>{const a=Math.sin(t/300+s.twinkleOffset)*.5+.5,o=.3+a*.7,n=s.size*(.8+a*.4);e.globalAlpha=o,e.fillStyle=s.layer===2?"#ffffd0":"#ffffff",e.beginPath(),e.arc(s.x,s.y,n,0,Math.PI*2),e.fill(),s.layer===2&&(e.globalAlpha=o*.3,e.beginPath(),e.arc(s.x,s.y,n*3,0,Math.PI*2),e.fill())}),e.globalAlpha=1,this.shootingStars.forEach(s=>{const a=s.life/s.maxLife,o=e.createLinearGradient(s.x,s.y,s.x-s.vx*(s.length/10),s.y-s.vy*(s.length/10));o.addColorStop(0,`rgba(255, 255, 255, ${a})`),o.addColorStop(1,"rgba(255, 255, 255, 0)"),e.strokeStyle=o,e.lineWidth=2,e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(s.x-s.vx*(s.length/10),s.y-s.vy*(s.length/10)),e.stroke(),e.globalAlpha=a,e.fillStyle="#fff",e.beginPath(),e.arc(s.x,s.y,2,0,Math.PI*2),e.fill(),e.globalAlpha=1}),this.drawMountains(e),this.drawCastle(e,t),this.drawGround(e,t),this.magicParticles.forEach(s=>{const a=s.life/s.maxLife;e.globalAlpha=a,e.fillStyle=s.color,e.beginPath(),e.arc(s.x,s.y,s.size,0,Math.PI*2),e.fill(),e.globalAlpha=a*.4,e.beginPath(),e.arc(s.x,s.y,s.size*2.5,0,Math.PI*2),e.fill()}),e.globalAlpha=1,this.fireflies.forEach(s=>{e.globalAlpha=s.brightness,e.fillStyle="#ffff88",e.beginPath(),e.arc(s.x,s.y,2,0,Math.PI*2),e.fill(),e.globalAlpha=s.brightness*.3;const a=e.createRadialGradient(s.x,s.y,0,s.x,s.y,15);a.addColorStop(0,"rgba(255, 255, 100, 0.5)"),a.addColorStop(1,"rgba(255, 255, 100, 0)"),e.fillStyle=a,e.beginPath(),e.arc(s.x,s.y,15,0,Math.PI*2),e.fill()}),e.globalAlpha=1}drawAurora(e){e.globalAlpha=.15;for(let t=0;t<3;t++){const i=Math.sin(this.auroraOffset+t*.5)*30,s=e.createLinearGradient(0,50+t*40+i,0,150+t*40+i);t===0?(s.addColorStop(0,"rgba(0, 255, 150, 0)"),s.addColorStop(.5,"rgba(0, 255, 150, 0.8)"),s.addColorStop(1,"rgba(0, 255, 150, 0)")):t===1?(s.addColorStop(0,"rgba(150, 0, 255, 0)"),s.addColorStop(.5,"rgba(150, 0, 255, 0.6)"),s.addColorStop(1,"rgba(150, 0, 255, 0)")):(s.addColorStop(0,"rgba(0, 150, 255, 0)"),s.addColorStop(.5,"rgba(0, 150, 255, 0.5)"),s.addColorStop(1,"rgba(0, 150, 255, 0)")),e.fillStyle=s,e.beginPath(),e.moveTo(0,80+t*30+i);for(let a=0;a<=r;a+=20){const o=Math.sin(a*.01+this.auroraOffset*2+t)*20;e.lineTo(a,100+t*30+i+o)}e.lineTo(r,200+t*30),e.lineTo(0,200+t*30),e.closePath(),e.fill()}e.globalAlpha=1}drawNebula(e,t){e.globalAlpha=.08,["#ff6b6b","#9b59b6","#3498db"].forEach((s,a)=>{const o=150+a*250+Math.sin(t/5e3+a)*30,n=100+Math.cos(t/4e3+a*2)*20,l=80+Math.sin(t/3e3+a)*20,u=e.createRadialGradient(o,n,0,o,n,l);u.addColorStop(0,s),u.addColorStop(1,"transparent"),e.fillStyle=u,e.beginPath(),e.arc(o,n,l,0,Math.PI*2),e.fill()}),e.globalAlpha=1}drawMountains(e){e.fillStyle="#1a1030",e.beginPath(),e.moveTo(0,d*.65),e.lineTo(80,d*.45),e.lineTo(150,d*.55),e.lineTo(250,d*.35),e.lineTo(350,d*.5),e.lineTo(450,d*.4),e.lineTo(550,d*.48),e.lineTo(650,d*.38),e.lineTo(750,d*.52),e.lineTo(r,d*.45),e.lineTo(r,d),e.lineTo(0,d),e.closePath(),e.fill(),e.fillStyle="#120a20",e.beginPath(),e.moveTo(0,d*.7),e.lineTo(100,d*.55),e.lineTo(200,d*.62),e.lineTo(300,d*.5),e.lineTo(400,d*.58),e.lineTo(500,d*.52),e.lineTo(600,d*.6),e.lineTo(700,d*.54),e.lineTo(r,d*.6),e.lineTo(r,d),e.lineTo(0,d),e.closePath(),e.fill()}drawCastle(e,t){const i=r*.5,s=d*.68;e.fillStyle="#0a0515",e.fillRect(i-80,s-100,160,100),e.fillRect(i-25,s-200,50,200),e.beginPath(),e.moveTo(i-30,s-200),e.lineTo(i,s-250),e.lineTo(i+30,s-200),e.closePath(),e.fill(),e.fillRect(i-100,s-140,35,140),e.beginPath(),e.moveTo(i-105,s-140),e.lineTo(i-82.5,s-175),e.lineTo(i-60,s-140),e.closePath(),e.fill(),e.fillRect(i+65,s-140,35,140),e.beginPath(),e.moveTo(i+60,s-140),e.lineTo(i+82.5,s-175),e.lineTo(i+105,s-140),e.closePath(),e.fill(),e.fillRect(i-130,s-90,25,90),e.beginPath(),e.moveTo(i-135,s-90),e.lineTo(i-117.5,s-115),e.lineTo(i-100,s-90),e.closePath(),e.fill(),e.fillRect(i+105,s-90,25,90),e.beginPath(),e.moveTo(i+100,s-90),e.lineTo(i+117.5,s-115),e.lineTo(i+135,s-90),e.closePath(),e.fill();for(let l=-70;l<=70;l+=20)e.fillRect(i+l-7,s-110,14,15);const a=.5+Math.sin(t/500)*.3;e.fillStyle=`rgba(255, 200, 100, ${a})`,e.fillRect(i-8,s-180,6,10),e.fillRect(i+2,s-180,6,10),e.fillRect(i-5,s-150,10,15),e.fillRect(i-90,s-120,8,12),e.fillRect(i+80,s-120,8,12);for(let l=-50;l<=30;l+=40)e.fillRect(i+l,s-70,12,20);const o=e.createLinearGradient(i-20,s-50,i-20,s);o.addColorStop(0,`rgba(255, 150, 50, ${a*.8})`),o.addColorStop(1,"rgba(255, 150, 50, 0)"),e.fillStyle=o,e.fillRect(i-20,s-50,40,50),e.fillStyle="#8b0000";const n=Math.sin(t/200)*5;e.beginPath(),e.moveTo(i,s-250),e.lineTo(i+25+n,s-240),e.lineTo(i+20+n*.5,s-230),e.lineTo(i,s-235),e.closePath(),e.fill(),e.strokeStyle="#333",e.lineWidth=2,e.beginPath(),e.moveTo(i,s-250),e.lineTo(i,s-265),e.stroke()}drawGround(e,t){const i=e.createLinearGradient(0,d*.68,0,d);i.addColorStop(0,"#0a0515"),i.addColorStop(.3,"#0d0820"),i.addColorStop(1,"#05030a"),e.fillStyle=i,e.fillRect(0,d*.68,r,d*.32),e.globalAlpha=.15;for(let s=0;s<5;s++){const a=(s*200+t/30)%(r+200)-100,o=d*.65+Math.sin(t/1e3+s)*10,n=e.createRadialGradient(a,o,0,a,o,80);n.addColorStop(0,"rgba(150, 150, 200, 0.5)"),n.addColorStop(1,"transparent"),e.fillStyle=n,e.beginPath(),e.arc(a,o,80,0,Math.PI*2),e.fill()}e.globalAlpha=1,e.fillStyle="#0a0515";for(let s=0;s<r;s+=8){const a=5+Math.sin(s*.1)*3+Math.sin(t/500+s*.05)*2;e.fillRect(s,d*.68-a,2,a)}}drawMenu(e){this.initMenuBackground(),this.updateMenuBackground(),this.drawMenuBackground(e);const t=Date.now();e.textAlign="center";const i=r/2-220,s=60,a=440,o=330,n=e.createLinearGradient(i,s,i,s+o);n.addColorStop(0,"rgba(10, 5, 30, 0.85)"),n.addColorStop(.5,"rgba(15, 10, 40, 0.9)"),n.addColorStop(1,"rgba(10, 5, 30, 0.85)"),e.fillStyle=n;const l=15;e.beginPath(),e.moveTo(i+l,s),e.lineTo(i+a-l,s),e.quadraticCurveTo(i+a,s,i+a,s+l),e.lineTo(i+a,s+o-l),e.quadraticCurveTo(i+a,s+o,i+a-l,s+o),e.lineTo(i+l,s+o),e.quadraticCurveTo(i,s+o,i,s+o-l),e.lineTo(i,s+l),e.quadraticCurveTo(i,s,i+l,s),e.closePath(),e.fill(),e.strokeStyle="rgba(100, 80, 150, 0.6)",e.lineWidth=2,e.stroke(),e.strokeStyle="rgba(150, 120, 200, 0.3)",e.lineWidth=1,e.beginPath(),e.moveTo(i+l+10,s+2),e.lineTo(i+a-l-10,s+2),e.stroke();const u=100+Math.sin(t/500)*3;e.shadowColor="#ffd700",e.shadowBlur=25,e.fillStyle="#ffd700",e.font="bold 28px monospace",e.fillText("RETRO GAME JAM",r/2,u),e.shadowColor="#ff4444",e.shadowBlur=35,e.fillStyle="#ff6b6b",e.font="bold 44px monospace",e.fillText("GO NUTS!",r/2,u+55),e.shadowColor="#4ecdc4",e.shadowBlur=20,e.fillStyle="#4ecdc4",e.font="bold 13px monospace",e.fillText("DRAGON SLAYER ADVENTURE",r/2,u+95),e.shadowBlur=0;const c=u+115,m=e.createLinearGradient(r/2-120,c,r/2+120,c);m.addColorStop(0,"rgba(78, 205, 196, 0)"),m.addColorStop(.3,"rgba(78, 205, 196, 0.5)"),m.addColorStop(.5,"rgba(78, 205, 196, 0.8)"),m.addColorStop(.7,"rgba(78, 205, 196, 0.5)"),m.addColorStop(1,"rgba(78, 205, 196, 0)"),e.strokeStyle=m,e.lineWidth=2,e.beginPath(),e.moveTo(r/2-120,c),e.lineTo(r/2+120,c),e.stroke(),e.font="bold 20px monospace",this.menuOptions.forEach((g,S)=>{const k=270+S*55,E=S===this.menuSelection;if(E){const D=.4+Math.sin(t/200)*.15,v=r/2-140,C=k-20,R=280,G=42,P=8;e.fillStyle=`rgba(52, 152, 219, ${D})`,e.beginPath(),e.moveTo(v+P,C),e.lineTo(v+R-P,C),e.quadraticCurveTo(v+R,C,v+R,C+P),e.lineTo(v+R,C+G-P),e.quadraticCurveTo(v+R,C+G,v+R-P,C+G),e.lineTo(v+P,C+G),e.quadraticCurveTo(v,C+G,v,C+G-P),e.lineTo(v,C+P),e.quadraticCurveTo(v,C,v+P,C),e.closePath(),e.fill(),e.strokeStyle="#5dade2",e.lineWidth=2,e.shadowColor="#3498db",e.shadowBlur=15,e.stroke(),e.shadowBlur=0,e.fillStyle="#ffd700",e.shadowColor="#ffd700",e.shadowBlur=10;const q=Math.sin(t/150)*6;e.font="bold 24px monospace",e.fillText(">",r/2-115+q,k+7),e.fillText("<",r/2+115-q,k+7),e.shadowBlur=0,e.font="bold 20px monospace"}e.shadowColor="rgba(0, 0, 0, 0.8)",e.shadowBlur=4,e.shadowOffsetX=2,e.shadowOffsetY=2,e.fillStyle=E?"#ffffff":"rgba(160, 160, 180, 0.8)",e.fillText(g,r/2,k+7),e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0}),e.font="12px monospace",e.fillStyle="rgba(120, 130, 150, 0.9)",e.shadowColor="rgba(0, 0, 0, 0.5)",e.shadowBlur=3,e.fillText("UP/DOWN Select  |  ENTER/SPACE Start",r/2,d-70),e.shadowBlur=0,e.font="10px monospace",e.fillStyle="#ffd700",e.fillText("B = Shop (Buy)",r/2-80,d-45),e.fillStyle="#2ecc71",e.fillText("K = Skills",r/2+80,d-45),e.fillStyle="rgba(80, 80, 120, 0.7)",e.font="12px monospace",e.fillText("Retro Game Jam 2024",r/2,d-20)}drawHUD(e,t,i){const s=i.currentLevel,a=i.currentWaveIndex+1,o=s.waves.length;e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(10,10,250,30),e.fillStyle="#ffd700",e.font='12px "Press Start 2P", monospace',e.textAlign="left",e.fillText(`${s.name}`,20,30),e.fillStyle="#fff",e.font='10px "Press Start 2P", monospace',e.fillText(`Wave ${a}/${o}`,180,30),t.forEach((n,l)=>{if(!n)return;const u=10+l*200,c=50,m=180,g=25;e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(u,c,m,g+20),e.fillStyle=l===0?"#ff6b6b":"#4ecdc4",e.font='10px "Press Start 2P", monospace',e.textAlign="left",e.fillText(`P${l+1} LV${n.level}`,u+5,c+12),e.fillStyle="#ffd700",e.textAlign="right",e.fillText(`${n.gold}G`,u+m-5,c+12),e.fillStyle="#333",e.fillRect(u+5,c+18,m-10,12);const S=n.health/n.maxHealth,k=S>.5?"#2ecc71":S>.25?"#f1c40f":"#e74c3c";e.fillStyle=k,e.fillRect(u+6,c+19,(m-12)*S,10),e.fillStyle="#fff",e.font='8px "Press Start 2P", monospace',e.textAlign="center",e.fillText(`${Math.ceil(n.health)}/${n.maxHealth}`,u+m/2,c+28),e.fillStyle="#1a1a2e",e.fillRect(u+5,c+32,m-10,6),e.fillStyle="#9b59b6";const E=n.exp/n.expToNextLevel;e.fillRect(u+6,c+33,(m-12)*E,4)}),i.waveComplete&&i.waveDelay>60&&(e.fillStyle="rgba(0, 0, 0, 0.6)",e.fillRect(0,d/2-40,r,80),e.fillStyle="#2ecc71",e.font='20px "Press Start 2P", monospace',e.textAlign="center",e.fillText("WAVE COMPLETE!",r/2,d/2),e.fillStyle="#fff",e.font='12px "Press Start 2P", monospace',e.fillText("Next wave incoming...",r/2,d/2+25))}drawLevelComplete(e,t,i){e.fillStyle="rgba(0, 0, 0, 0.85)",e.fillRect(0,0,r,d),e.fillStyle="#ffd700",e.font='32px "Press Start 2P", monospace',e.textAlign="center",e.fillText("LEVEL COMPLETE!",r/2,100),e.fillStyle="#2ecc71",e.font='20px "Press Start 2P", monospace',e.fillText(t.currentLevel.name,r/2,150),e.fillStyle="#fff",e.font='14px "Press Start 2P", monospace',e.fillText("All enemies defeated!",r/2,200);const s=t.currentLevelIndex===0;s&&(e.fillStyle="rgba(52, 152, 219, 0.3)",e.fillRect(r/2-200,230,400,100),e.strokeStyle="#3498db",e.lineWidth=2,e.strokeRect(r/2-200,230,400,100),e.fillStyle="#ffd700",e.font='12px "Press Start 2P", monospace',e.fillText("TIP: Upgrade your hero!",r/2,255),e.fillStyle="#fff",e.font='10px "Press Start 2P", monospace',e.fillText("B = Shop (spend gold on gear)",r/2,280),e.fillText("K = Skill Tree (spend skill points)",r/2,300),e.fillText("Earn skill points by leveling up!",r/2,320));const a=Math.floor(Date.now()/500)%2;return e.fillStyle=a?"#4ecdc4":"#3498db",e.font='16px "Press Start 2P", monospace',e.fillText("Press ENTER to continue",r/2,s?370:300),e.fillStyle="#7f8c8d",e.font='12px "Press Start 2P", monospace',e.fillText("B = Shop | K = Skill Tree",r/2,s?400:340),i.isConfirm()?"continue":i.isDown("b")||i.isDown("KeyB")?"shop":i.isDown("k")||i.isDown("KeyK")?"skillTree":null}drawGameOver(e,t){return e.fillStyle="rgba(100, 0, 0, 0.9)",e.fillRect(0,0,r,d),e.fillStyle="#e74c3c",e.font='48px "Press Start 2P", monospace',e.textAlign="center",e.fillText("GAME OVER",r/2,180),e.fillStyle="#fff",e.font='16px "Press Start 2P", monospace',e.fillText("The heroes have fallen...",r/2,250),Math.floor(Date.now()/500)%2&&(e.fillStyle="#ffd700",e.font='14px "Press Start 2P", monospace',e.fillText("Press ENTER to try again",r/2,350)),t.isConfirm()}drawVictory(e,t){e.fillStyle="rgba(0, 50, 0, 0.9)",e.fillRect(0,0,r,d),e.fillStyle="#ffd700";for(let s=0;s<30;s++){const a=(s*67+Date.now()/20)%r,o=(s*43+Date.now()/30)%d;e.fillRect(a,o,6,6)}e.fillStyle="#ff6b6b";for(let s=0;s<20;s++){const a=(s*89+Date.now()/25)%r,o=(s*51+Date.now()/35)%d;e.fillRect(a,o,5,5)}return e.fillStyle="#ffd700",e.font='40px "Press Start 2P", monospace',e.textAlign="center",e.fillText("VICTORY!",r/2,150),e.fillStyle="#2ecc71",e.font='20px "Press Start 2P", monospace',e.fillText("The Dragon King is defeated!",r/2,220),e.fillStyle="#fff",e.font='14px "Press Start 2P", monospace',e.fillText("Peace has returned to the land.",r/2,280),e.fillText("Thank you for playing!",r/2,310),Math.floor(Date.now()/500)%2&&(e.fillStyle="#4ecdc4",e.font='12px "Press Start 2P", monospace',e.fillText("Press ENTER to play again",r/2,400)),t.isConfirm()}drawPauseOverlay(e){e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(0,0,r,d),e.fillStyle="#fff",e.font='32px "Press Start 2P", monospace',e.textAlign="center",e.fillText("PAUSED",r/2,d/2-40),e.font='14px "Press Start 2P", monospace',e.fillText("Press ESC to resume",r/2,d/2+10),e.fillStyle="#ffd700",e.font='12px "Press Start 2P", monospace',e.fillText("B = Shop (gold)",r/2,d/2+50),e.fillStyle="#2ecc71",e.fillText("K = Skill Tree (skill points)",r/2,d/2+75)}}const N={C3:130.81,"C#3":138.59,D3:146.83,"D#3":155.56,E3:164.81,F3:174.61,"F#3":185,G3:196,"G#3":207.65,A3:220,"A#3":233.08,B3:246.94,C4:261.63,"C#4":277.18,D4:293.66,"D#4":311.13,E4:329.63,F4:349.23,"F#4":369.99,G4:392,"G#4":415.3,A4:440,"A#4":466.16,B4:493.88,C5:523.25,"C#5":554.37,D5:587.33,"D#5":622.25,E5:659.25,F5:698.46,"F#5":739.99,G5:783.99,"G#5":830.61,A5:880,"A#5":932.33,B5:987.77,C6:1046.5,REST:0},K={name:"menu",bpm:100,melody:[{note:"G4",duration:1},{note:"G4",duration:.5},{note:"A4",duration:.5},{note:"B4",duration:1},{note:"G4",duration:1},{note:"C5",duration:1.5},{note:"B4",duration:.5},{note:"A4",duration:2},{note:"G4",duration:1},{note:"G4",duration:.5},{note:"A4",duration:.5},{note:"B4",duration:1},{note:"D5",duration:1},{note:"C5",duration:2},{note:"REST",duration:2}],bass:[{note:"G3",duration:2},{note:"G3",duration:2},{note:"C3",duration:2},{note:"D3",duration:2},{note:"G3",duration:2},{note:"G3",duration:2},{note:"C3",duration:2},{note:"G3",duration:2}],harmony:[{note:"D4",duration:2},{note:"D4",duration:2},{note:"E4",duration:2},{note:"F#4",duration:2},{note:"D4",duration:2},{note:"B3",duration:2},{note:"E4",duration:2},{note:"D4",duration:2}],drumPattern:["kick","hihat","snare","hihat","kick","hihat","snare","hihat"]},ce={name:"forest",bpm:120,melody:[{note:"E4",duration:.5},{note:"G4",duration:.5},{note:"A4",duration:1},{note:"G4",duration:.5},{note:"E4",duration:.5},{note:"D4",duration:1},{note:"E4",duration:.5},{note:"G4",duration:.5},{note:"A4",duration:.5},{note:"B4",duration:.5},{note:"A4",duration:2},{note:"B4",duration:.5},{note:"A4",duration:.5},{note:"G4",duration:1},{note:"E4",duration:.5},{note:"G4",duration:.5},{note:"A4",duration:1},{note:"G4",duration:1},{note:"E4",duration:1},{note:"D4",duration:2}],bass:[{note:"A3",duration:1},{note:"E3",duration:1},{note:"A3",duration:1},{note:"E3",duration:1},{note:"G3",duration:1},{note:"D3",duration:1},{note:"G3",duration:1},{note:"D3",duration:1},{note:"E3",duration:1},{note:"B3",duration:1},{note:"E3",duration:1},{note:"B3",duration:1},{note:"A3",duration:1},{note:"E3",duration:1},{note:"D3",duration:2}],drumPattern:["kick","hihat","snare","hihat","kick","kick","snare","hihat"]},me={name:"graveyard",bpm:85,melody:[{note:"E4",duration:2},{note:"D#4",duration:1},{note:"E4",duration:1},{note:"B3",duration:2},{note:"REST",duration:2},{note:"E4",duration:1},{note:"F4",duration:1},{note:"E4",duration:1},{note:"D#4",duration:1},{note:"E4",duration:4},{note:"G4",duration:1.5},{note:"F4",duration:.5},{note:"E4",duration:1},{note:"D4",duration:1},{note:"C4",duration:2},{note:"B3",duration:2}],bass:[{note:"E3",duration:4},{note:"B3",duration:4},{note:"A3",duration:4},{note:"E3",duration:4},{note:"C3",duration:4},{note:"G3",duration:4}],harmony:[{note:"B3",duration:4},{note:"G#3",duration:4},{note:"C4",duration:4},{note:"B3",duration:4},{note:"E3",duration:4},{note:"B3",duration:4}],drumPattern:["kick","rest","rest","hihat","rest","snare","rest","hihat"]},pe={name:"mountains",bpm:110,melody:[{note:"D4",duration:1},{note:"F4",duration:1},{note:"A4",duration:2},{note:"G4",duration:1},{note:"F4",duration:1},{note:"E4",duration:2},{note:"D4",duration:1},{note:"E4",duration:.5},{note:"F4",duration:.5},{note:"G4",duration:1},{note:"A4",duration:1},{note:"A#4",duration:2},{note:"A4",duration:2},{note:"C5",duration:1},{note:"A#4",duration:1},{note:"A4",duration:1},{note:"G4",duration:1},{note:"F4",duration:2},{note:"D4",duration:2}],bass:[{note:"D3",duration:2},{note:"A3",duration:2},{note:"C3",duration:2},{note:"G3",duration:2},{note:"D3",duration:2},{note:"E3",duration:2},{note:"F3",duration:2},{note:"A3",duration:2},{note:"A#3",duration:2},{note:"A3",duration:2},{note:"D3",duration:4}],drumPattern:["kick","hihat","kick","snare","kick","hihat","kick","snare"]},ge={name:"ice",bpm:95,melody:[{note:"E5",duration:1},{note:"D5",duration:.5},{note:"C5",duration:.5},{note:"B4",duration:1},{note:"REST",duration:1},{note:"A4",duration:1},{note:"B4",duration:1},{note:"C5",duration:2},{note:"E5",duration:1},{note:"D5",duration:.5},{note:"C5",duration:.5},{note:"B4",duration:2},{note:"A4",duration:1.5},{note:"G4",duration:.5},{note:"A4",duration:2}],bass:[{note:"A3",duration:2},{note:"E3",duration:2},{note:"F3",duration:2},{note:"C4",duration:2},{note:"A3",duration:2},{note:"E3",duration:2},{note:"F3",duration:2},{note:"A3",duration:2}],harmony:[{note:"C4",duration:2},{note:"B3",duration:2},{note:"A3",duration:2},{note:"G4",duration:2},{note:"E4",duration:2},{note:"G#3",duration:2},{note:"A3",duration:2},{note:"E4",duration:2}],drumPattern:["kick","rest","hihat","rest","snare","rest","hihat","hihat"]},Te={name:"lair",bpm:140,melody:[{note:"E4",duration:.5},{note:"E4",duration:.5},{note:"F4",duration:.5},{note:"E4",duration:.5},{note:"E4",duration:.5},{note:"F4",duration:.5},{note:"G4",duration:1},{note:"A4",duration:.5},{note:"G4",duration:.5},{note:"F4",duration:.5},{note:"E4",duration:.5},{note:"D4",duration:2},{note:"E4",duration:.5},{note:"E4",duration:.5},{note:"F4",duration:.5},{note:"G4",duration:.5},{note:"A4",duration:1},{note:"B4",duration:1},{note:"C5",duration:1},{note:"B4",duration:.5},{note:"A4",duration:.5},{note:"E4",duration:2}],bass:[{note:"E3",duration:.5},{note:"E3",duration:.5},{note:"E3",duration:.5},{note:"E3",duration:.5},{note:"E3",duration:.5},{note:"E3",duration:.5},{note:"G3",duration:1},{note:"A3",duration:2},{note:"D3",duration:2},{note:"E3",duration:1},{note:"E3",duration:1},{note:"A3",duration:1},{note:"B3",duration:1},{note:"C4",duration:1},{note:"G3",duration:1},{note:"E3",duration:2}],drumPattern:["kick","hihat","kick","hihat","snare","kick","kick","snare"]},ye={name:"citadel",bpm:125,melody:[{note:"G4",duration:1},{note:"A4",duration:.5},{note:"B4",duration:.5},{note:"C5",duration:1},{note:"D5",duration:1},{note:"E5",duration:2},{note:"D5",duration:2},{note:"C5",duration:1},{note:"B4",duration:1},{note:"A4",duration:1},{note:"G4",duration:1},{note:"A4",duration:4},{note:"B4",duration:1},{note:"C5",duration:1},{note:"D5",duration:2},{note:"E5",duration:1},{note:"D5",duration:1},{note:"C5",duration:1},{note:"B4",duration:1},{note:"G4",duration:4}],bass:[{note:"G3",duration:2},{note:"C4",duration:2},{note:"E3",duration:2},{note:"G3",duration:2},{note:"A3",duration:2},{note:"E3",duration:2},{note:"D3",duration:4},{note:"G3",duration:2},{note:"D3",duration:2},{note:"E3",duration:2},{note:"G3",duration:2},{note:"C3",duration:4}],harmony:[{note:"B3",duration:2},{note:"E4",duration:2},{note:"G3",duration:2},{note:"B3",duration:2},{note:"C4",duration:2},{note:"G3",duration:2},{note:"F#3",duration:4},{note:"D4",duration:2},{note:"B3",duration:2},{note:"G3",duration:2},{note:"D4",duration:2},{note:"E3",duration:4}],drumPattern:["kick","hihat","hihat","snare","kick","hihat","hihat","snare"]},be={name:"boss",bpm:155,melody:[{note:"E4",duration:.5},{note:"REST",duration:.25},{note:"E4",duration:.25},{note:"E4",duration:.5},{note:"F4",duration:.5},{note:"G4",duration:.5},{note:"A4",duration:.5},{note:"B4",duration:.5},{note:"C5",duration:.5},{note:"B4",duration:1},{note:"A4",duration:1},{note:"G#4",duration:2},{note:"A4",duration:.5},{note:"B4",duration:.5},{note:"C5",duration:.5},{note:"D5",duration:.5},{note:"E5",duration:1},{note:"D5",duration:.5},{note:"C5",duration:.5},{note:"B4",duration:1},{note:"A4",duration:1},{note:"E4",duration:2}],bass:[{note:"E3",duration:.5},{note:"E3",duration:.5},{note:"E3",duration:.5},{note:"E3",duration:.5},{note:"G3",duration:.5},{note:"G3",duration:.5},{note:"G3",duration:.5},{note:"G3",duration:.5},{note:"A3",duration:1},{note:"A3",duration:1},{note:"E3",duration:2},{note:"A3",duration:.5},{note:"A3",duration:.5},{note:"A3",duration:.5},{note:"A3",duration:.5},{note:"C4",duration:1},{note:"B3",duration:1},{note:"G#3",duration:1},{note:"A3",duration:1},{note:"E3",duration:2}],drumPattern:["kick","kick","snare","kick","kick","snare","kick","snare"]},Se={name:"victory",bpm:130,melody:[{note:"C5",duration:.5},{note:"C5",duration:.5},{note:"C5",duration:.5},{note:"C5",duration:1.5},{note:"G#4",duration:1},{note:"A#4",duration:1},{note:"C5",duration:.5},{note:"A#4",duration:.25},{note:"C5",duration:2.25},{note:"REST",duration:1},{note:"F5",duration:.5},{note:"F5",duration:.5},{note:"F5",duration:.5},{note:"F5",duration:1.5},{note:"D#5",duration:1},{note:"D5",duration:1},{note:"C5",duration:3},{note:"REST",duration:1}],bass:[{note:"C4",duration:2},{note:"C4",duration:2},{note:"G#3",duration:2},{note:"A#3",duration:2},{note:"C4",duration:4},{note:"F3",duration:2},{note:"F3",duration:2},{note:"G3",duration:2},{note:"G3",duration:2},{note:"C4",duration:4}],harmony:[{note:"E4",duration:2},{note:"G4",duration:2},{note:"C4",duration:2},{note:"D4",duration:2},{note:"E4",duration:4},{note:"A4",duration:2},{note:"C5",duration:2},{note:"B4",duration:2},{note:"G4",duration:2},{note:"E4",duration:4}],drumPattern:["kick","snare","kick","snare","kick","snare","kick","snare"]},we={name:"gameover",bpm:60,melody:[{note:"E4",duration:2},{note:"D#4",duration:2},{note:"D4",duration:2},{note:"C#4",duration:2},{note:"C4",duration:4},{note:"REST",duration:4}],bass:[{note:"A3",duration:4},{note:"G3",duration:4},{note:"F3",duration:4},{note:"REST",duration:4}],drumPattern:["kick","rest","rest","rest"]},ke={name:"shop",bpm:105,melody:[{note:"C5",duration:.5},{note:"D5",duration:.5},{note:"E5",duration:1},{note:"G5",duration:.5},{note:"E5",duration:.5},{note:"C5",duration:1},{note:"D5",duration:.5},{note:"E5",duration:.5},{note:"F5",duration:.5},{note:"E5",duration:.5},{note:"D5",duration:2},{note:"E5",duration:.5},{note:"F5",duration:.5},{note:"G5",duration:1},{note:"A5",duration:.5},{note:"G5",duration:.5},{note:"E5",duration:1},{note:"F5",duration:.5},{note:"E5",duration:.5},{note:"D5",duration:.5},{note:"C5",duration:.5},{note:"C5",duration:2}],bass:[{note:"C4",duration:1},{note:"G3",duration:1},{note:"C4",duration:1},{note:"G3",duration:1},{note:"G3",duration:1},{note:"D3",duration:1},{note:"G3",duration:2},{note:"C4",duration:1},{note:"E3",duration:1},{note:"A3",duration:2},{note:"F3",duration:1},{note:"G3",duration:1},{note:"C3",duration:2}],drumPattern:["kick","hihat","snare","hihat","kick","hihat","snare","hihat"]},U=[ce,me,pe,ge,Te,ye,be];class ve{constructor(){this.audioContext=null,this.masterGain=null,this.enabled=!0,this.volume=.25,this.initialized=!1,this.currentTrack=null,this.isPlaying=!1,this.scheduledNotes=[],this.activeOscillators=[],this.activeGainNodes=[],this.loopTimeout=null,this.nextNoteTime=0}init(){if(!this.initialized)try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.audioContext.createGain(),this.masterGain.connect(this.audioContext.destination),this.masterGain.gain.value=this.volume,this.initialized=!0}catch{this.enabled=!1}}resume(){this.audioContext&&this.audioContext.state==="suspended"&&this.audioContext.resume()}getBeatDuration(e){return 60/e}createNoteOscillator(e,t,i,s="square",a=1){if(!this.audioContext||!this.masterGain||e===0)return;const o=this.audioContext.createOscillator(),n=this.audioContext.createGain();o.connect(n),n.connect(this.masterGain),o.type=s,o.frequency.value=e;const l=.02,u=.05,c=.6,m=i*.2,g=this.volume*a*.4;n.gain.setValueAtTime(0,t),n.gain.linearRampToValueAtTime(g,t+l),n.gain.linearRampToValueAtTime(g*c,t+l+u),n.gain.setValueAtTime(g*c,t+i-m),n.gain.linearRampToValueAtTime(.001,t+i),o.start(t),o.stop(t+i+.05),this.activeOscillators.push(o),this.activeGainNodes.push(n),o.onended=()=>{const S=this.activeOscillators.indexOf(o);S>-1&&this.activeOscillators.splice(S,1);const k=this.activeGainNodes.indexOf(n);k>-1&&this.activeGainNodes.splice(k,1)}}createDrumSound(e,t){if(!this.audioContext||!this.masterGain)return;const i=.3;if(e==="kick"){const s=this.audioContext.createOscillator(),a=this.audioContext.createGain();s.connect(a),a.connect(this.masterGain),s.type="sine",s.frequency.setValueAtTime(150,t),s.frequency.exponentialRampToValueAtTime(40,t+.1),a.gain.setValueAtTime(this.volume*i,t),a.gain.exponentialRampToValueAtTime(.001,t+.15),s.start(t),s.stop(t+.15),this.activeOscillators.push(s)}else if(e==="snare"){const s=this.audioContext.createOscillator(),a=this.audioContext.createGain();s.connect(a),a.connect(this.masterGain),s.type="triangle",s.frequency.value=180,a.gain.setValueAtTime(this.volume*i*.5,t),a.gain.exponentialRampToValueAtTime(.001,t+.1),s.start(t),s.stop(t+.1);const o=this.audioContext.createOscillator(),n=this.audioContext.createGain();o.connect(n),n.connect(this.masterGain),o.type="square",o.frequency.value=200+Math.random()*100,n.gain.setValueAtTime(this.volume*i*.3,t),n.gain.exponentialRampToValueAtTime(.001,t+.08),o.start(t),o.stop(t+.08),this.activeOscillators.push(s,o)}else if(e==="hihat"){const s=this.audioContext.createOscillator(),a=this.audioContext.createOscillator(),o=this.audioContext.createGain();s.connect(o),a.connect(o),o.connect(this.masterGain),s.type="square",a.type="square",s.frequency.value=1500,a.frequency.value=1520,o.gain.setValueAtTime(this.volume*i*.15,t),o.gain.exponentialRampToValueAtTime(.001,t+.05),s.start(t),a.start(t),s.stop(t+.05),a.stop(t+.05),this.activeOscillators.push(s,a)}}scheduleTrack(e){if(!this.audioContext||!this.enabled)return 0;this.resume();const t=this.getBeatDuration(e.bpm),i=this.audioContext.currentTime+.1;let s=0,a=i;for(const n of e.melody){const l=N[n.note]||0,u=n.duration*t;l>0&&this.createNoteOscillator(l,a,u*.9,"square",1),a+=u}s=Math.max(s,a-i);let o=i;for(const n of e.bass){const l=N[n.note]||0,u=n.duration*t;l>0&&this.createNoteOscillator(l,o,u*.9,"triangle",.7),o+=u}if(s=Math.max(s,o-i),e.harmony){let n=i;for(const l of e.harmony){const u=N[l.note]||0,c=l.duration*t;u>0&&this.createNoteOscillator(u,n,c*.9,"sawtooth",.3),n+=c}s=Math.max(s,n-i)}if(e.drumPattern){const n=e.drumPattern.length,l=t/2;let u=i;const c=Math.ceil(s/l);for(let m=0;m<c;m++){const g=e.drumPattern[m%n];g!=="rest"&&this.createDrumSound(g,u),u+=l}}return s}play(e){if(!this.enabled)return;this.init(),this.stop();let t;switch(e){case"menu":t=K;break;case"shop":t=ke;break;case"victory":t=Se;break;case"gameover":t=we;break;default:{const i=parseInt(e,10);!isNaN(i)&&i>=0&&i<U.length?t=U[i]:t=K;break}}this.currentTrack=t,this.isPlaying=!0,this.loopTrack()}loopTrack(){if(!this.isPlaying||!this.currentTrack)return;const e=this.scheduleTrack(this.currentTrack);this.loopTimeout=setTimeout(()=>{this.isPlaying&&this.loopTrack()},e*1e3-100)}playLevel(e){this.play(e.toString())}stop(){this.isPlaying=!1,this.currentTrack=null,this.loopTimeout&&(clearTimeout(this.loopTimeout),this.loopTimeout=null),this.activeOscillators.forEach(e=>{try{e.stop()}catch{}}),this.activeOscillators=[],this.activeGainNodes=[]}pause(){if(!this.masterGain||!this.audioContext)return;this.isPlaying=!1,this.loopTimeout&&(clearTimeout(this.loopTimeout),this.loopTimeout=null);const e=this.audioContext.currentTime;this.masterGain.gain.setValueAtTime(this.volume,e),this.masterGain.gain.linearRampToValueAtTime(0,e+.3)}unpause(){if(!this.masterGain||!this.audioContext)return;const e=this.audioContext.currentTime;this.masterGain.gain.setValueAtTime(0,e),this.masterGain.gain.linearRampToValueAtTime(this.volume,e+.3),this.currentTrack&&(this.isPlaying=!0,this.loopTrack())}toggle(){return this.enabled=!this.enabled,this.enabled||this.stop(),this.enabled}setVolume(e){this.volume=Math.max(0,Math.min(1,e)),this.masterGain&&this.audioContext&&this.masterGain.gain.setValueAtTime(this.volume,this.audioContext.currentTime)}getVolume(){return this.volume}}const M=new ve,$=[{id:"power_strike",name:"Power Strike",description:"+15% damage",branch:"combat",tier:1,modifier:{key:"damageMult",value:.15},icon:""},{id:"critical_edge",name:"Critical Edge",description:"+10% crit, +0.25x crit damage",branch:"combat",tier:2,prerequisite:"power_strike",modifier:{key:"critChanceBonus",value:.1},icon:""},{id:"berserker",name:"Berserker Rage",description:"+40% damage when below 30% HP",branch:"combat",tier:3,prerequisite:"critical_edge",modifier:{key:"berserkerMode",value:!0},icon:""},{id:"tough_skin",name:"Tough Skin",description:"+20% max HP",branch:"defense",tier:1,modifier:{key:"healthMult",value:.2},icon:""},{id:"iron_will",name:"Iron Will",description:"+30% defense",branch:"defense",tier:2,prerequisite:"tough_skin",modifier:{key:"defenseMult",value:.3},icon:""},{id:"second_wind",name:"Second Wind",description:"Auto-heal 25% HP once per level when near death",branch:"defense",tier:3,prerequisite:"iron_will",modifier:{key:"secondWind",value:!0},icon:""},{id:"swift_feet",name:"Swift Feet",description:"+15% move speed (helps on ice!)",branch:"utility",tier:1,modifier:{key:"speedMult",value:.15},icon:""},{id:"double_jump",name:"Double Jump",description:"Jump again in mid-air",branch:"utility",tier:2,prerequisite:"swift_feet",modifier:{key:"doubleJump",value:!0},icon:""},{id:"gold_rush",name:"Gold Rush",description:"+75% gold from enemies",branch:"utility",tier:3,prerequisite:"double_jump",modifier:{key:"goldMult",value:.75},icon:""}];function J(f){return $.filter(e=>e.branch===f).sort((e,t)=>e.tier-t.tier)}function _(f){return $.find(e=>e.id===f)}class Ce{constructor(){this.state={unlockedSkills:new Set}}canUnlock(e,t){return this.state.unlockedSkills.has(e.id)?{allowed:!1,reason:"Already unlocked"}:t<e.tier?{allowed:!1,reason:`Need ${e.tier} skill points`}:e.prerequisite&&!this.state.unlockedSkills.has(e.prerequisite)?{allowed:!1,reason:`Requires: ${_(e.prerequisite)?.name}`}:{allowed:!0}}unlock(e,t){return this.canUnlock(e,t.skillPoints).allowed?(t.skillPoints-=e.tier,this.state.unlockedSkills.add(e.id),t.applySkillModifier(e.modifier.key,e.modifier.value),!0):!1}isUnlocked(e){return this.state.unlockedSkills.has(e)}getUnlockedCount(){return this.state.unlockedSkills.size}serialize(){return Array.from(this.state.unlockedSkills)}deserialize(e,t){this.state.unlockedSkills=new Set(e),e.forEach(i=>{const s=_(i);s&&t.applySkillModifier(s.modifier.key,s.modifier.value)})}reset(){this.state.unlockedSkills=new Set}}const z=["combat","defense","utility"],Me={combat:{bg:"#4a1a1a",accent:"#e74c3c",name:" COMBAT"},defense:{bg:"#1a2a4a",accent:"#3498db",name:" DEFENSE"},utility:{bg:"#1a4a2a",accent:"#2ecc71",name:" UTILITY"}};class Pe{constructor(){this.visible=!1,this.selectedBranch=0,this.selectedTier=0,this.message="",this.messageTimer=0}toggle(){this.visible=!this.visible,this.visible&&y.menuSelect()}isOpen(){return this.visible}showMessage(e){this.message=e,this.messageTimer=90}update(e,t,i){if(this.visible){if(this.messageTimer>0&&this.messageTimer--,e.isJustPressed("k")||e.isJustPressed("KeyK")||e.isCancel()){this.toggle();return}if(e.isMenuLeft()&&(this.selectedBranch=(this.selectedBranch-1+3)%3,this.selectedTier=Math.min(this.selectedTier,2),y.menuSelect()),e.isMenuRight()&&(this.selectedBranch=(this.selectedBranch+1)%3,this.selectedTier=Math.min(this.selectedTier,2),y.menuSelect()),e.isMenuUp()&&(this.selectedTier=Math.max(0,this.selectedTier-1),y.menuSelect()),e.isMenuDown()&&(this.selectedTier=Math.min(2,this.selectedTier+1),y.menuSelect()),e.isConfirm()){const s=z[this.selectedBranch],o=J(s)[this.selectedTier];if(o){const n=t.canUnlock(o,i.skillPoints);n.allowed?(t.unlock(o,i),this.showMessage(`Unlocked: ${o.name}!`),y.purchase()):(this.showMessage(n.reason||"Cannot unlock"),y.error())}}}}draw(e,t,i){if(!this.visible)return;e.fillStyle="rgba(0, 0, 0, 0.9)",e.fillRect(0,0,r,d),e.fillStyle="#ffd700",e.font="24px monospace",e.textAlign="center",e.fillText(" SKILL TREE ",r/2,40),e.fillStyle="#fff",e.font="14px monospace",e.fillText(`Skill Points: ${i.skillPoints}`,r/2,65),e.fillStyle="#888",e.font="10px monospace",e.fillText("(Earn 1 point each time you level up)",r/2,80);const s=240,a=(r-s*3-20)/2;z.forEach((o,n)=>{const l=a+n*(s+10),u=n===this.selectedBranch,c=Me[o];e.fillStyle=u?c.bg:"#1a1a1a",e.fillRect(l,95,s,340),e.strokeStyle=u?c.accent:"#333",e.lineWidth=u?3:1,e.strokeRect(l,95,s,340),e.fillStyle=c.accent,e.font="12px monospace",e.textAlign="center",e.fillText(c.name,l+s/2,115);const m=J(o);m.forEach((g,S)=>{const k=135+S*100,E=u&&S===this.selectedTier,D=t.isUnlocked(g.id),v=t.canUnlock(g,i.skillPoints).allowed;this.drawSkillNode(e,l+20,k,s-40,g,E,D,v,c.accent),S<m.length-1&&(e.strokeStyle=D?c.accent:"#444",e.lineWidth=2,e.beginPath(),e.moveTo(l+s/2,k+75),e.lineTo(l+s/2,k+100),e.stroke())})}),this.messageTimer>0&&(e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(r/2-150,d/2-20,300,40),e.fillStyle="#2ecc71",e.font="14px monospace",e.textAlign="center",e.fillText(this.message,r/2,d/2+5)),e.fillStyle="#666",e.font="10px monospace",e.textAlign="center",e.fillText(" Branch |  Skill | ENTER Unlock | K/ESC Close",r/2,d-15)}drawSkillNode(e,t,i,s,a,o,n,l,u){n?e.fillStyle=u:o?e.fillStyle=l?"#3a3a3a":"#2a2a2a":e.fillStyle="#222",e.fillRect(t,i,s,80),o&&!n&&(e.strokeStyle=l?"#ffd700":"#666",e.lineWidth=2,e.strokeRect(t,i,s,80)),e.font="24px monospace",e.textAlign="left",e.fillText(a.icon,t+10,i+35),e.fillStyle=n?"#fff":l?"#ddd":"#666",e.font="12px monospace",e.fillText(a.name,t+45,i+25),e.fillStyle=n?"#ccc":"#888",e.font="10px monospace",e.fillText(a.description,t+45,i+42),e.fillStyle=n?"#2ecc71":l?"#ffd700":"#e74c3c",e.font="10px monospace",e.textAlign="right",e.fillText(n?" UNLOCKED":`Cost: ${a.tier} pt${a.tier>1?"s":""}`,t+s-10,i+70),!n&&!l&&(e.font="16px monospace",e.textAlign="center",e.fillStyle="#666",e.fillText("",t+s-25,i+35))}}class Ae{constructor(){this.canvas=document.getElementById("game"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=r,this.canvas.height=d,this.state=T.MENU,this.coopMode=!1,this.players=[],this.levelManager=new re,this.shop=new ue,this.ui=new fe,this.skillTree=new Ce,this.skillTreeUI=new Pe,this.previewStats=new X,this.particles=[],this.damageNumbers=[],this.groundY=420,this.paused=!1,this.lastTime=0,this.gameLoop=this.gameLoop.bind(this),requestAnimationFrame(this.gameLoop)}initGame(e){this.coopMode=e,this.players=[];const t=new V(1,100,this.groundY-60);if(t.calculateStats(),this.players.push(t),e){const a=new V(2,50,this.groundY-60);a.calculateStats(),this.players.push(a)}const i=new URLSearchParams(window.location.search),s=parseInt(i.get("level")||"0",10);this.levelManager.startLevel(s),this.particles=[],this.damageNumbers=[],this.state=T.PLAYING,M.playLevel(this.levelManager.currentLevelIndex)}gameLoop(e){this.lastTime=e,b.update(),this.update(),this.draw(),requestAnimationFrame(this.gameLoop)}update(){switch(this.state){case T.MENU:if((b.isJustPressed("k")||b.isJustPressed("KeyK"))&&this.skillTreeUI.toggle(),this.skillTreeUI.isOpen()){this.skillTreeUI.update(b,this.skillTree,this.previewStats);return}b.isMenuUp()&&(this.ui.menuSelection=Math.max(0,this.ui.menuSelection-1),y.menuSelect()),b.isMenuDown()&&(this.ui.menuSelection=Math.min(this.ui.menuOptions.length-1,this.ui.menuSelection+1),y.menuSelect()),b.isConfirm()&&(y.menuConfirm(),y.init(),M.init(),this.initGame(this.ui.menuSelection===1));break;case T.PLAYING:if(this.skillTreeUI.isOpen()){this.skillTreeUI.update(b,this.skillTree,this.players[0].stats);return}if(b.isJustPressed("k")||b.isJustPressed("KeyK")){this.skillTreeUI.toggle();return}if(b.isCancel()&&(this.paused=!this.paused),this.paused){(b.isJustPressed("b")||b.isJustPressed("KeyB"))&&(this.state=T.SHOP,this.paused=!1,M.play("shop"));return}this.updateGame();break;case T.SHOP:{this.shop.update(b,this.players[0])||(this.state=T.PLAYING,M.playLevel(this.levelManager.currentLevelIndex));break}}}updateGame(){const e=this.levelManager.currentLevel.mechanics;this.players.forEach((i,s)=>{if(i.health<=0)return;const a=s===0?b.getPlayer1Input():b.getPlayer2Input();i.update(a,this.groundY,e)}),this.levelManager.update(this.players),this.players.forEach(i=>{if(i.health<=0)return;const s=i.getAttackHitbox();s&&this.levelManager.enemies.forEach(a=>{if(!a.dead&&B(s,a.getHitbox())){let o=i.getEffectiveDamage();const n=Math.random()<i.critChance,l=i.isBerserkerActive();n?(o*=i.critMultiplier,y.criticalHit()):y.hit();const u=a.takeDamage(o,i.facing);let c="#fff";n?c="#ffd700":l&&(c="#ff4444"),this.damageNumbers.push(new I(a.x+a.width/2,a.y,o,c));for(let m=0;m<5;m++)this.particles.push(new F(a.x+a.width/2,a.y+a.height/2,L(-3,3),L(-4,-1),n?"#ffd700":"#e74c3c"));if(u){i.addExp(a.exp);let m=a.gold;i.stats.skillModifiers.goldMult>0&&(m=Math.floor(m*(1+i.stats.skillModifiers.goldMult))),i.addGold(m),y.enemyDeath(),y.coin();for(let g=0;g<15;g++)this.particles.push(new F(a.x+a.width/2,a.y+a.height/2,L(-5,5),L(-6,-2),a.color,40));this.damageNumbers.push(new I(a.x+a.width/2,a.y-20,"+"+m+"G","#ffd700"))}}})}),this.levelManager.enemies.forEach(i=>{i.dead||this.players.forEach(s=>{if(!(s.health<=0||s.invincible)&&B(s,i.getHitbox())){const a=s.x<i.x?-1:1,o=s.takeDamage(i.damage,a);y.playerHurt(),this.damageNumbers.push(new I(s.x+s.width/2,s.y,o,"#e74c3c"))}})}),this.levelManager.projectiles.forEach(i=>{this.players.forEach(s=>{if(!(s.health<=0||s.invincible)&&B(s,i.getHitbox())){const a=i.vx>0?1:-1,o=s.takeDamage(i.damage,a);y.playerHurt(),this.damageNumbers.push(new I(s.x+s.width/2,s.y,o,"#e74c3c")),i.life=0}})}),this.particles=this.particles.filter(i=>i.update()),this.damageNumbers=this.damageNumbers.filter(i=>i.update()),this.levelManager.levelComplete&&(this.levelManager.isLastLevel?(this.state=T.VICTORY,M.play("victory")):this.state=T.LEVEL_COMPLETE),this.players.every(i=>i.health<=0)&&(this.state=T.GAME_OVER,M.play("gameover"))}draw(){switch(this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,r,d),this.state){case T.MENU:this.ui.drawMenu(this.ctx),this.skillTreeUI.draw(this.ctx,this.skillTree,this.previewStats);break;case T.PLAYING:case T.SHOP:case T.LEVEL_COMPLETE:if(this.drawGame(),this.state===T.SHOP)this.shop.draw(this.ctx,this.players[0],r,d);else if(this.state===T.LEVEL_COMPLETE){const e=this.ui.drawLevelComplete(this.ctx,this.levelManager,b);e==="continue"?(this.levelManager.nextLevel(),this.levelManager.startLevel(this.levelManager.currentLevelIndex),this.players.forEach(t=>t.reset()),this.state=T.PLAYING,M.playLevel(this.levelManager.currentLevelIndex)):e==="shop"?(this.state=T.SHOP,M.play("shop")):e==="skillTree"&&this.skillTreeUI.toggle()}this.paused&&this.state===T.PLAYING&&this.ui.drawPauseOverlay(this.ctx),this.skillTreeUI.draw(this.ctx,this.skillTree,this.players[0].stats);break;case T.GAME_OVER:this.drawGame(),this.ui.drawGameOver(this.ctx,b)&&(this.levelManager.startLevel(this.levelManager.currentLevelIndex),this.players.forEach(e=>{e.reset(),e.x=e.playerNum===1?100:50,e.y=this.groundY-60}),this.state=T.PLAYING,M.playLevel(this.levelManager.currentLevelIndex));break;case T.VICTORY:this.drawGame(),this.ui.drawVictory(this.ctx,b)&&(this.state=T.MENU,this.ui.menuSelection=0,M.play("menu"));break}}drawGame(){this.levelManager.drawBackground(this.ctx,r,d),this.levelManager.draw(this.ctx),this.players.forEach(e=>{e.health>0&&e.draw(this.ctx)}),this.particles.forEach(e=>e.draw(this.ctx)),this.damageNumbers.forEach(e=>e.draw(this.ctx)),this.ui.drawHUD(this.ctx,this.players,this.levelManager)}}document.addEventListener("DOMContentLoaded",()=>{new Ae;const f=()=>{M.init(),M.play("menu"),document.removeEventListener("click",f),document.removeEventListener("keydown",f)};document.addEventListener("click",f,{once:!0}),document.addEventListener("keydown",f,{once:!0})});
